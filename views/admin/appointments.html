<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin — Appointments | Elite Travel & Tour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Admin appointments management for Elite Travel & Tour — review, filter, notify and manage bookings for consultations, visa advice, and Work & Pay sessions."/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="/src/js/supabase.js"></script>
  <style>
    :root{
      --brand:#0077cc;
      --brand-600:#0060a3;
      --brand-700:#004b80;
      --dark:#020617;
      --light:#fff;
      --muted:#64748b;
      --bg:#020617;
      --gray-100:#f3f4f6;
      --gray-200:#e5e7eb;
      --gray-300:#d1d5db;
      --gray-800:#1f2937;
      --shadow:0 24px 60px rgba(15,23,42,.7);
      --radius:14px;
      --success:#16a34a;
      --danger:#dc2626;
      --warning:#f59e0b;
      --info:#0ea5e9;
      --chip-bg:#0b1220;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(circle at top, rgba(59,130,246,.26) 0, transparent 45%),
        #020617;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
      display:flex;
      flex-direction:column;
    }

    .layout{
      flex:1;
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      min-height:0;
    }
    @media(max-width:900px){
      .layout{ grid-template-columns:1fr; }
    }

    /* Sidebar */
    .sidebar{
      border-right:1px solid rgba(31,41,55,.9);
      background:radial-gradient(circle at top left, #020c28 0, #020617 60%);
      padding:.8rem .7rem;
      display:flex;
      flex-direction:column;
      gap:.75rem;
      box-shadow:0 0 0 1px rgba(15,23,42,.9);
    }
    .sidebar-header{
      display:flex; align-items:center; justify-content:space-between; gap:.5rem;
      padding:.2rem .1rem .4rem;
    }
    .sidebar-header .logo{
      display:flex; align-items:center; gap:.4rem;
      font-weight:800; color:#f9fafb; text-decoration:none; font-size:.98rem;
    }
    .sidebar-header .logo i{ color:#38bdf8; }
    .side-toggle{
      display:none; border:none; background:rgba(15,23,42,.8);
      color:#cbd5f5; padding:.35rem .5rem; border-radius:999px; cursor:pointer;
    }
    .side-toggle i{ font-size:.9rem; }
    @media(max-width:900px){
      .sidebar{
        position:fixed; inset:0 auto 0 0; width:260px;
        transform:translateX(-100%);
        transition:transform .2s ease-out;
        z-index:60;
      }
      .sidebar.open{ transform:translateX(0); }
      .side-toggle{ display:inline-flex; }
    }

    .nav-section{ margin-top:.4rem; }
    .nav-label{
      font-size:.75rem; text-transform:uppercase; letter-spacing:.08em;
      color:#64748b; margin:.4rem 0 .2rem; padding:0 .2rem;
    }
    .nav-list{ list-style:none; padding:0; margin:0; }
    .nav-link{
      display:flex; align-items:center; gap:.5rem;
      padding:.45rem .55rem; border-radius:10px;
      color:#cbd5f5; text-decoration:none; font-size:.9rem;
      border:1px solid transparent; cursor:pointer;
      background:transparent;
    }
    .nav-link i{ font-size:.9rem; }
    .nav-link:hover{
      background:rgba(30,64,175,.45);
      border-color:rgba(37,99,235,.6);
    }
    .nav-link.active{
      background:rgba(37,99,235,.9);
      border-color:rgba(37,99,235,1);
      color:#e5e7eb;
      box-shadow:0 10px 28px rgba(37,99,235,.6);
    }

    .sidebar-footer{
      margin-top:auto; padding-top:.5rem;
      border-top:1px solid rgba(30,64,175,.7);
      font-size:.8rem; color:#64748b;
    }
    .sidebar-footer .chip{
      display:inline-flex; align-items:center; gap:.3rem;
      padding:.22rem .55rem; border-radius:999px;
      background:#020617; border:1px solid rgba(37,99,235,.7);
      margin-top:.35rem; font-size:.78rem;
    }
    .sidebar-footer .chip i{ color:#22c55e; }

    /* Main */
    .main{
      display:flex; flex-direction:column;
      min-height:0;
    }
    .main-header{
      padding:.55rem 1rem;
      border-bottom:1px solid rgba(31,41,55,.9);
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      background:rgba(15,23,42,.96);
      box-shadow:0 16px 50px rgba(15,23,42,.8);
      position:sticky; top:0; z-index:40;
    }
    .breadcrumbs{
      display:flex; align-items:center; gap:.35rem; font-size:.85rem; color:#9ca3af;
    }
    .breadcrumbs span.current{ color:#e5e7eb; font-weight:500; }
    .main-header-right{ display:flex; align-items:center; gap:.5rem; }
    .pill-soft{
      display:inline-flex; align-items:center; gap:.3rem;
      padding:.18rem .55rem; border-radius:999px;
      background:#020617; border:1px solid rgba(148,163,184,.7);
      font-size:.78rem; color:#e5e7eb;
    }

    .main-body{
      padding:1rem;
      overflow:auto;
    }

    .card{
      background:#020617;
      border-radius:var(--radius);
      border:1px solid rgba(31,41,55,.9);
      box-shadow:var(--shadow);
      padding:1rem;
    }
    .section-title{ font-size:1.15rem; margin-bottom:.4rem; }
    .muted{ color:var(--muted); }

    .toolbar{ display:flex; gap:.5rem; flex-wrap:wrap; margin:.6rem 0; }

    .btn{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.5rem .9rem; border-radius:999px;
      border:none; cursor:pointer;
      font-weight:600; font-size:.9rem;
      text-decoration:none; transition:all .15s ease-out;
    }
    .btn.brand{ background:var(--brand); color:#f9fafb; box-shadow:0 10px 26px rgba(37,99,235,.4); }
    .btn.brand:hover{ background:var(--brand-600); transform:translateY(-1px); box-shadow:0 16px 40px rgba(37,99,235,.55); }
    .btn.outline{
      background:transparent; color:#e5e7eb;
      border-radius:999px; border:1px solid rgba(148,163,184,.7);
    }
    .btn.outline:hover{ border-color:#38bdf8; color:#38bdf8; background:rgba(15,23,42,.7); }
    .btn-sm{ padding:.25rem .55rem; font-size:.8rem; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .input,.textarea,select{
      width:100%; box-sizing:border-box;
      padding:.55rem .7rem; border-radius:10px;
      border:1px solid rgba(148,163,184,.7); background:#020617;
      font-size:.9rem; color:#e5e7eb;
      transition:border-color .12s, box-shadow .12s, background .12s;
    }
    .input::placeholder{ color:#6b7280; }
    .input:focus,.textarea:focus,select:focus{
      outline:none; border-color:#38bdf8;
      box-shadow:0 0 0 2px rgba(56,189,248,.35);
      background:#020617;
    }
    .textarea{ min-height:80px; resize:vertical; }

    .table{
      width:100%; border-collapse:collapse; font-size:.85rem;
    }
    .table th,.table td{
      padding:.55rem .45rem; border-bottom:1px solid rgba(31,41,55,.9);
    }
    .table th{
      text-align:left; font-weight:600; color:#9ca3af; font-size:.8rem;
    }
    .table tbody tr:hover{ background:#020c28; }

    .badge{
      display:inline-flex; align-items:center; gap:.3rem;
      padding:.1rem .5rem; border-radius:999px;
      font-size:.75rem;
      background:#020c28; border:1px solid rgba(148,163,184,.7); color:#e5e7eb;
    }
    .badge.success{ background:rgba(22,163,74,.2); border-color:rgba(22,163,74,.7); color:#bbf7d0; }
    .badge.warning{ background:rgba(234,179,8,.18); border-color:rgba(234,179,8,.7); color:#facc15; }
    .badge.info{ background:rgba(59,130,246,.20); border-color:rgba(59,130,246,.7); color:#bfdbfe; }
    .badge.danger{ background:rgba(220,38,38,.2); border-color:rgba(220,38,38,.7); color:#fecaca; }

    .chip-row{ display:flex; flex-wrap:wrap; gap:.3rem; }
    .chip{
      padding:.18rem .5rem; border-radius:999px;
      font-size:.78rem;
      background:var(--chip-bg);
      border:1px solid rgba(55,65,81,.9);
      color:#e5e7eb;
    }

    .toast{
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:#020617; color:#e5e7eb; padding:.75rem 1rem; border-radius:999px;
      box-shadow:0 16px 40px rgba(15,23,42,.85); z-index:2000; display:none; max-width:90vw;
    }
    .toast.show{ display:flex; align-items:center; gap:.6rem; }
    .toast i{ color:#38bdf8; }

    .modal{
      display:none; position:fixed; inset:0;
      background:rgba(15,23,42,.75);
      align-items:center; justify-content:center; z-index:1000;
    }
    .modal .card{
      max-width:560px; width:92%;
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.8);
      box-shadow:var(--shadow);
      background:#020617; color:#e5e7eb;
    }
    .modal .body{ padding:1rem; }

    .grid-2{ display:grid; gap:.7rem; grid-template-columns:repeat(2,minmax(0,1fr)); }
    @media(max-width:900px){ .grid-2{ grid-template-columns:1fr; } }

    .pill-label{
      font-size:.8rem;
      padding:.14rem .45rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:#020617;
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:.3rem;
    }

    .status-dot{
      width:8px; height:8px; border-radius:50%;
      display:inline-block;
    }
    .status-dot.pending{ background:#facc15; }
    .status-dot.confirmed{ background:#22c55e; }
    .status-dot.completed{ background:#38bdf8; }
    .status-dot.cancelled{ background:#ef4444; }

    .small-text{ font-size:.8rem; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/views/admin/index.html" class="logo">
          <i class="fa-solid fa-compass"></i> <span>Elite Admin</span>
        </a>
        <button class="side-toggle" id="sideToggle"><i class="fa fa-xmark"></i></button>
      </div>

      <div class="nav-section">
        <div class="nav-label">Overview</div>
        <ul class="nav-list">
          <li><a class="nav-link" href="/views/admin/index.html"><i class="fa fa-gauge-high"></i> Dashboard</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-label">Jobs & Services</div>
        <ul class="nav-list">
          <li><a class="nav-link" href="/views/admin/jobs.html"><i class="fa fa-briefcase"></i> Jobs</a></li>
          <li><a class="nav-link" href="/views/admin/services.html"><i class="fa fa-suitcase"></i> Services</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-label">Users & Activity</div>
        <ul class="nav-list">
          <li><a class="nav-link" href="/views/admin/users.html"><i class="fa fa-users"></i> Users</a></li>
          <li><a class="nav-link" href="/views/admin/tracking.html"><i class="fa fa-location-crosshairs"></i> Tracking</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-label">Transactions</div>
        <ul class="nav-list">
          <li><button class="nav-link active"><i class="fa fa-calendar"></i> Appointments</button></li>
          <li><a class="nav-link" href="/views/admin/payments.html"><i class="fa fa-credit-card"></i> Payments</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-label">Content</div>
        <ul class="nav-list">
          <li><a class="nav-link" href="/views/admin/notifications.html"><i class="fa fa-bell"></i> Notifications</a></li>
          <li><a class="nav-link" href="/views/admin/testimonials.html"><i class="fa fa-star"></i> Testimonials</a></li>
        </ul>
      </div>

      <div class="sidebar-footer">
        <div>Session</div>
        <div class="chip">
          <i class="fa fa-user-shield"></i> <span id="adminEmail">—</span>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="main-header">
        <div class="breadcrumbs">
          <button class="side-toggle" id="openSideOnMobile"><i class="fa fa-bars"></i></button>
          <span>Admin</span> <span>/</span> <span class="current">Appointments</span>
        </div>
        <div class="main-header-right">
          <span class="pill-soft"><i class="fa fa-shield-halved"></i> Admin</span>
          <button class="btn outline" id="adminLogout"><i class="fa fa-right-from-bracket"></i> Logout</button>
        </div>
      </header>

      <section class="main-body">
        <!-- Filters / overview -->
        <article class="card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:.75rem;flex-wrap:wrap;">
            <div>
              <h2 class="section-title">Appointments</h2>
              <p class="muted">
                Review and manage bookings for consultations, visa advice, Work & Pay sessions, and other meetings.
                Setting status to <strong>confirmed</strong> marks a consultation as accepted and prepares a
                <strong>GHS 150 consultation fee</strong> payment for the user.
              </p>
            </div>
            <div class="chip-row">
              <span class="chip"><i class="fa fa-database"></i> appointments</span>
              <span class="chip"><i class="fa fa-credit-card"></i> GHS 150 fee</span>
              <span class="chip"><i class="fa fa-bell"></i> notifications</span>
            </div>
          </div>

          <div class="toolbar" style="margin-top:.8rem;">
            <span class="pill-label"><i class="fa fa-filter"></i> Filters</span>
          </div>

          <div class="grid-2" style="margin-top:.4rem;gap:.7rem;">
            <div class="grid-2">
              <div>
                <label class="muted" style="font-size:.85rem;">Status</label>
                <select id="apptStatusFilter" class="input">
                  <option value="">All</option>
                  <option value="pending">Pending</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
              <div>
                <label class="muted" style="font-size:.85rem;">Type</label>
                <select id="apptTypeFilter" class="input">
                  <option value="">All</option>
                  <option value="consultation">Consultation</option>
                  <option value="visa">Visa</option>
                  <option value="work">Work & Pay</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="grid-2">
              <div>
                <label class="muted" style="font-size:.85rem;">From date</label>
                <input id="apptFromDate" type="date" class="input">
              </div>
              <div>
                <label class="muted" style="font-size:.85rem;">To date</label>
                <input id="apptToDate" type="date" class="input">
              </div>
            </div>
          </div>

          <div class="toolbar" style="margin-top:.6rem;justify-content:space-between;">
            <div class="toolbar" style="margin:0;">
              <input id="apptSearch" class="input" placeholder="Search by name, email, notes, job" style="max-width:280px;">
            </div>
            <div class="toolbar" style="margin:0;">
              <button class="btn outline btn-sm" id="apptTodayBtn"><i class="fa fa-calendar-day"></i> Today</button>
              <button class="btn outline btn-sm" id="apptUpcomingBtn"><i class="fa fa-forward"></i> Upcoming</button>
              <button class="btn outline btn-sm" id="apptRefreshBtn"><i class="fa fa-rotate"></i> Refresh</button>
            </div>
          </div>
        </article>

        <!-- Table -->
        <article class="card" style="margin-top:1rem;">
          <h3 class="section-title">Appointments list</h3>
          <table class="table" id="apptTable">
            <thead>
              <tr>
                <th>Client</th>
                <th>Email</th>
                <th>Type</th>
                <th>Status</th>
                <th>Date & time</th>
                <th>Job / notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7" class="muted">Loading appointments...</td></tr>
            </tbody>
          </table>

          <p id="apptStatusText" class="muted" style="margin-top:.5rem;"></p>
        </article>
      </section>
    </main>
  </div>

  <!-- Modal: update appointment + notification -->
  <div class="modal" id="apptModal">
    <section class="card">
      <div class="body">
        <h3 id="apptModalTitle">Update appointment</h3>
        <p id="apptMeta" class="muted small-text"></p>

        <form id="apptForm" class="grid-2" style="margin-top:.4rem;gap:.7rem;">
          <div>
            <label class="muted" style="font-size:.85rem;">Client name</label>
            <input id="apptName" class="input" disabled>
          </div>
          <div>
            <label class="muted" style="font-size:.85rem;">Email</label>
            <input id="apptEmail" class="input" disabled>
          </div>
          <div>
            <label class="muted" style="font-size:.85rem;">Type</label>
            <select id="apptType" class="input">
              <option value="consultation">Consultation</option>
              <option value="visa">Visa</option>
              <option value="work">Work & Pay</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="muted" style="font-size:.85rem;">Status</label>
            <select id="apptStatus" class="input">
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed (accepted)</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div>
            <label class="muted" style="font-size:.85rem;">Date</label>
            <input id="apptDate" type="date" class="input">
          </div>
          <div>
            <label class="muted" style="font-size:.85rem;">Time</label>
            <input id="apptTime" type="time" class="input">
          </div>
          <div style="grid-column:1/-1;">
            <label class="muted" style="font-size:.85rem;">Admin notes (internal)</label>
            <textarea id="apptAdminNotes" class="textarea" placeholder="Internal admin notes about this appointment."></textarea>
          </div>

          <div style="grid-column:1/-1;">
            <label class="muted" style="font-size:.85rem;">Send notification to user</label>
            <textarea id="apptNotifMessage" class="textarea" placeholder="Optional message for the user. Leave empty if you do not want to send a notification."></textarea>
            <p class="muted small-text" style="margin-top:.25rem;">
              When you set status to <strong>confirmed</strong>, you can notify the user their consultation is accepted and they should pay the GHS 150 consultation fee.
            </p>
          </div>
        </form>

        <p id="apptFormStatus" class="muted small-text" style="margin-top:.5rem;"></p>
        <div class="toolbar" style="margin-top:.6rem;justify-content:space-between;align-items:flex-start;gap:.5rem;">
          <div class="muted small-text" id="apptFooterMeta"></div>
          <div class="toolbar" style="margin:0;">
            <button class="btn outline btn-sm" id="apptModalCancel"><i class="fa fa-xmark"></i> Cancel</button>
            <button class="btn brand btn-sm" id="apptModalSave"><i class="fa fa-save"></i> Save & notify</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"><i class="fa fa-info-circle"></i><span id="toastText"></span></div>

  <script type="module">
    import { sb } from '/src/js/supabase.js';

    /* Toast */
    const toast=document.getElementById('toast');
    const toastText=document.getElementById('toastText');
    function showToast(msg,ms=2500){
      if(!toast || !toastText) return;
      toastText.textContent=msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),ms);
    }

    /* Sidebar mobile toggle */
    const sidebar=document.getElementById('sidebar');
    const sideToggle=document.getElementById('sideToggle');
    const openSideOnMobile=document.getElementById('openSideOnMobile');
    sideToggle?.addEventListener('click',()=> sidebar.classList.remove('open'));
    openSideOnMobile?.addEventListener('click',()=> sidebar.classList.add('open'));

    /* Auth guard */
    const adminEmailSpan=document.getElementById('adminEmail');
    const adminLogout=document.getElementById('adminLogout');

    const { data: sessionData } = await sb.auth.getSession();
    const session=sessionData.session;
    const admin=session?.user;

    if(!admin){
      showToast('Admin session required.');
      window.location.href='/views/pages/login.html';
      throw new Error('No admin');
    }else{
      adminEmailSpan.textContent=admin.email;
      const { data: profile, error: profErr } = await sb
        .from('users')
        .select('role')
        .eq('id', admin.id)
        .maybeSingle();
      if (profErr || !profile || (profile.role!=='admin' && profile.role!=='superadmin')) {
        showToast('Admin role required.');
        window.location.href='/views/pages/login.html';
        throw new Error('Not admin');
      }
    }

    adminLogout?.addEventListener('click',async()=>{
      await sb.auth.signOut();
      window.location.href='/views/pages/login.html';
    });

    /* Elements */
    const apptStatusFilter=document.getElementById('apptStatusFilter');
    const apptTypeFilter=document.getElementById('apptTypeFilter');
    const apptFromDate=document.getElementById('apptFromDate');
    const apptToDate=document.getElementById('apptToDate');
    const apptSearch=document.getElementById('apptSearch');
    const apptTodayBtn=document.getElementById('apptTodayBtn');
    const apptUpcomingBtn=document.getElementById('apptUpcomingBtn');
    const apptRefreshBtn=document.getElementById('apptRefreshBtn');
    const apptTableBody=document.querySelector('#apptTable tbody');
    const apptStatusText=document.getElementById('apptStatusText');

    const apptModal=document.getElementById('apptModal');
    const apptModalTitle=document.getElementById('apptModalTitle');
    const apptModalCancel=document.getElementById('apptModalCancel');
    const apptModalSave=document.getElementById('apptModalSave');
    const apptFormStatus=document.getElementById('apptFormStatus');
    const apptMeta=document.getElementById('apptMeta');
    const apptFooterMeta=document.getElementById('apptFooterMeta');

    const apptName=document.getElementById('apptName');
    const apptEmail=document.getElementById('apptEmail');
    const apptType=document.getElementById('apptType');
    const apptStatus=document.getElementById('apptStatus');
    const apptDate=document.getElementById('apptDate');
    const apptTime=document.getElementById('apptTime');
    const apptAdminNotes=document.getElementById('apptAdminNotes');
    const apptNotifMessage=document.getElementById('apptNotifMessage');
    const apptForm=document.getElementById('apptForm');

    let apptCache=[];
    let editingId=null;
    let editingRow=null;

    function setApptStatus(msg,type='muted'){
      apptStatusText.textContent=msg||'';
      apptStatusText.className=type;
    }

    function setApptFormStatus(msg,type='muted'){
      apptFormStatus.textContent=msg||'';
      apptFormStatus.className=`muted small-text ${type}`;
    }

    function formatDateTimeColumns(row){
      const d = row.date ? new Date(row.date) : null;
      const t = row.time ? new Date(row.time) : null;
      if(!d && !t) return '—';
      const datePart = d ? d.toLocaleDateString() : (t ? t.toLocaleDateString() : '');
      const timePart = t ? t.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) : '';
      return `${datePart} ${timePart}`.trim() || '—';
    }

    function statusBadge(status){
      const s = status || 'pending';
      const label =
        s==='confirmed' ? 'Confirmed' :
        s==='completed' ? 'Completed' :
        s==='cancelled' ? 'Cancelled' :
        'Pending';
      const cls =
        s==='confirmed' ? 'success' :
        s==='completed' ? 'info' :
        s==='cancelled' ? 'danger' :
        'warning';
      return `<span class="badge ${cls}">${label}</span>`;
    }

    function applyApptFilters(){
      const statusF=apptStatusFilter.value;
      const typeF=apptTypeFilter.value;
      const fromVal=apptFromDate.value;
      const toVal=apptToDate.value;
      const q=apptSearch.value.trim().toLowerCase();

      const from=fromVal ? new Date(fromVal+'T00:00:00') : null;
      const to=toVal ? new Date(toVal+'T23:59:59') : null;

      const list=apptCache.filter(a=>{
        if(statusF && (a.status||'pending')!==statusF) return false;
        if(typeF && (a.type||'consultation')!==typeF) return false;

        if(from || to){
          const baseDate = a.date ? new Date(a.date) : null;
          if(!baseDate) return false;
          if(from && baseDate<from) return false;
          if(to && baseDate>to) return false;
        }

        if(q){
          const hay=((a.name||'')+' '+(a.email||'')+' '+(a.notes||'')+' '+(a.job||'')).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      if(!list.length){
        apptTableBody.innerHTML='<tr><td colspan="7" class="muted">No appointments match the filters.</td></tr>';
        setApptStatus('No appointments match the search/filter.','muted');
        return;
      }

      apptTableBody.innerHTML=list.map(a=>{
        const dtText=formatDateTimeColumns(a);
        const msg=(a.notes||'');
        const msgShort=msg.length>70 ? msg.slice(0,67)+'…' : msg;
        const jobBadge = a.job ? `<span class="badge info"><i class="fa fa-briefcase"></i> ${a.job}</span>` : '';
        return `
          <tr data-id="${a.id}">
            <td>${a.name || '—'}</td>
            <td>${a.email || '—'}</td>
            <td>${a.type || 'consultation'}</td>
            <td>${statusBadge(a.status)}</td>
            <td>${dtText}</td>
            <td>
              ${jobBadge}
              ${msgShort ? `<div class="muted small-text" style="margin-top:.1rem;">${msgShort}</div>` : ''}
            </td>
            <td>
              <div class="toolbar" style="gap:.25rem;margin:0;">
                <button class="btn outline btn-sm" data-action="edit" title="Edit"><i class="fa fa-pen"></i></button>
                <button class="btn outline btn-sm" data-action="profile" title="Open user profile"><i class="fa fa-user"></i></button>
                <button class="btn outline btn-sm" data-action="appointment" title="Open user appointment page"><i class="fa fa-calendar-check"></i></button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      setApptStatus(`${list.length} appointment${list.length===1?'':'s'} shown.`,'muted');
    }

    async function loadAppointments(){
      apptTableBody.innerHTML='<tr><td colspan="7" class="muted">Loading appointments...</td></tr>';
      setApptStatus('');
      try{
        const { data:rows,error }=await sb.from('appointments')
          .select('id,user_id,name,email,type,status,date,time,notes,admin_notes,job,created_at')
          .order('date',{ ascending:true })
          .order('time',{ ascending:true })
          .limit(300);
        if(error) throw error;
        apptCache=rows || [];
        applyApptFilters();
      }catch(e){
        console.error(e);
        apptTableBody.innerHTML='<tr><td colspan="7" class="muted">Failed to load appointments.</td></tr>';
        setApptStatus('Failed to load appointments from database.','danger');
        showToast('Failed to load appointments.');
      }
    }

    function trapFocus(container){
      const focusable=container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if(!focusable.length) return;
      const first=focusable[0];
      const last=focusable[focusable.length-1];
      function handler(e){
        if(e.key!=='Tab') return;
        if(e.shiftKey){
          if(document.activeElement===first){ e.preventDefault(); last.focus(); }
        }else{
          if(document.activeElement===last){ e.preventDefault(); first.focus(); }
        }
      }
      container.addEventListener('keydown',handler);
      first && first.focus();
    }

    function openApptModal(row){
      editingId=row.id;
      editingRow=row;
      apptModalTitle.textContent=`Update appointment #${row.id}`;
      apptName.value=row.name || '';
      apptEmail.value=row.email || '';
      apptType.value=row.type || 'consultation';
      apptStatus.value=row.status || 'pending';

      if(row.date){
        const d=new Date(row.date);
        apptDate.value=d.toISOString().slice(0,10);
      }else{
        apptDate.value='';
      }
      if(row.time){
        const t=new Date(row.time);
        apptTime.value=t.toTimeString().slice(0,5);
      }else{
        apptTime.value='';
      }

      apptAdminNotes.value=row.admin_notes || '';
      apptNotifMessage.value='';

      const createdLabel = row.created_at ? `Created: ${new Date(row.created_at).toLocaleString()}` : 'Created: —';
      const whenLabel = formatDateTimeColumns(row);
      apptMeta.textContent = `${createdLabel} · Scheduled: ${whenLabel}`;
      apptFooterMeta.textContent = `User ID: ${row.user_id || '—'}`;

      setApptFormStatus('');
      apptModal.style.display='flex';
      trapFocus(apptModal);
    }

    function closeApptModal(){
      apptModal.style.display='none';
      editingId=null;
      editingRow=null;
    }

    apptModalCancel.addEventListener('click',closeApptModal);
    apptModal.addEventListener('click',(e)=>{ if(e.target===apptModal) closeApptModal(); });

    function makePaymentRef(appointmentId){
      const short = String(appointmentId).split('-')[0] || 'appt';
      return `APPT-${short}-${Date.now()}`;
    }

    async function ensureConsultationPayment(appt){
      if(!appt.user_id) return;
      const amountValue = 150; // GHS 150

      try{
        const { data:existing, error:checkErr } = await sb
          .from('payments')
          .select('id,status,amount')
          .eq('application_id', appt.id)
          .maybeSingle();

        if(checkErr && checkErr.code !== 'PGRST116'){
          console.warn('Failed to check existing consultation payment', checkErr);
        }

        if(existing){
          if(existing.status === 'success') return;
          if(existing.status === 'pending') return;
        }

        const payload = {
          user_id: appt.user_id,
          ref: makePaymentRef(appt.id),
          status: 'pending',
          amount: amountValue,
          currency: 'GHS',
          channel: 'paystack',
          application_id: String(appt.id),
          metadata: {
            title: 'Consultation fee',
            description: `Consultation for ${appt.type || 'consultation'} (appointment #${appt.id})`,
            source: 'admin_confirm_appointment'
          }
        };

        const { error:insertErr } = await sb.from('payments').insert(payload);
        if(insertErr){
          console.warn('Failed to create consultation payment', insertErr);
          showToast('Appointment updated, but consultation payment could not be prepared.');
        }
      }catch(e){
        console.warn('ensureConsultationPayment error', e);
      }
    }

    async function sendNotificationForAppointment(appt, message, newStatus){
      const body = message.trim();
      if(!appt.user_id || !body) return;

      try{
        const s = newStatus || appt.status || 'pending';
        const title =
          s === 'confirmed' ? 'Consultation accepted' :
          s === 'completed' ? 'Consultation completed' :
          s === 'cancelled' ? 'Consultation update' :
          'Appointment update';

        const category =
          s === 'confirmed' ? 'consultation_accepted' :
          s === 'completed' ? 'consultation_completed' :
          s === 'cancelled' ? 'consultation_cancelled' :
          'appointment';

        const link = `/views/pages/appointment.html?appointment_id=${appt.id}`;
        const metadata = {
          appointment_id: appt.id,
          type: appt.type || 'consultation',
          status: s,
          source: 'admin_appointments_page'
        };

        const { error } = await sb.from('notifications').insert({
          user_id: appt.user_id,
          user_email: appt.email || null,
          title,
          category,
          message: body,
          text: body,
          link,
          importance: 'normal',
          email_ready: false,
          read: false,
          metadata
        });
        if(error) throw error;
      }catch(e){
        console.warn('Failed to send appointment notification', e);
        showToast('Update saved, but notification failed.',3000);
      }
    }

    apptModalSave.addEventListener('click',async()=>{
      if(!editingId || !editingRow){
        setApptFormStatus('No appointment selected.','danger');
        return;
      }
      const type=apptType.value || 'consultation';
      const status=apptStatus.value || 'pending';
      const dateVal=apptDate.value;
      const timeVal=apptTime.value;
      const admin_notes=apptAdminNotes.value.trim() || null;
      const notifMessage = apptNotifMessage.value.trim();

      let dateValue = null;
      let timeValue = null;
      if(dateVal){
        dateValue = new Date(`${dateVal}T00:00:00`).toISOString();
      }
      if(timeVal){
        timeValue = new Date(`1970-01-01T${timeVal}:00`).toISOString();
      }

      setApptFormStatus('Saving appointment...','muted');
      apptModalSave.disabled=true;

      try{
        const payload={ type,status,admin_notes };
        if(dateValue) payload.date = dateValue;
        if(timeValue) payload.time = timeValue;

        const { error }=await sb.from('appointments').update(payload).eq('id',editingId);
        if(error) throw error;

        apptCache = apptCache.map(a =>
          a.id === editingId ? { ...a, ...payload } : a
        );
        applyApptFilters();

        const updatedAppt = apptCache.find(a=>a.id===editingId) || editingRow;

        if(status === 'confirmed' && updatedAppt){
          await ensureConsultationPayment(updatedAppt);
        }

        if(notifMessage && updatedAppt){
          await sendNotificationForAppointment(updatedAppt, notifMessage, status);
        }

        showToast('Appointment updated.');
        setApptFormStatus('Saved successfully.','success');
        setTimeout(closeApptModal,800);
      }catch(e){
        console.error(e);
        setApptFormStatus(e.message || 'Failed to save appointment.','danger');
        showToast('Failed to save appointment.',3000);
      }finally{
        apptModalSave.disabled=false;
      }
    });

    apptForm.addEventListener('submit',(e)=> e.preventDefault());

    apptStatusFilter.addEventListener('change',applyApptFilters);
    apptTypeFilter.addEventListener('change',applyApptFilters);
    apptFromDate.addEventListener('change',applyApptFilters);
    apptToDate.addEventListener('change',applyApptFilters);
    apptSearch.addEventListener('input',applyApptFilters);
    apptRefreshBtn.addEventListener('click',loadAppointments);

    apptTodayBtn.addEventListener('click',()=>{
      const today=new Date();
      const yyyy=today.getFullYear();
      const mm=String(today.getMonth()+1).padStart(2,'0');
      const dd=String(today.getDate()).padStart(2,'0');
      const val=`${yyyy}-${mm}-${dd}`;
      apptFromDate.value=val;
      apptToDate.value=val;
      applyApptFilters();
    });

    apptUpcomingBtn.addEventListener('click',()=>{
      const today=new Date();
      const yyyy=today.getFullYear();
      const mm=String(today.getMonth()+1).padStart(2,'0');
      const dd=String(today.getDate()).padStart(2,'0');
      apptFromDate.value=`${yyyy}-${mm}-${dd}`;
      apptToDate.value='';
      applyApptFilters();
    });

    apptTableBody.addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-action]');
      if(!btn) return;
      const tr=btn.closest('tr');
      const id=tr.dataset.id;
      const row=apptCache.find(x=>String(x.id)===String(id));
      if(!row) return;

      const action = btn.dataset.action;
      if(action === 'edit'){
        openApptModal(row);
      }else if(action === 'profile'){
        if(row.email){
          window.open(`/views/pages/profile.html?email=${encodeURIComponent(row.email)}`,'_blank');
        }else{
          showToast('No email on this appointment.');
        }
      }else if(action === 'appointment'){
        const qs = new URLSearchParams({ appointment_id: row.id });
        window.open(`/views/pages/appointment.html?${qs.toString()}`,'_blank');
      }
    });

    await loadAppointments();
  </script>
</body>
</html>
