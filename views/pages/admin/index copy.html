<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Elite Travel & Tour admin dashboard with KPIs, charts, and insights"/>
  <link rel="stylesheet" href="/public/css/base.css">
  <link rel="stylesheet" href="/public/css/layout.css">
  <link rel="stylesheet" href="/public/css/components.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="/public/js/supabase.js"></script>
  <script type="module">
    import { mountShell } from '/public/js/ui.js';
    mountShell({ withSidebar: true, requireAdmin: true });
  </script>
  <style>
    :root{
      --brand:#0077cc;
      --brand-600:#0060a3;
      --success:#2e7d32;
      --danger:#c62828;
      --muted:#666;
      --bg:#f7f8fa;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --gray-200:#e9ecef;
      --gray-300:#dee2e6;
      --radius:12px;
    }
    body { background:var(--bg); color:#222; }
    .container { max-width:1400px; margin:0 auto; padding:1rem; }
    .main { padding:1rem; }

    .grid { display:grid; gap:1rem; }
    .grid-2 { grid-template-columns:repeat(2,minmax(0,1fr)); }
    .grid-4 { grid-template-columns:repeat(4,minmax(0,1fr)); }
    @media (max-width:1000px){ .grid-4{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width:700px){ .grid-2,.grid-4{ grid-template-columns:1fr; } }

    .kpi { background:#fff; border:1px solid var(--gray-200); border-radius:var(--radius); padding:1rem; text-align:center; box-shadow:var(--shadow); }
    .kpi .val { font-size:2rem; font-weight:800; margin-bottom:.25rem; color:#0b4d78; }
    .kpi i { font-size:1.5rem; margin-bottom:.25rem; color:var(--brand); }

    .card { background:#fff; border:1px solid var(--gray-200); border-radius:var(--radius); box-shadow:var(--shadow); }
    .card .body { padding:1rem; }

    .chart-card { padding:1rem; }
    .list .card { margin-bottom:.6rem; }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .badge { padding:.25rem .5rem; border-radius:999px; background:#eaf4ff; color:#0a4d7a; border:1px solid #cfe6ff; font-size:.8rem; font-weight:600; }
    .muted { color:var(--muted); }

    .insights { margin-top:1rem; display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
    .insight { background:#fff; border:1px solid var(--gray-200); border-radius:var(--radius); padding:1rem; box-shadow:var(--shadow); }
    .insight h4 { margin-bottom:.5rem; }

    .controls .btn { display:inline-flex; align-items:center; gap:.45rem; border:none; border-radius:8px; padding:.5rem .85rem; cursor:pointer; font-weight:700; }
    .btn.brand { background:var(--brand); color:#fff; }
    .btn.brand:hover { background:var(--brand-600); }
    .btn.outline { background:#fff; border:1px solid var(--gray-300); color:#222; }
    .btn.outline:hover { border-color:var(--brand); color:var(--brand); }

    .input { padding:.45rem .6rem; border:1px solid var(--gray-300); border-radius:8px; }
    .pagination { display:flex; gap:.5rem; margin-top:1rem; flex-wrap:wrap; }
    .pagination button { padding:.4rem .8rem; border-radius:8px; border:1px solid var(--gray-300); background:#fff; cursor:pointer; }
    .pagination .active { background:var(--brand); border-color:var(--brand); color:#fff; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center; z-index:1000; }
    .modal .card { max-width:460px; width:92%; }
    .modal .body { display:grid; gap:.6rem; }

    .alert { margin-top:.5rem; padding:.6rem .75rem; border-radius:8px; border:1px solid var(--gray-300); background:#fff; }
    .alert.success { border-color:#bde5cb; background:#e7f7ee; color:#155724; }
    .alert.danger { border-color:#f4c7c8; background:#fdecec; color:#8a1c1d; }

    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body>
  <div id="header"></div>
  <div class="container grid grid-2">
    <div id="sidebar"></div>
    <main class="main">
      <!-- KPI Section -->
      <section class="grid grid-4" aria-label="KPIs">
        <div class="kpi" aria-live="polite"><i class="fa fa-users"></i><div class="val" id="userCount">0</div><div>Users</div></div>
        <div class="kpi" aria-live="polite"><i class="fa fa-briefcase"></i><div class="val" id="jobCount">0</div><div>Jobs</div></div>
        <div class="kpi" aria-live="polite"><i class="fa fa-file-alt"></i><div class="val" id="appCount">0</div><div>Applications</div></div>
        <div class="kpi" aria-live="polite"><i class="fa fa-credit-card"></i><div class="val" id="payCount">0</div><div>Payments</div></div>
      </section>

      <!-- Charts Section -->
      <section class="grid grid-2" aria-label="Charts">
        <div class="card chart-card"><div class="body">
          <h3>User Growth</h3>
          <canvas id="userChart" aria-label="User growth chart"></canvas>
        </div></div>
        <div class="card chart-card"><div class="body">
          <h3>Payments Trend</h3>
          <canvas id="payChart" aria-label="Payments trend chart"></canvas>
        </div></div>
      </section>

      <!-- Recent Activity -->
      <section class="grid grid-2" aria-label="Recent items">
        <div class="card"><div class="body">
          <h3>Recent Applications</h3>
          <div class="list" id="recentApps"></div>
        </div></div>
        <div class="card"><div class="body">
          <h3>Recent Payments</h3>
          <div class="list" id="recentPays"></div>
        </div></div>
      </section>

      <!-- Insights Section -->
      <section class="insights" aria-label="Insights">
        <div class="insight"><h4>Top Service</h4><p id="topService">Loading...</p></div>
        <div class="insight"><h4>Most Active User</h4><p id="activeUser">Loading...</p></div>
        <div class="insight"><h4>Pending Applications</h4><p id="pendingApps">Loading...</p></div>
        <div class="insight"><h4>Revenue (Month)</h4><p id="monthlyRevenue">Loading...</p></div>
      </section>

      <!-- Controls -->
      <section class="card controls"><div class="body">
        <h3>Controls</h3>
        <div class="toolbar">
          <label class="muted">From <input type="date" id="fromDate" class="input"></label>
          <label class="muted">To <input type="date" id="toDate" class="input"></label>
          <button class="btn outline" id="applyFilters"><i class="fa fa-filter"></i> Apply</button>
          <button class="btn outline" id="clearFilters"><i class="fa fa-times"></i> Clear</button>
          <button class="btn" id="exportApps"><i class="fa fa-download"></i> Export Apps</button>
          <button class="btn" id="exportPays"><i class="fa fa-download"></i> Export Pays</button>
          <button class="btn outline" id="printBtn"><i class="fa fa-print"></i> Print</button>
          <button class="btn outline" id="forceRefresh"><i class="fa fa-rotate-right"></i> Refresh</button>
        </div>
        <div id="controlStatus" class="muted" aria-live="polite"></div>
      </div></section>

      <!-- Activity Feed -->
      <section class="card"><div class="body">
        <h3>Activity Feed</h3>
        <div id="activityFeed" class="list"></div>
      </div></section>
    </main>
  </div>
  <div id="footer"></div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <section class="card"><div class="body">
      <h3 id="confirmTitle">Confirm Action</h3>
      <p id="confirmText"></p>
      <div class="toolbar">
        <button class="btn outline" id="cancelBtn">Cancel</button>
        <button class="btn brand" id="confirmBtn">Confirm</button>
      </div>
    </div></section>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detailModal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
    <section class="card"><div class="body">
      <h3 id="detailTitle">Detail</h3>
      <div id="detailContent"></div>
      <div class="toolbar">
        <button class="btn brand" id="closeDetail"><i class="fa fa-check"></i> Close</button>
      </div>
    </div></section>
  </div>

  <script type="module">
    import { sb } from '/public/js/supabase.js';

    // KPI loading
    async function loadKPIs(){
      try{
        const [{count:users},{count:jobs},{count:apps},{count:pays}] = await Promise.all([
          sb.from('users').select('*',{count:'exact',head:true}),
          sb.from('jobs').select('*',{count:'exact',head:true}),
          sb.from('applications').select('*',{count:'exact',head:true}),
          sb.from('payments').select('*',{count:'exact',head:true})
        ]);
        document.getElementById('userCount').textContent = users || 0;
        document.getElementById('jobCount').textContent  = jobs || 0;
        document.getElementById('appCount').textContent  = apps || 0;
        document.getElementById('payCount').textContent  = pays || 0;
      }catch(e){
        console.warn('KPI load failed', e);
      }
    }

    // Recent sections
    async function loadRecent(){
      const { data: apps } = await sb.from('applications')
        .select('id,applicant_name,item,status,created_at')
        .order('created_at',{ascending:false}).limit(5);
      const { data: pays } = await sb.from('payments')
        .select('user_id,ref,amount,status,created_at')
        .order('created_at',{ascending:false}).limit(5);

      const appList = document.getElementById('recentApps');
      appList.innerHTML = (apps||[]).map(a=>`
        <div class="card"><div class="body toolbar">
          <span>${a.applicant_name}</span>
          <span>${a.item}</span>
          <span class="badge">${a.status}</span>
          <span class="muted">${new Date(a.created_at).toLocaleDateString()}</span>
          <button class="btn outline" data-action="appDetail" data-id="${a.id}"><i class="fa-regular fa-eye"></i> View</button>
        </div></div>`).join('');

      const payList = document.getElementById('recentPays');
      payList.innerHTML = (pays||[]).map(p=>`
        <div class="card"><div class="body toolbar">
          <span>User ${p.user_id}</span>
          <span><strong>${p.ref}</strong></span>
          <span>GHS ${p.amount}</span>
          <span class="badge">${p.status}</span>
          <span class="muted">${new Date(p.created_at).toLocaleDateString()}</span>
          <button class="btn outline" data-action="payDetail" data-ref="${p.ref}"><i class="fa-regular fa-eye"></i> View</button>
        </div></div>`).join('');
    }

    // Charts
    let userChart=null, payChart=null;
    async function loadCharts(){
      try{
        const { data: userStats } = await sb.rpc('user_growth'); // [{month,count}]
        const { data: payStats }  = await sb.rpc('payment_trend'); // [{month,total}]
        const userCtx = document.getElementById('userChart').getContext('2d');
        const payCtx  = document.getElementById('payChart').getContext('2d');

        if(userChart) userChart.destroy();
        if(payChart) payChart.destroy();

        userChart = new Chart(userCtx,{
          type:'line',
          data:{
            labels:(userStats||[]).map(u=>u.month),
            datasets:[{label:'Users',data:(userStats||[]).map(u=>u.count),borderColor:'#0077cc',tension:.25}]
          },
          options:{ responsive:true, plugins:{ legend:{ display:true } } }
        });

        payChart = new Chart(payCtx,{
          type:'bar',
          data:{
            labels:(payStats||[]).map(p=>p.month),
            datasets:[{label:'Payments (GHS)',data:(payStats||[]).map(p=>p.total),backgroundColor:'#4caf50'}]
          },
          options:{ responsive:true, plugins:{ legend:{ display:true } } }
        });
      }catch(e){
        console.warn('Charts failed',e);
      }
    }

    // Insights
    async function loadInsights(){
      try{
        const { data: topService } = await sb.rpc('top_service'); // {name}
        const { data: activeUser } = await sb.rpc('most_active_user'); // {name}
        const { count: pending }   = await sb.from('applications').select('*',{count:'exact',head:true}).eq('status','pending');
        const { data: revenue }    = await sb.rpc('monthly_revenue'); // {amount}

        document.getElementById('topService').textContent    = topService?.name ?? 'N/A';
        document.getElementById('activeUser').textContent    = activeUser?.name ?? 'N/A';
        document.getElementById('pendingApps').textContent   = pending ?? 0;
        document.getElementById('monthlyRevenue').textContent= `GHS ${revenue?.amount ?? 0}`;
      }catch(e){
        console.warn('Insights failed', e);
      }
    }

    // Activity feed (part 1)
    async function loadActivityFeed(){
      const { data: feed } = await sb.from('activity_log')
        .select('id, actor, action, entity, created_at')
        .order('created_at',{ascending:false})
        .limit(20);
      const feedList = document.getElementById('activityFeed');
      feedList.innerHTML = (feed||[]).map(f=>`
        <div class="card"><div class="body toolbar">
          <span><strong>${f.actor}</strong></span>
          <span>${f.action}</span>
          <span class="muted">${f.entity}</span>
          <span class="badge">${new Date(f.created_at).toLocaleString()}</span>
        </div></div>
      `).join('');
    }

    // Export helpers
    function toCSV(rows,headers){
      const esc=v=>`"${String(v??'').replace(/"/g,'""')}"`;
      const head=headers.join(',');
      const body=rows.map(r=>headers.map(h=>esc(r[h])).join(',')).join('\n');
      return head+'\n'+body;
    }
    function downloadFile(filename,content){
      const blob=new Blob([content],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }

    // Export buttons (part 1)
    document.getElementById('exportApps').addEventListener('click',async()=>{
      const { data }=await sb.from('applications').select('id,applicant_name,item,status,created_at').limit(500);
      const csv=toCSV(data||[],['id','applicant_name','item','status','created_at']);
      downloadFile('applications.csv',csv);
    });
    document.getElementById('exportPays').addEventListener('click',async()=>{
      const { data }=await sb.from('payments').select('id,user_id,ref,amount,status,created_at').limit(500);
      const csv=toCSV(data||[],['id','user_id','ref','amount','status','created_at']);
      downloadFile('payments.csv',csv);
    });

    // Filters (part 1 basic)
    document.getElementById('applyFilters').addEventListener('click',async()=>{
      const from=document.getElementById('fromDate').value;
      const to=document.getElementById('toDate').value;
      const status=document.getElementById('controlStatus');
      status.textContent='Applying filters...';
      let query=sb.from('applications').select('id,applicant_name,item,status,created_at').order('created_at',{ascending:false});
      if(from) query=query.gte('created_at',from);
      if(to) query=query.lte('created_at',to);
      const { data,error }=await query.limit(10);
      if(error){ status.textContent=error.message; return; }
      const appList=document.getElementById('recentApps');
      appList.innerHTML=(data||[]).map(a=>`
        <div class="card"><div class="body toolbar">
          <span>${a.applicant_name}</span><span>${a.item}</span><span class="badge">${a.status}</span>
          <span class="muted">${new Date(a.created_at).toLocaleDateString()}</span>
          <button class="btn outline" data-action="appDetail" data-id="${a.id}"><i class="fa-regular fa-eye"></i> View</button>
        </div></div>`).join('');
      status.textContent=`Filtered ${data?.length||0} applications.`;
    });
    document.getElementById('clearFilters').addEventListener('click',()=>{
      document.getElementById('fromDate').value='';
      document.getElementById('toDate').value='';
      document.getElementById('controlStatus').textContent='Filters cleared.';
      loadRecent();
    });

    // Print and refresh (part 1)
    document.getElementById('printBtn').addEventListener('click',()=> window.print());
    document.getElementById('forceRefresh').addEventListener('click',async()=>{
      const el=document.getElementById('controlStatus');
      el.textContent='Refreshing...';
      await Promise.all([loadKPIs(),loadRecent(),loadCharts(),loadInsights(),loadActivityFeed()]);
      el.textContent='Refreshed.';
    });

    // Detail modal
    const detailModal=document.getElementById('detailModal');
    const detailTitle=document.getElementById('detailTitle');
    const detailContent=document.getElementById('detailContent');
    const closeDetail=document.getElementById('closeDetail');
    function trapFocus(modal){
      const focusable = modal.querySelectorAll('a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])');
      const first = focusable[0];
      const last  = focusable[focusable.length-1];
      function keyHandler(e){
        if(e.key !== 'Tab') return;
        if(e.shiftKey){
          if(document.activeElement === first){ e.preventDefault(); last.focus(); }
        } else {
          if(document.activeElement === last){ e.preventDefault(); first.focus(); }
        }
      }
      modal.addEventListener('keydown', keyHandler);
      first && first.focus();
    }
    function openModal(m){ m.style.display='flex'; trapFocus(m); }
    function closeModal(m){ m.style.display='none'; }

    // Row detail handlers
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const action = btn.getAttribute('data-action');
      if(action==='appDetail'){
        const id = btn.getAttribute('data-id');
        const { data, error } = await sb.from('applications').select('*').eq('id', id).single();
        if(error) return;
        detailTitle.textContent = `Application: ${data.item || ''}`;
        detailContent.innerHTML = `
          <div style="display:grid;gap:.5rem;">
            <div><strong>Applicant:</strong> ${data.applicant_name || ''}</div>
            <div><strong>Status:</strong> <span class="badge">${data.status}</span></div>
            <div><strong>Created:</strong> ${new Date(data.created_at).toLocaleString()}</div>
            ${data.metadata ? `<pre style="background:#f7f7f7;border:1px solid #eee;border-radius:8px;padding:.75rem;overflow:auto;">${JSON.stringify(data.metadata,null,2)}</pre>` : ''}
          </div>
        `;
        openModal(detailModal);
      }
      if(action==='payDetail'){
        const ref = btn.getAttribute('data-ref');
        const { data, error } = await sb.from('payments').select('*').eq('ref', ref).single();
        if(error) return;
        detailTitle.textContent = `Payment: ${data.ref || ''}`;
        detailContent.innerHTML = `
          <div style="display:grid;gap:.5rem;">
            <div><strong>User:</strong> ${data.user_id}</div>
            <div><strong>Amount:</strong> GHS ${data.amount}</div>
            <div><strong>Status:</strong> <span class="badge">${data.status}</span></div>
            <div><strong>Created:</strong> ${new Date(data.created_at).toLocaleString()}</div>
          </div>
        `;
        openModal(detailModal);
      }
    });
    closeDetail.addEventListener('click', ()=> closeModal(detailModal));
    detailModal.addEventListener('click', (e)=> { if(e.target===detailModal) closeModal(detailModal); });

    // Confirmation modal template
    const confirmModal=document.getElementById('confirmModal');
    const confirmTitle=document.getElementById('confirmTitle');
    const confirmText=document.getElementById('confirmText');
    const confirmBtn=document.getElementById('confirmBtn');
    const cancelBtn=document.getElementById('cancelBtn');
    let pendingAction=null;
    cancelBtn.addEventListener('click',()=>{ confirmModal.style.display='none'; pendingAction=null; });
    confirmBtn.addEventListener('click',async()=>{
      if(pendingAction==='refresh'){ await loadKPIs(); }
      confirmModal.style.display='none'; pendingAction=null;
    });

    // PART 2: Filters with date endpoints and combined lists
    async function applyDateFilters(){
      const from=document.getElementById('fromDate').value;
      const to=document.getElementById('toDate').value;
      const controlStatus=document.getElementById('controlStatus');
      controlStatus.textContent='Applying filters...';

      let appsQuery=sb.from('applications').select('id,applicant_name,item,status,created_at').order('created_at',{ascending:false}).limit(5);
      if(from) appsQuery=appsQuery.gte('created_at',from);
      if(to) appsQuery=appsQuery.lte('created_at',to+'T23:59:59');
      const { data: apps }=await appsQuery;

      let paysQuery=sb.from('payments').select('user_id,ref,amount,status,created_at').order('created_at',{ascending:false}).limit(5);
      if(from) paysQuery=paysQuery.gte('created_at',from);
      if(to) paysQuery=paysQuery.lte('created_at',to+'T23:59:59');
      const { data: pays }=await paysQuery;

      const appList=document.getElementById('recentApps');
      appList.innerHTML=(apps||[]).map(a=>`
        <div class="card"><div class="body toolbar">
          <span>${a.applicant_name}</span><span>${a.item}</span><span class="badge">${a.status}</span>
          <span class="muted">${new Date(a.created_at).toLocaleDateString()}</span>
          <button class="btn outline" data-action="appDetail" data-id="${a.id}"><i class="fa-regular fa-eye"></i> View</button>
        </div></div>`).join('');

      const payList=document.getElementById('recentPays');
      payList.innerHTML=(pays||[]).map(p=>`
        <div class="card"><div class="body toolbar">
          <span>User ${p.user_id}</span><span><strong>${p.ref}</strong></span>
          <span>GHS ${p.amount}</span><span class="badge">${p.status}</span>
          <span class="muted">${new Date(p.created_at).toLocaleDateString()}</span>
          <button class="btn outline" data-action="payDetail" data-ref="${p.ref}"><i class="fa-regular fa-eye"></i> View</button>
        </div></div>`).join('');

      controlStatus.textContent='Filters applied.';
    }

    document.getElementById('applyFilters').addEventListener('click',applyDateFilters);
    document.getElementById('clearFilters').addEventListener('click',async()=>{
      document.getElementById('fromDate').value='';
      document.getElementById('toDate').value='';
      document.getElementById('controlStatus').textContent='Filters cleared.';
      await loadRecent();
    });
    document.getElementById('forceRefresh').addEventListener('click',async()=>{
      document.getElementById('controlStatus').textContent='Refreshing...';
      await Promise.all([loadKPIs(),loadRecent(),loadCharts(),loadInsights(),loadActivityFeed()]);
      document.getElementById('controlStatus').textContent='Refreshed.';
    });

    // Export CSV (part 2)
    function toCSV2(rows,headers){
      const esc=v=>`"${String(v??'').replace(/"/g,'""')}"`;
      const head=headers.join(',');
      const body=rows.map(r=>headers.map(h=>esc(r[h])).join(',')).join('\n');
      return head+'\n'+body;
    }
    function downloadFile2(filename,content){
      const blob=new Blob([content],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('exportApps').addEventListener('click',async()=>{
      const { data }=await sb.from('applications').select('id,applicant_name,item,status,created_at').order('created_at',{ascending:false}).limit(100);
      const csv=toCSV2(data||[],['id','applicant_name','item','status','created_at']);
      downloadFile2('applications.csv',csv);
    });
    document.getElementById('exportPays').addEventListener('click',async()=>{
      const { data }=await sb.from('payments').select('user_id,ref,amount,status,created_at').order('created_at',{ascending:false}).limit(100);
      const csv=toCSV2(data||[],['user_id','ref','amount','status','created_at']);
      downloadFile2('payments.csv',csv);
    });

    // Activity feed (part 2)
    async function refreshActivityFeed(){
      const { data: appEv }=await sb.from('applications').select('applicant_name,status,created_at,item').order('created_at',{ascending:false}).limit(10);
      const { data: payEv }=await sb.from('payments').select('user_id,status,created_at,amount,ref').order('created_at',{ascending:false}).limit(10);
      const entries=[
        ...(appEv||[]).map(a=>({t:'application',text:`${a.applicant_name} • ${a.item} — ${a.status}`,date:a.created_at})),
        ...(payEv||[]).map(p=>({t:'payment',text:`User ${p.user_id} • GHS ${p.amount} • ${p.ref} — ${p.status}`,date:p.created_at}))
      ].sort((x,y)=>new Date(y.date)-new Date(x.date)).slice(0,10);
      const feed=document.getElementById('activityFeed');
      feed.innerHTML=entries.map(e=>`
        <div class="card"><div class="body toolbar">
          <span class="badge">${e.t}</span><span>${e.text}</span>
          <span class="muted">${new Date(e.date).toLocaleString()}</span>
        </div></div>`).join('');
    }

    // Realtime updates (optional)
    const channel = sb
      .channel('admin-dashboard')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'applications' }, async ()=>{
        await Promise.all([loadKPIs(),loadRecent(),loadInsights(),refreshActivityFeed()]);
      })
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'payments' }, async ()=>{
        await Promise.all([loadKPIs(),loadRecent(),loadInsights(),refreshActivityFeed()]);
      })
      .subscribe();

    // Initial load
    await loadKPIs();
    await loadRecent();
    await loadCharts();
    await loadInsights();
    await loadActivityFeed();
    await refreshActivityFeed();

    // Cleanup
    window.addEventListener('beforeunload', ()=> {
      try { sb.removeChannel(channel); } catch(e){}
    });
  </script>
</body>
</html>
