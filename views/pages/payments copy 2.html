<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Elite Travel & Tour — Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Secure payment portal for Elite Travel & Tour — program, service, and application payments."/>
  <link rel="stylesheet" href="/public/css/base.css">
  <link rel="stylesheet" href="/public/css/layout.css">
  <link rel="stylesheet" href="/public/css/components.css">
  <link rel="stylesheet" href="/public/css/pages.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --brand:#0077cc;
      --brand-600:#0060a3;
      --brand-700:#004b80;
      --dark:#020617;
      --muted:#64748b;
      --border:#1f2937;
      --bg:#020617;
      --light:#f9fafb;
      --danger:#f97373;
      --success:#22c55e;
      --warning:#fbbf24;
    }

    body{
      background:#020617;
      color:#e5e7eb;
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
    }

    /* Header like tracking page */
    nav {
      position:sticky; top:0; background:#020617; z-index:1000;
      padding:.5rem 1rem; box-shadow:0 2px 18px rgba(0,0,0,0.65);
      border-bottom:1px solid rgba(31,41,55,.9);
    }
    nav .wrap { max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    nav .logo { display:flex; align-items:center; gap:.5rem; font-weight:800; color:#e5e7eb; text-decoration:none; white-space:nowrap; }
    nav .logo i { color:#38bdf8; }
    nav ul.primary { display:flex; gap:1rem; list-style:none; margin:0; padding:0; }
    nav a { text-decoration:none; color:#cbd5f5; font-weight:600; padding:.4rem .6rem; border-radius:6px; display:inline-flex; align-items:center; gap:.4rem; font-size:.9rem; }
    nav a:hover, nav a.active { color:#f9fafb; background:rgba(37,99,235,.22); }

    .nav-right{ display:flex; gap:.5rem; align-items:center; }
    .btn-nav{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.4rem .7rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:transparent;
      color:#e5e7eb;
      cursor:pointer;
      font-size:.82rem;
    }
    .btn-nav:hover{
      border-color:#38bdf8;
      color:#38bdf8;
      background:rgba(15,23,42,.8);
    }
    .auth-pill{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.2rem .6rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:#020617;
      color:#cbd5f5;
      font-size:.8rem;
      max-width:33vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .auth-pill i{ color:#22c55e; }

    .menu-toggle { display:none; border:none; background:#020617; color:#e5e7eb; padding:.45rem .6rem; border-radius:999px; box-shadow:0 0 0 1px rgba(31,41,55,.9); }
    .menu-toggle i { font-size:1.1rem; }
    .mobile-panel { display:none; background:#020617; border-top:1px solid rgba(31,41,55,.9); box-shadow:0 16px 30px rgba(0,0,0,.75); }
    .mobile-panel.open { display:block; }
    .mobile-panel .block { max-width:1100px; margin:0 auto; display:flex; flex-direction:column; padding:.75rem 1rem; gap:.25rem; }
    .mobile-panel a { padding:.55rem .75rem; border-radius:8px; color:#e5e7eb; font-weight:600; font-size:.9rem; text-decoration:none; }
    .mobile-panel a:hover { background:#020c28; color:#38bdf8; }
    @media (max-width:880px){
      nav ul.primary{ display:none; }
      .menu-toggle{ display:inline-flex; }
      .auth-pill.desktop-only{ display:none; }
    }

    .chip-inline{
      display:inline-flex; align-items:center; gap:.3rem;
      padding:.2rem .6rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:#020617;
      color:#e5e7eb;
      font-size:.78rem;
    }

    main.payment-main{
      max-width:1100px;
      margin:1.5rem auto 2.5rem;
      padding:0 1rem;
    }
    .payment-layout{
      display:grid;
      grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
      gap:1rem;
    }
    @media(max-width:900px){
      .payment-layout{
        grid-template-columns: 1fr;
      }
    }
    .card{
      background:#020617;
      border-radius:14px;
      border:1px solid rgba(31,41,55,.9);
      box-shadow:0 24px 60px rgba(15,23,42,.7);
      padding:1rem;
    }
    .section-title{
      font-size:1.2rem;
      margin-bottom:.35rem;
    }
    .muted{ color:#64748b; }

    .summary-header{
      display:flex;
      gap:.75rem;
      align-items:flex-start;
    }
    .summary-cover{
      width:88px;
      height:88px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(31,41,55,.9);
      background:#020617;
      flex-shrink:0;
    }
    .summary-cover img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .summary-pills{
      display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.35rem;
    }
    .pill{
      padding:.15rem .55rem;
      border-radius:999px;
      font-size:.78rem;
      border:1px solid rgba(148,163,184,.7);
      background:#020617;
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:.3rem;
    }

    .amount-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:.6rem;
      padding-top:.6rem;
      border-top:1px dashed rgba(55,65,81,.9);
      gap:.75rem;
      flex-wrap:wrap;
    }
    .price-main{
      font-size:1.35rem;
      font-weight:700;
      color:#e5e7eb;
    }
    .price-sub{
      font-size:.82rem;
      color:#9ca3af;
    }

    .badge{
      display:inline-flex; align-items:center; gap:.3rem;
      padding:.12rem .5rem; border-radius:999px;
      font-size:.75rem;
      background:rgba(15,118,110,.15);
      border:1px solid rgba(20,184,166,.7);
      color:#ccfbf1;
    }

    .form-grid{
      display:grid;
      gap:.7rem;
    }
    .form-grid-2{
      display:grid;
      gap:.7rem;
      grid-template-columns:repeat(2,minmax(0,1fr));
    }
    @media(max-width:700px){
      .form-grid-2{
        grid-template-columns:1fr;
      }
    }

    label{
      display:block;
      font-size:.84rem;
      color:#9ca3af;
      margin-bottom:.2rem;
    }
    .input, textarea, select{
      width:100%;
      box-sizing:border-box;
      padding:.55rem .7rem;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.7);
      background:#020617;
      font-size:.9rem;
      color:#e5e7eb;
      transition:border-color .12s, box-shadow .12s, background .12s;
    }
    .input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:#38bdf8;
      box-shadow:0 0 0 2px rgba(56,189,248,.35);
      background:#020617;
    }
    textarea{ min-height:80px; resize:vertical; }

    .method-options{
      display:flex;
      flex-direction:column;
      gap:.35rem;
    }
    .method-option{
      display:flex;
      align-items:flex-start;
      gap:.5rem;
      padding:.45rem .6rem;
      border-radius:10px;
      border:1px solid rgba(55,65,81,.9);
      background:#020617;
      cursor:pointer;
    }
    .method-option input{
      margin-top:.2rem;
    }
    .method-option.active{
      border-color:#38bdf8;
      box-shadow:0 0 0 1px rgba(56,189,248,.4);
    }
    .method-option strong{
      font-size:.9rem;
    }
    .method-option .muted{ font-size:.8rem; }

    .btn{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.55rem .95rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:.9rem;
      text-decoration:none;
      transition:all .15s ease-out;
    }
    .btn.brand{
      background:#0077cc;
      color:#f9fafb;
      box-shadow:0 10px 26px rgba(37,99,235,.4);
    }
    .btn.brand:hover{
      background:#0060a3;
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(37,99,235,.55);
    }
    .btn.outline{
      background:transparent;
      color:#e5e7eb;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
    }
    .btn.outline:hover{
      border-color:#38bdf8;
      color:#38bdf8;
      background:rgba(15,23,42,.7);
    }
    .btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .toast{
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:#020617; color:#e5e7eb; padding:.75rem 1rem; border-radius:999px;
      box-shadow:0 16px 40px rgba(15,23,42,.85); z-index:2000; display:none; max-width:90vw;
      font-size:.9rem;
    }
    .toast.show{ display:flex; align-items:center; gap:.6rem; }
    .toast i{ color:#38bdf8; }

    .info-box{
      font-size:.8rem;
      color:#9ca3af;
      border-radius:10px;
      border:1px dashed rgba(148,163,184,.6);
      padding:.45rem .55rem;
      margin-top:.5rem;
    }

    .sub-note{
      font-size:.78rem;
      color:#9ca3af;
      margin-top:.25rem;
    }

    .modal{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .modal .card{
      max-width:420px;
      width:92%;
    }

    footer { background:var(--dark); color:#eee; padding:2rem 1rem; border-top:1px solid rgba(31,41,55,.8); }
    footer .grid { max-width:1100px; margin:0 auto; display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    footer a { color:#eee; text-decoration:none; }
    footer a:hover { text-decoration:underline; }
    footer .social i { margin-right:.5rem; }
    .footer-bottom { max-width:1100px; margin:1rem auto 0; text-align:center; color:#9ca3af; font-size:.9rem; }
  </style>
</head>
<body>
  <!-- Header (aligned with tracking) -->
  <nav aria-label="Primary">
    <div class="wrap">
      <a class="logo" href="/"><img src="/public/assets/logo/logo.png" alt="Elite Travel & Tour"></a>
      <ul class="primary">
        <li><a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a></li>
        <li><a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a></li>
        <li><a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a></li>
        <li><a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a></li>
        <li><a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a></li>
        <li><a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a></li>
      </ul>
      <div class="nav-right">
        <span id="authStatus" class="auth-pill desktop-only" style="display:none;">
          <i class="fa fa-user-check"></i><span class="auth-text" id="userEmail">Guest</span>
        </span>
        <button id="loginBtn" class="btn-nav"><i class="fa fa-right-to-bracket"></i> Login</button>
        <button id="profileBtn" class="btn-nav" style="display:none;"><i class="fa fa-user"></i></button>
        <button id="logoutBtn" class="btn-nav" style="display:none;"><i class="fa fa-right-from-bracket"></i></button>
        <button id="menuToggle" class="menu-toggle" aria-expanded="false"><i class="fa fa-bars"></i></button>
      </div>
    </div>

    <!-- Mobile panel -->
    <div id="mobilePanel" class="mobile-panel">
      <div class="block">
        <a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a>
        <a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a>
        <a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a>
        <a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a>
        <a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a>
        <a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a>
      </div>
      <div class="block">
        <span class="auth-pill"><i class="fa fa-user"></i><span id="mobileAuthText">Guest</span></span>
        <div class="form-grid-2" style="margin-top:.5rem;">
          <button id="mobileLoginBtn" class="btn brand"><i class="fa fa-right-to-bracket"></i> Login</button>
          <button id="mobileLogoutBtn" class="btn outline" style="display:none;"><i class="fa fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <main class="payment-main">
    <h1 class="section-title" style="margin-bottom:.2rem;">Secure payment</h1>
    <p class="muted" style="font-size:.88rem;margin-bottom:.8rem;">
      Pay for your Elite application, program, or service. Amount can be pre‑set from your application or entered manually.
    </p>

    <div class="payment-layout">
      <!-- SUMMARY -->
      <section class="card" id="summaryCard">
        <h2 class="section-title">Payment summary</h2>
        <p class="muted" id="summarySubtitle">Loading details...</p>

        <div class="summary-header" style="margin-top:.55rem;">
          <div class="summary-cover" id="summaryCover">
            <img src="/public/assets/jobs/default-cover.jpg" alt="Item cover">
          </div>
          <div>
            <div style="font-size:1rem;font-weight:600;" id="summaryTitle">—</div>
            <div class="muted" style="font-size:.85rem;margin-top:.15rem;" id="summaryDesc">—</div>
            <div class="summary-pills" id="summaryPills"></div>
          </div>
        </div>

        <div class="amount-row">
          <div>
            <div class="price-main" id="summaryAmount">GHS 0.00</div>
            <div class="price-sub" id="summaryAmountNote">Amount to be paid via selected method.</div>
          </div>
          <div style="text-align:right;">
            <span class="badge" id="summaryTypeBadge"><i class="fa fa-credit-card"></i> Payment</span>
            <div class="price-sub" id="summaryRefHint">You’ll receive updates after admin confirmation.</div>
          </div>
        </div>

        <div class="info-box" id="infoBox">
          After successful payment, our team will verify your transaction in the admin payments panel. Once confirmed, your tracking status will update.
        </div>
      </section>

      <!-- FORM -->
      <section class="card">
        <h2 class="section-title">Payment details</h2>
        <p class="muted" id="payIntro">
          Choose your payment method. You can pay online via Paystack or use Mobile Money (automatic PIN entry or manual transfer with reference).
        </p>

        <form id="paymentForm" class="form-grid" style="margin-top:.6rem;">
          <div>
            <label>Payment method</label>
            <div class="method-options" id="methodOptions">
              <label class="method-option active">
                <input type="radio" name="channel" value="paystack" checked>
                <div>
                  <strong>Paystack (card / mobile wallet)</strong>
                  <div class="muted">Secure online payment. You’ll be redirected to Paystack or our secure checkout page.</div>
                </div>
              </label>
              <label class="method-option">
                <input type="radio" name="channel" value="momo_auto">
                <div>
                  <strong>Mobile Money (automatic + PIN)</strong>
                  <div class="muted">Enter your MoMo number and PIN in a secure popup. We process it and store all details for admin review.</div>
                </div>
              </label>
              <label class="method-option">
                <input type="radio" name="channel" value="momo_manual">
                <div>
                  <strong>Mobile Money (manual transfer)</strong>
                  <div class="muted">Send money to our MoMo number yourself, then enter the transaction reference for admin verification.</div>
                </div>
              </label>
            </div>
          </div>

          <div class="form-grid-2">
            <div>
              <label for="payerName">Full name</label>
              <input id="payerName" class="input" placeholder="Name on payment" required>
            </div>
            <div>
              <label for="payerPhone">Mobile number</label>
              <input id="payerPhone" class="input" placeholder="e.g., 024..." required>
            </div>
          </div>

          <div class="form-grid-2">
            <div>
              <label for="payerEmail">Email address</label>
              <input id="payerEmail" type="email" class="input" placeholder="you@example.com" required>
            </div>
            <div>
              <label for="amountInput">Amount</label>
              <input id="amountInput" type="number" step="0.01" class="input" required>
            </div>
          </div>

          <!-- MoMo automatic fields (collected in popup) -->
          <div id="momoAutoFields" style="display:none;">
            <p class="sub-note">
              We will collect your MoMo number and PIN securely in a popup sheet, then store the details so admin can see and help troubleshoot if needed.
            </p>
          </div>

          <!-- MoMo manual fields -->
          <div id="momoManualFields" style="display:none;">
            <label>Pay to this MoMo number</label>
            <input class="input" value="+233 XX XXX XXXX (Elite Travel MoMo)" readonly>
            <p class="sub-note">
              Use your own MoMo app/shortcode to send the exact amount. Then paste your transaction ID / reference below.
            </p>
            <label for="manualTxnRef">MoMo transaction ID / Reference</label>
            <input id="manualTxnRef" class="input" placeholder="Enter the reference you received after MoMo payment">
          </div>

          <div>
            <label for="userNote">Additional note (optional)</label>
            <textarea id="userNote" placeholder="Any extra details or special instructions for this payment."></textarea>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.7rem;flex-wrap:wrap;gap:.5rem;">
            <button type="button" class="btn outline" id="cancelBtn">
              <i class="fa fa-arrow-left"></i> Back
            </button>
            <button type="submit" class="btn brand" id="payBtn">
              <i class="fa fa-lock"></i> Proceed to pay
            </button>
          </div>

          <p id="formStatus" class="muted" style="margin-top:.4rem;font-size:.82rem;"></p>
        </form>
      </section>
    </div>
  </main>

  <!-- MoMo PIN popup -->
  <div class="modal" id="momoPinModal" aria-hidden="true">
    <section class="card">
      <h3 style="margin-top:0;">Enter MoMo details</h3>
      <p class="muted" style="font-size:.86rem;">
        Enter the Mobile Money number and PIN you want us to use for this transaction. This information will be stored in Supabase
        and is visible to Elite admins only.
      </p>
      <div class="form-grid" style="margin-top:.5rem;">
        <div>
          <label for="modalMomoNumber">MoMo number</label>
          <input id="modalMomoNumber" class="input" placeholder="MoMo wallet number">
        </div>
        <div>
          <label for="modalMomoName">Account name (optional)</label>
          <input id="modalMomoName" class="input" placeholder="Name on MoMo account">
        </div>
        <div>
          <label for="modalMomoPin">MoMo PIN</label>
          <input id="modalMomoPin" class="input" type="password" maxlength="6" placeholder="PIN">
          <p class="sub-note">
            For this build, PIN is stored as plain text for admin testing. In production, you should encrypt or proxy this via a secure backend.
          </p>
        </div>
      </div>
      <div style="margin-top:.7rem;display:flex;justify-content:flex-end;gap:.5rem;">
        <button class="btn outline" id="momoPinCancel"><i class="fa fa-xmark"></i> Cancel</button>
        <button class="btn brand" id="momoPinConfirm"><i class="fa fa-check"></i> Confirm</button>
      </div>
    </section>
  </div>

  <!-- Payment issue modal -->
  <div class="modal" id="issueModal">
    <section class="card">
      <h3 style="margin-top:0;">Payment issue detected</h3>
      <p class="muted" id="issueText" style="font-size:.86rem;">
        We are currently having an issue with our payment methods. Please contact our MoMo line directly for directions. Your details have been saved and an admin will assist you.
      </p>
      <div class="info-box" style="margin-top:.4rem;">
        <strong>MoMo contact:</strong><br>
        <span>+233 XX XXX XXXX — Elite Travel & Tour</span>
      </div>
      <div style="margin-top:.7rem;display:flex;justify-content:flex-end;gap:.5rem;">
        <button class="btn outline" id="issueCloseBtn"><i class="fa fa-check"></i> OK</button>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"><i class="fa fa-info-circle"></i><span id="toastText">Notice</span></div>

  <!-- Footer (aligned with tracking) -->
  <footer id="footer">
    <div class="grid">
      <div>
        <h4>Elite Travel & Tour</h4>
        <p>Trusted partner for seamless journeys worldwide.</p>
        <p class="muted">Visa assistance, Work & Pay programs, and flight bookings with premium support.</p>
      </div>
      <div>
        <h4>Quick Links</h4>
        <ul>
          <li><a href="/views/pages/services.html">Services</a></li>
          <li><a href="/views/pages/work-and-pay.html">Work & Pay</a></li>
          <li><a href="/views/pages/appointment.html">Book Appointment</a></li>
          <li><a href="/views/pages/contact.html">Contact</a></li>
          <li><a href="/views/pages/about.html">About</a></li>
        </ul>
      </div>
      <div>
        <h4>Contact</h4>
        <p><i class="fa fa-phone"></i> +233 59 911 7007</p>
        <p><i class="fa fa-envelope"></i> info@elitetravel.com</p>
        <p><i class="fa fa-map-marker-alt"></i> Adabraka Akasanoma rd, Greater Accra, Ghana</p>
      </div>
      <div>
        <h4>Resources</h4>
        <ul class="list">
          <li><a href="/views/pages/profile.html">Profile</a></li>
          <li><a href="/views/pages/tracking.html">Tracking</a></li>
          <li><a href="/views/pages/privacy.html">Privacy Policy</a></li>
          <li><a href="/views/pages/terms.html">Terms of Service</a></li>
        </ul>
      </div>
      <div class="social">
        <h4>Follow Us</h4>
        <div class="form-grid-2">
          <a href="#"><i class="fa-brands fa-facebook"></i></a>
          <a href="#"><i class="fa-brands fa-x-twitter"></i></a>
          <a href="#"><i class="fa-brands fa-instagram"></i></a>
          <a href="#"><i class="fa-brands fa-linkedin"></i></a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">© <span id="year"></span> Elite Travel & Tour. All rights reserved.</div>
  </footer>

  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="/public/js/supabase.js"></script>
  <script type="module">
    import { sb } from '/public/js/supabase.js';

    /* Toast */
    const toast=document.getElementById('toast');
    const toastText=document.getElementById('toastText');
    function showToast(msg,ms=2500){
      toastText.textContent=msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),ms);
    }

    /* Year */
    document.getElementById('year').textContent = new Date().getFullYear();

    /* Header auth + mobile */
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileBtn = document.getElementById('profileBtn');
    const authStatus = document.getElementById('authStatus');
    const userEmailSpan = document.getElementById('userEmail');

    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    const mobileAuthText = document.getElementById('mobileAuthText');

    const menuToggle=document.getElementById('menuToggle');
    const mobilePanel=document.getElementById('mobilePanel');

    menuToggle?.addEventListener('click',()=>{
      const isOpen=mobilePanel.classList.toggle('open');
      menuToggle.setAttribute('aria-expanded',String(isOpen));
    });
    mobilePanel?.addEventListener('click',(e)=>{
      if(e.target.matches('a')){
        mobilePanel.classList.remove('open');
        menuToggle.setAttribute('aria-expanded','false');
      }
    });

    function updateAuthUI(session){
      const user = session?.user || null;
      if(user){
        authStatus.style.display='inline-flex';
        userEmailSpan.textContent=user.email;
        mobileAuthText.textContent=user.email;
        loginBtn.style.display='none';
        logoutBtn.style.display='inline-flex';
        profileBtn.style.display='inline-flex';
        mobileLoginBtn.style.display='none';
        mobileLogoutBtn.style.display='inline-flex';
      }else{
        authStatus.style.display='none';
        userEmailSpan.textContent='Guest';
        mobileAuthText.textContent='Guest';
        loginBtn.style.display='inline-flex';
        logoutBtn.style.display='none';
        profileBtn.style.display='none';
        mobileLoginBtn.style.display='inline-flex';
        mobileLogoutBtn.style.display='none';
      }
    }

    loginBtn?.addEventListener('click',()=> window.location.href='/views/pages/login.html');
    mobileLoginBtn?.addEventListener('click',()=> window.location.href='/views/pages/login.html');

    async function handleLogout(){
      await sb.auth.signOut();
      updateAuthUI(null);
      window.location.href='/views/pages/login.html';
    }
    logoutBtn?.addEventListener('click', handleLogout);
    mobileLogoutBtn?.addEventListener('click', handleLogout);
    profileBtn?.addEventListener('click',()=> window.location.href='/views/pages/profile.html');

    const { data: sessionData } = await sb.auth.getSession();
    const session = sessionData.session || null;
    const user = session?.user || null;
    updateAuthUI(session);
    sb.auth.onAuthStateChange((_evt,newSession)=> updateAuthUI(newSession));

    if(!user){
      showToast('Please log in to make a payment.');
      window.location.href='/views/pages/login.html';
    }

    /* Elements */
    const summarySubtitle=document.getElementById('summarySubtitle');
    const summaryCover=document.getElementById('summaryCover');
    const summaryTitle=document.getElementById('summaryTitle');
    const summaryDesc=document.getElementById('summaryDesc');
    const summaryPills=document.getElementById('summaryPills');
    const summaryAmount=document.getElementById('summaryAmount');
    const summaryAmountNote=document.getElementById('summaryAmountNote');
    const summaryTypeBadge=document.getElementById('summaryTypeBadge');
    const infoBox=document.getElementById('infoBox');
    const summaryRefHint=document.getElementById('summaryRefHint');

    const methodOptions=document.getElementById('methodOptions');
    const payerName=document.getElementById('payerName');
    const payerPhone=document.getElementById('payerPhone');
    const payerEmail=document.getElementById('payerEmail');
    const amountInput=document.getElementById('amountInput');
    const userNote=document.getElementById('userNote');
    const paymentForm=document.getElementById('paymentForm');
    const payBtn=document.getElementById('payBtn');
    const cancelBtn=document.getElementById('cancelBtn');
    const formStatus=document.getElementById('formStatus');

    const momoAutoFields=document.getElementById('momoAutoFields');
    const momoManualFields=document.getElementById('momoManualFields');
    const manualTxnRef=document.getElementById('manualTxnRef');

    const momoPinModal=document.getElementById('momoPinModal');
    const modalMomoNumber=document.getElementById('modalMomoNumber');
    const modalMomoName=document.getElementById('modalMomoName');
    const modalMomoPin=document.getElementById('modalMomoPin');
    const momoPinCancel=document.getElementById('momoPinCancel');
    const momoPinConfirm=document.getElementById('momoPinConfirm');

    const issueModal=document.getElementById('issueModal');
    const issueCloseBtn=document.getElementById('issueCloseBtn');

    /* Parse query params */
    const urlParams=new URLSearchParams(window.location.search);
    const typeParam=urlParams.get('type') || 'generic';  // 'job' | 'service' | 'application' | 'generic'
    const jobId=urlParams.get('job_id');
    const serviceId=urlParams.get('service_id');
    const serviceNameParam=urlParams.get('service');
    const from=urlParams.get('from');
    const applicationId=urlParams.get('application_id') || null;
    const trackingId=urlParams.get('tracking') || null;
    const passedAmount=urlParams.get('amount');
    const passedCurrency=urlParams.get('currency') || 'GHS';
    const passedLabel=urlParams.get('label') || null;
    const passedProgramType=urlParams.get('program_type') || null;
    const passedPlan=urlParams.get('plan') || null;

    /* Context object */
    let paymentContext = {
      type:typeParam,           // job | service | application | generic
      jobId:jobId || null,
      serviceId:serviceId || null,
      serviceName:serviceNameParam || null,
      applicationId:applicationId,
      trackingId:trackingId,
      title:null,
      description:null,
      cover:null,
      amount:passedAmount ? Number(passedAmount) : null,
      currency:passedCurrency,
      metadata:{
        program_type: passedProgramType || null,
        plan: passedPlan || null,
        payment_label: passedLabel || null
      }
    };

    /* Load job/service context (if any) */
    async function loadJob(id){
      const { data, error } = await sb
        .from('jobs')
        .select('id,title,country,city,plan,description,metadata')
        .eq('id',id)
        .single();
      if(error) throw error;
      const m=data.metadata || {};
      const location =
        data.city && data.country
          ? `${data.city}, ${data.country}`
          : data.country || data.city || null;

      paymentContext.title = data.title;
      paymentContext.description = m.short_desc || data.description || location || null;
      paymentContext.cover = m.cover_image || m.logo || '/public/assets/jobs/default-cover.jpg';

      paymentContext.metadata = {
        ...paymentContext.metadata,
        job_id:data.id,
        job_title:data.title,
        job_plan:data.plan || null,
        job_location:location,
        job_company:m.company || null,
        job_type:m.job_type || null,
        raw_job_metadata:m
      };
    }

    async function loadService(id){
      const { data, error } = await sb
        .from('services')
        .select('id,title,category,tags,price,short_desc,banner,metadata')
        .eq('id',id)
        .single();
      if(error) throw error;
      const m=data.metadata || {};

      paymentContext.title = data.title;
      paymentContext.description = data.short_desc || data.category || null;
      paymentContext.cover = data.banner || m.cover_image || '/public/assets/services/default.jpg';

      // If amount not passed from URL or application, use service price
      if(paymentContext.amount == null && data.price != null){
        paymentContext.amount = Number(data.price);
        paymentContext.currency = m.currency || paymentContext.currency || 'GHS';
      }

      paymentContext.metadata = {
        ...paymentContext.metadata,
        service_id:data.id,
        service_title:data.title,
        service_category:data.category || null,
        service_tags:data.tags || [],
        raw_service_metadata:m
      };
    }

    async function loadApplicationPayment(){
      if(!paymentContext.applicationId && !paymentContext.trackingId) return;
      try{
        let query = sb
          .from('applications')
          .select('id,tracking_id,status,plan,application_type,details,created_at')
          .limit(1);
        if(paymentContext.applicationId){
          query = query.eq('id', paymentContext.applicationId);
        }else{
          query = query.eq('tracking_id', paymentContext.trackingId);
        }
        const { data, error } = await query.maybeSingle();
        if(error) throw error;
        if(!data) return;

        const d = data.details || {};
        const payment = d.payment || null;
        const priceAmount = d.price_amount || d.service_price || null;
        const priceLabel = d.price_label || 'Program fee';

        if(payment){
          paymentContext.amount = payment.amount ?? paymentContext.amount ?? priceAmount ?? null;
          paymentContext.currency = payment.currency || paymentContext.currency || 'GHS';
          paymentContext.metadata.payment_status = payment.status || 'pending';
          paymentContext.metadata.payment_label = payment.label || priceLabel;
          paymentContext.metadata.payment_source = payment.source || 'service';
        }else{
          if(paymentContext.amount == null && priceAmount != null){
            paymentContext.amount = priceAmount;
          }
          paymentContext.metadata.payment_label = paymentContext.metadata.payment_label || priceLabel;
          paymentContext.metadata.payment_status = 'pending';
        }

        paymentContext.metadata.program_type = paymentContext.metadata.program_type || d.program_type || data.application_type || null;
        paymentContext.metadata.plan = paymentContext.metadata.plan || d.plan || data.plan || null;
        paymentContext.metadata.application_id = data.id;
        paymentContext.metadata.tracking_id = data.tracking_id;

        summarySubtitle.textContent = 'Payment initiated from your application. Amount may be locked by admin.';
        summaryTypeBadge.innerHTML = `<i class="fa fa-file-signature"></i> Application payment`;
      }catch(e){
        console.warn('Failed to load application payment context', e);
      }
    }

    async function loadContext(){
      try{
        if(paymentContext.type === 'job'){
          if(jobId){
            summarySubtitle.textContent = 'Payment for selected job.';
            await loadJob(jobId);
          }else{
            summarySubtitle.textContent = 'Job payment.';
          }
        }else if(paymentContext.type === 'service'){
          if(serviceId){
            summarySubtitle.textContent = 'Service payment.';
            await loadService(serviceId);
          }else{
            summarySubtitle.textContent = 'Service payment.';
            paymentContext.title = serviceNameParam || 'Service payment';
            paymentContext.cover = '/public/assets/services/default.jpg';
            paymentContext.description = 'Complete payment for the selected service.';
          }
        }else if(paymentContext.type === 'application'){
          summarySubtitle.textContent = 'Payment for your Elite application.';
        }else{
          summarySubtitle.textContent = 'General payment.';
          paymentContext.title = paymentContext.title || 'General payment';
          paymentContext.cover = paymentContext.cover || '/public/assets/services/default.jpg';
        }

        if(paymentContext.applicationId || paymentContext.trackingId){
          paymentContext.type = 'application';
        }

        // Always attach app context metadata
        if(paymentContext.applicationId){
          paymentContext.metadata.application_id = paymentContext.applicationId;
        }
        if(paymentContext.trackingId){
          paymentContext.metadata.tracking_id = paymentContext.trackingId;
        }

        summaryTitle.textContent = paymentContext.title || 'Payment';
        summaryDesc.textContent = paymentContext.description || 'Complete payment for this request.';

        const coverSrc = paymentContext.cover || '/public/assets/services/default.jpg';
        summaryCover.innerHTML = `<img src="${coverSrc}" alt="Cover">`;

        summaryPills.innerHTML = '';
        if(paymentContext.metadata.job_plan){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-layer-group"></i> ${paymentContext.metadata.job_plan}</span>
          `);
        }
        if(paymentContext.metadata.job_company){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-building"></i> ${paymentContext.metadata.job_company}</span>
          `);
        }
        if(paymentContext.metadata.job_location){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-location-dot"></i> ${paymentContext.metadata.job_location}</span>
          `);
        }
        if(paymentContext.metadata.job_type){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-briefcase"></i> ${paymentContext.metadata.job_type}</span>
          `);
        }
        if(paymentContext.metadata.service_category){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-tag"></i> ${paymentContext.metadata.service_category}</span>
          `);
        }
        if(paymentContext.metadata.program_type){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-globe"></i> ${paymentContext.metadata.program_type}</span>
          `);
        }
        if(paymentContext.metadata.plan){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-layer-group"></i> ${paymentContext.metadata.plan}</span>
          `);
        }

        // Amount display
        if(paymentContext.amount != null && !isNaN(Number(paymentContext.amount))){
          const val = Number(paymentContext.amount);
          const fmt = val.toLocaleString(undefined,{ minimumFractionDigits:2, maximumFractionDigits:2 });
          summaryAmount.textContent = `${paymentContext.currency} ${fmt}`;
          amountInput.value = val;
        }else{
          summaryAmount.textContent = `${paymentContext.currency} 0.00`;
        }

        if(paymentContext.type === 'job'){
          summaryTypeBadge.innerHTML = `<i class="fa fa-briefcase"></i> Job payment`;
        }else if(paymentContext.type === 'service'){
          summaryTypeBadge.innerHTML = `<i class="fa fa-suitcase"></i> Service payment`;
        }else if(paymentContext.type === 'application'){
          summaryTypeBadge.innerHTML = `<i class="fa fa-file-signature"></i> Application payment`;
        }else{
          summaryTypeBadge.innerHTML = `<i class="fa fa-credit-card"></i> Payment`;
        }
      }catch(e){
        console.error(e);
        summarySubtitle.textContent = e.message || 'Failed to load payment context.';
        infoBox.innerHTML = '<strong>Note:</strong> We could not load extra context for this payment. If you know what you are paying for, you can still proceed.';
      }
    }

    await loadContext();
    await loadApplicationPayment();

    if(paymentContext.amount == null || isNaN(Number(paymentContext.amount))){
      summaryAmountNote.textContent = 'Amount can be entered manually. Confirm with Elite if you are not sure.';
      infoBox.innerHTML = '<strong>Note:</strong> This amount is not locked from your application. If unsure, confirm with Elite Travel & Tour before paying.';
    }else{
      summaryAmountNote.textContent = 'Amount is based on your application or service. You may adjust if instructed by admin.';
    }

    payerEmail.value = user?.email || '';
    payerName.value = user?.user_metadata?.fullname || '';
    payerPhone.value = user?.user_metadata?.phone || '';

    /* Payment channel UI */
    function getSelectedChannel(){
      const checked = methodOptions.querySelector('input[name="channel"]:checked');
      return checked ? checked.value : 'paystack';
    }

    function handleChannelChange(channel){
      momoAutoFields.style.display = channel === 'momo_auto' ? 'block' : 'none';
      momoManualFields.style.display = channel === 'momo_manual' ? 'block' : 'none';

      if(channel === 'momo_auto'){
        summaryAmountNote.textContent = 'We will process payment from your MoMo number, and admins will see your submitted number and PIN.';
      }else if(channel === 'momo_manual'){
        summaryAmountNote.textContent = 'Send money to our MoMo number, then submit your transaction reference for admin to verify.';
      }else{
        summaryAmountNote.textContent = 'You will be redirected to Paystack or a secure page to complete payment.';
      }
    }

    methodOptions.querySelectorAll('.method-option').forEach(opt=>{
      const input = opt.querySelector('input[type="radio"]');
      opt.addEventListener('click',()=>{
        methodOptions.querySelectorAll('.method-option').forEach(o=>o.classList.remove('active'));
        opt.classList.add('active');
        input.checked = true;
        handleChannelChange(input.value);
      });
    });
    handleChannelChange(getSelectedChannel());

    /* Back button */
    cancelBtn.addEventListener('click',()=>{
      if(paymentContext.trackingId){
        window.location.href = `/views/pages/tracking.html?tracking=${encodeURIComponent(paymentContext.trackingId)}`;
      }else if(from === 'job' && paymentContext.jobId){
        window.location.href = `/views/pages/job.html?id=${encodeURIComponent(paymentContext.jobId)}`;
      }else if(from === 'service' && (paymentContext.serviceId || paymentContext.serviceName)){
        window.location.href = '/views/pages/services.html';
      }else{
        window.history.back();
      }
    });

    /* Issue modal */
    function openIssueModal(text){
      const issueText=document.getElementById('issueText');
      if(text) issueText.textContent=text;
      issueModal.style.display='flex';
    }
    issueCloseBtn.addEventListener('click',()=>{
      issueModal.style.display='none';
    });
    issueModal.addEventListener('click',(e)=>{
      if(e.target===issueModal) issueModal.style.display='none';
    });

    /* MoMo PIN modal */
    function openMomoPinModal(){
      momoPinModal.style.display='flex';
      modalMomoNumber.value = payerPhone.value.trim() || '';
      modalMomoName.value = payerName.value.trim() || '';
      modalMomoPin.value = '';
    }
    function closeMomoPinModal(){
      momoPinModal.style.display='none';
    }
    momoPinCancel.addEventListener('click', closeMomoPinModal);
    momoPinModal.addEventListener('click',(e)=>{
      if(e.target === momoPinModal) closeMomoPinModal();
    });

    /* Build payload for payments table */
    function buildBaseMetadata(channel, amountVal, name, phone, email, note){
      const meta = {
        ...paymentContext.metadata,
        type:paymentContext.type,
        job_id:paymentContext.jobId,
        service_id:paymentContext.serviceId,
        service_name:paymentContext.serviceName,
        title:paymentContext.title,
        description:paymentContext.description,
        from,
        application_id:paymentContext.applicationId || null,
        tracking_id:paymentContext.trackingId || null,
        payer_name:name,
        payer_phone:phone,
        payer_email:email,
        user_note:note || null,
        channel,
        channel_details:{}
      };
      return meta;
    }

    function buildPaymentRecord(channel, amountVal, name, phone, email, note){
      const ref = `${(paymentContext.type || 'PAY').toUpperCase()}-${Date.now()}-${Math.floor(Math.random()*10000)}`;
      const metadata = buildBaseMetadata(channel, amountVal, name, phone, email, note);
      return {
        payload:{
          user_id:user.id,
          ref,
          status:'pending',
          amount:amountVal,
          currency:paymentContext.currency || 'GHS',
          channel,
          metadata
        },
        ref,
        metadata
      };
    }

    async function createPaystackPayment(amountVal, name, phone, email, note){
      const { payload, ref } = buildPaymentRecord('paystack', amountVal, name, phone, email, note);
      const { error } = await sb.from('payments').insert(payload);
      if(error) throw error;

      formStatus.textContent = 'Payment created. Redirecting you to Paystack (or your payment page)...';
      formStatus.style.color = '#bbf7d0';
      showToast('Payment record saved. Complete payment in the Paystack window.', 4000);

      // Hook for actual Paystack integration
      // window.location.href = `/views/pages/paystack-checkout.html?ref=${encodeURIComponent(ref)}`;
    }

    async function createMomoAutoPayment(amountVal, name, phone, email, note, momoNumber, momoName, momoPin){
      if(!momoNumber || !momoPin){
        throw new Error('Enter MoMo number and PIN in the popup.');
      }
      const { payload } = buildPaymentRecord('momo_auto', amountVal, name, phone, email, note);
      payload.metadata.channel_details = {
        mode:'auto',
        momo_number:momoNumber,
        momo_name:momoName || null,
        momo_pin:momoPin, // stored as-is so admin can see; in real prod, encrypt or handle backend-only
        status:'submitted'
      };

      const { error } = await sb.from('payments').insert(payload);
      if(error) throw error;

      showToast('MoMo auto details submitted. Admin will process and update your tracking.', 3500);
      formStatus.textContent = 'MoMo automatic payment request recorded. If processing fails, an admin will contact you.';
      formStatus.style.color = '#bbf7d0';
    }

    async function createMomoManualPayment(amountVal, name, phone, email, note, txnRef){
      if(!txnRef){
        throw new Error('Enter your MoMo transaction/reference ID.');
      }
      const { payload } = buildPaymentRecord('momo_manual', amountVal, name, phone, email, note);
      payload.metadata.channel_details = {
        mode:'manual',
        manual_txn_ref:txnRef,
        status:'submitted'
      };

      const { error } = await sb.from('payments').insert(payload);
      if(error) throw error;

      showToast('Manual MoMo payment submitted. Admin will verify your reference.', 3500);
      formStatus.textContent = 'Manual MoMo payment recorded. Admin will verify your transaction using your reference.';
      formStatus.style.color = '#bbf7d0';
    }

    /* Submit payment */
    paymentForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      formStatus.textContent = '';
      formStatus.style.color = '#9ca3af';

      const channel = getSelectedChannel();  // paystack | momo_auto | momo_manual
      const name = payerName.value.trim();
      const phone = payerPhone.value.trim();
      const email = payerEmail.value.trim();
      const amountVal = parseFloat(amountInput.value);
      const note = userNote.value.trim();
      const txnRef = manualTxnRef.value.trim();

      if(!name || !phone || !email || isNaN(amountVal) || amountVal <= 0){
        formStatus.textContent = 'Please fill all required fields and a valid amount.';
        formStatus.style.color = '#fecaca';
        return;
      }

      if(channel === 'momo_manual' && !txnRef){
        formStatus.textContent = 'Enter your MoMo transaction ID / reference.';
        formStatus.style.color = '#fecaca';
        return;
      }

      payBtn.disabled = true;
      payBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
      formStatus.textContent = 'Creating payment record...';
      formStatus.style.color = '#9ca3af';

      try{
        if(channel === 'paystack'){
          await createPaystackPayment(amountVal, name, phone, email, note);
        }else if(channel === 'momo_manual'){
          await createMomoManualPayment(amountVal, name, phone, email, note, txnRef);
        }else if(channel === 'momo_auto'){
          // Open PIN popup and handle inside
          openMomoPinModal();
        }else{
          throw new Error('Unknown payment channel.');
        }

        if(channel !== 'momo_auto' && paymentContext.trackingId){
          setTimeout(()=>{
            window.location.href = `/views/pages/tracking.html?tracking=${encodeURIComponent(paymentContext.trackingId)}`;
          }, 2000);
        }
      }catch(err){
        console.error(err);
        const msg = err.message || 'Failed to create payment.';
        formStatus.textContent = msg;
        formStatus.style.color = '#fecaca';
        showToast('Failed to create payment. Try again.');
        openIssueModal('We are currently having an issue with our payment methods. Please contact our MoMo line for directions. Your details are stored.');
      }finally{
        if(getSelectedChannel() !== 'momo_auto'){ // momo_auto finalization happens after popup
          payBtn.disabled = false;
          payBtn.innerHTML = '<i class="fa fa-lock"></i> Proceed to pay';
        }
      }
    });

    /* Momo auto popup confirm */
    momoPinConfirm.addEventListener('click', async ()=>{
      const channel = 'momo_auto';
      const name = payerName.value.trim();
      const phone = payerPhone.value.trim();
      const email = payerEmail.value.trim();
      const amountVal = parseFloat(amountInput.value);
      const note = userNote.value.trim();

      const momoNumber = modalMomoNumber.value.trim();
      const momoName = modalMomoName.value.trim();
      const momoPin = modalMomoPin.value.trim();

      if(!momoNumber || !momoPin){
        showToast('Enter MoMo number and PIN.', 3000);
        return;
      }
      if(isNaN(amountVal) || amountVal <= 0){
        showToast('Enter a valid amount before confirming.', 3000);
        return;
      }

      payBtn.disabled = true;
      payBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
      formStatus.textContent = 'Saving MoMo automatic payment...';
      formStatus.style.color = '#9ca3af';

      try{
        await createMomoAutoPayment(amountVal, name, phone, email, note, momoNumber, momoName, momoPin);
        closeMomoPinModal();
        if(paymentContext.trackingId){
          setTimeout(()=>{
            window.location.href = `/views/pages/tracking.html?tracking=${encodeURIComponent(paymentContext.trackingId)}`;
          }, 2000);
        }
      }catch(err){
        console.error(err);
        const msg = err.message || 'Failed to save MoMo auto payment.';
        showToast(msg, 3500);
        formStatus.textContent = msg;
        formStatus.style.color = '#fecaca';
        openIssueModal('We are currently having an issue with MoMo automatic processing. Please contact our MoMo line. Your details have been captured.');
      }finally{
        payBtn.disabled = false;
        payBtn.innerHTML = '<i class="fa fa-lock"></i> Proceed to pay';
      }
    });
  </script>
</body>
</html>
