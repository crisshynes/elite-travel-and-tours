<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Elite Travel & Tour — Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Secure payment portal for Elite Travel & Tour — jobs, services, and express processing."/>
  <link rel="stylesheet" href="/public/css/base.css">
  <link rel="stylesheet" href="/public/css/layout.css">
  <link rel="stylesheet" href="/public/css/components.css">
  <link rel="stylesheet" href="/public/css/pages.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    main.payment-main{
      max-width:960px;
      margin:1.5rem auto;
      padding:0 1rem 2.5rem;
    }
    .payment-layout{
      display:grid;
      grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
      gap:1rem;
    }
    @media(max-width:900px){
      .payment-layout{
        grid-template-columns: 1fr;
      }
    }
    .card{
      background:#020617;
      border-radius:14px;
      border:1px solid rgba(31,41,55,.9);
      box-shadow:0 24px 60px rgba(15,23,42,.7);
      padding:1rem;
    }
    .section-title{
      font-size:1.2rem;
      margin-bottom:.35rem;
    }
    .muted{ color:#64748b; }

    .summary-header{
      display:flex;
      gap:.75rem;
      align-items:flex-start;
    }
    .summary-cover{
      width:88px;
      height:88px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(31,41,55,.9);
      background:#020617;
      flex-shrink:0;
    }
    .summary-cover img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .summary-pills{
      display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.35rem;
    }
    .pill{
      padding:.15rem .55rem;
      border-radius:999px;
      font-size:.78rem;
      border:1px solid rgba(148,163,184,.7);
      background:#020617;
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:.3rem;
    }

    .amount-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:.6rem;
      padding-top:.6rem;
      border-top:1px dashed rgba(55,65,81,.9);
    }
    .price-main{
      font-size:1.4rem;
      font-weight:700;
      color:#e5e7eb;
    }
    .price-sub{
      font-size:.82rem;
      color:#9ca3af;
    }

    .badge{
      display:inline-flex; align-items:center; gap:.3rem;
      padding:.12rem .5rem; border-radius:999px;
      font-size:.75rem;
      background:rgba(15,118,110,.15);
      border:1px solid rgba(20,184,166,.7);
      color:#ccfbf1;
    }

    .form-grid{
      display:grid;
      gap:.7rem;
    }
    .form-grid-2{
      display:grid;
      gap:.7rem;
      grid-template-columns:repeat(2,minmax(0,1fr));
    }
    @media(max-width:700px){
      .form-grid-2{
        grid-template-columns:1fr;
      }
    }

    label{
      display:block;
      font-size:.84rem;
      color:#9ca3af;
      margin-bottom:.2rem;
    }
    .input, textarea, select{
      width:100%;
      box-sizing:border-box;
      padding:.55rem .7rem;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.7);
      background:#020617;
      font-size:.9rem;
      color:#e5e7eb;
      transition:border-color .12s, box-shadow .12s, background .12s;
    }
    .input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:#38bdf8;
      box-shadow:0 0 0 2px rgba(56,189,248,.35);
      background:#020617;
    }
    textarea{ min-height:80px; resize:vertical; }

    .method-options{
      display:flex;
      flex-direction:column;
      gap:.35rem;
    }
    .method-option{
      display:flex;
      align-items:flex-start;
      gap:.5rem;
      padding:.45rem .6rem;
      border-radius:10px;
      border:1px solid rgba(55,65,81,.9);
      background:#020617;
      cursor:pointer;
    }
    .method-option input{
      margin-top:.2rem;
    }
    .method-option.active{
      border-color:#38bdf8;
      box-shadow:0 0 0 1px rgba(56,189,248,.4);
    }
    .method-option strong{
      font-size:.9rem;
    }
    .method-option .muted{ font-size:.8rem; }

    .btn{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.55rem .95rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:.9rem;
      text-decoration:none;
      transition:all .15s ease-out;
    }
    .btn.brand{
      background:#0077cc;
      color:#f9fafb;
      box-shadow:0 10px 26px rgba(37,99,235,.4);
    }
    .btn.brand:hover{
      background:#0060a3;
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(37,99,235,.55);
    }
    .btn.outline{
      background:transparent;
      color:#e5e7eb;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
    }
    .btn.outline:hover{
      border-color:#38bdf8;
      color:#38bdf8;
      background:rgba(15,23,42,.7);
    }
    .btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .toast{
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:#020617; color:#e5e7eb; padding:.75rem 1rem; border-radius:999px;
      box-shadow:0 16px 40px rgba(15,23,42,.85); z-index:2000; display:none; max-width:90vw;
      font-size:.9rem;
    }
    .toast.show{ display:flex; align-items:center; gap:.6rem; }
    .toast i{ color:#38bdf8; }

    .info-box{
      font-size:.8rem;
      color:#9ca3af;
      border-radius:10px;
      border:1px dashed rgba(148,163,184,.6);
      padding:.45rem .55rem;
      margin-top:.5rem;
    }
  </style>
</head>
<body>
  <!-- Minimal header (you can swap in full navbar if you want) -->
  <header class="card" style="max-width:960px;margin:1rem auto .5rem;padding:.7rem 1rem;display:flex;justify-content:space-between;align-items:center;gap:.75rem;">
    <a href="/views/pages/index.html" style="display:flex;align-items:center;gap:.4rem;color:#e5e7eb;text-decoration:none;font-weight:700;">
      <i class="fa-solid fa-compass"></i> <span>Elite Travel & Tour</span>
    </a>
    <span id="userEmail" class="muted" style="font-size:.8rem;">Guest</span>
  </header>

  <main class="payment-main">
    <div class="payment-layout">
      <!-- SUMMARY -->
      <section class="card" id="summaryCard">
        <h2 class="section-title">Payment summary</h2>
        <p class="muted" id="summarySubtitle">Loading details...</p>

        <div class="summary-header" style="margin-top:.55rem;">
          <div class="summary-cover" id="summaryCover">
            <img src="/public/assets/jobs/default-cover.jpg" alt="Item cover">
          </div>
          <div>
            <div style="font-size:1rem;font-weight:600;" id="summaryTitle">—</div>
            <div class="muted" style="font-size:.85rem;margin-top:.15rem;" id="summaryDesc">—</div>
            <div class="summary-pills" id="summaryPills"></div>
          </div>
        </div>

        <div class="amount-row">
          <div>
            <div class="price-main" id="summaryAmount">GHS 0.00</div>
            <div class="price-sub" id="summaryAmountNote">Amount to be paid via selected method.</div>
          </div>
          <div style="text-align:right;">
            <span class="badge" id="summaryTypeBadge"><i class="fa fa-credit-card"></i> Payment</span>
            <div class="price-sub" id="summaryRefHint">You’ll receive tracking after admin confirmation.</div>
          </div>
        </div>

        <div class="info-box" id="infoBox">
          After successful payment, our team will verify your transaction in the admin payments panel. Once confirmed, your status will be updated to <strong>paid</strong>, a tracking ID will be generated, and you’ll receive an in‑app notification.
        </div>
      </section>

      <!-- FORM -->
      <section class="card">
        <h2 class="section-title">Payment details</h2>
        <p class="muted" id="payIntro">
          Choose how you want to pay. Pay online via Paystack, or pay with mobile money and provide your transaction reference.
        </p>

        <form id="paymentForm" class="form-grid" style="margin-top:.6rem;">
          <div>
            <label>Payment method</label>
            <div class="method-options" id="methodOptions">
              <label class="method-option active">
                <input type="radio" name="channel" value="paystack" checked>
                <div>
                  <strong>Paystack (card / mobile wallet)</strong>
                  <div class="muted">Secure online payment. You’ll be redirected to Paystack (or a temporary confirmation page).</div>
                </div>
              </label>
              <label class="method-option">
                <input type="radio" name="channel" value="momo">
                <div>
                  <strong>Mobile Money (manual)</strong>
                  <div class="muted">Pay using your own MoMo app or shortcode, then paste your transaction ID for verification.</div>
                </div>
              </label>
            </div>
          </div>

          <div class="form-grid-2">
            <div>
              <label for="payerName">Full name</label>
              <input id="payerName" class="input" placeholder="Name on payment" required>
            </div>
            <div>
              <label for="payerPhone">Mobile number</label>
              <input id="payerPhone" class="input" placeholder="e.g., 024..." required>
            </div>
          </div>

          <div class="form-grid-2">
            <div>
              <label for="payerEmail">Email address</label>
              <input id="payerEmail" type="email" class="input" placeholder="you@example.com" required>
            </div>
            <div>
              <label for="amountInput">Amount</label>
              <input id="amountInput" type="number" step="0.01" class="input" required>
            </div>
          </div>

          <div id="momoExtra" style="display:none;">
            <label for="txnRef">MoMo transaction ID / Reference</label>
            <input id="txnRef" class="input" placeholder="Enter the reference you received after MoMo payment">
            <p class="muted" style="font-size:.78rem;">
              Make your MoMo payment to the number provided by our staff, then paste the exact transaction ID here for our admin to verify.
            </p>
          </div>

          <div>
            <label for="userNote">Additional note (optional)</label>
            <textarea id="userNote" placeholder="Any extra details or special instructions for this payment."></textarea>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.7rem;flex-wrap:wrap;gap:.5rem;">
            <button type="button" class="btn outline" id="cancelBtn">
              <i class="fa fa-arrow-left"></i> Back
            </button>
            <button type="submit" class="btn brand" id="payBtn">
              <i class="fa fa-lock"></i> Proceed to pay
            </button>
          </div>

          <p id="formStatus" class="muted" style="margin-top:.4rem;font-size:.82rem;"></p>
        </form>
      </section>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast"><i class="fa fa-info-circle"></i><span id="toastText">Notice</span></div>

  <script type="module">
    import { sb } from '/public/js/supabase.js';

    /* Toast */
    const toast=document.getElementById('toast');
    const toastText=document.getElementById('toastText');
    function showToast(msg,ms=2500){
      toastText.textContent=msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),ms);
    }

    /* Elements */
    const userEmailSpan=document.getElementById('userEmail');
    const summarySubtitle=document.getElementById('summarySubtitle');
    const summaryCover=document.getElementById('summaryCover');
    const summaryTitle=document.getElementById('summaryTitle');
    const summaryDesc=document.getElementById('summaryDesc');
    const summaryPills=document.getElementById('summaryPills');
    const summaryAmount=document.getElementById('summaryAmount');
    const summaryAmountNote=document.getElementById('summaryAmountNote');
    const summaryTypeBadge=document.getElementById('summaryTypeBadge');
    const infoBox=document.getElementById('infoBox');

    const methodOptions=document.getElementById('methodOptions');
    const payerName=document.getElementById('payerName');
    const payerPhone=document.getElementById('payerPhone');
    const payerEmail=document.getElementById('payerEmail');
    const amountInput=document.getElementById('amountInput');
    const txnRef=document.getElementById('txnRef');
    const userNote=document.getElementById('userNote');
    const momoExtra=document.getElementById('momoExtra');
    const paymentForm=document.getElementById('paymentForm');
    const payBtn=document.getElementById('payBtn');
    const cancelBtn=document.getElementById('cancelBtn');
    const formStatus=document.getElementById('formStatus');

    /* Auth guard */
    const { data: sessionData } = await sb.auth.getSession();
    const session = sessionData.session;
    const user = session?.user;

    if(!user){
      showToast('Please log in to make a payment.');
      window.location.href = '/views/pages/login.html';
    }else{
      userEmailSpan.textContent = user.email;
      payerEmail.value = user.email;
    }

    /* Parse query params */
    const urlParams=new URLSearchParams(window.location.search);
    const typeParam=urlParams.get('type') || 'job';           // job | service | express
    const jobId=urlParams.get('job_id');
    const serviceId=urlParams.get('service_id');
    const serviceNameParam=urlParams.get('service');
    const from=urlParams.get('from');

    /* Context object */
    let paymentContext = {
      type:typeParam,           // job | service | express
      jobId:jobId || null,
      serviceId:serviceId || null,
      serviceName:serviceNameParam || null,
      title:null,
      description:null,
      cover:null,
      amount:null,
      currency:'GHS',
      metadata:{}              // this will go into payments.metadata
    };

    async function loadJob(id){
      const { data, error } = await sb
        .from('jobs')
        .select('id,title,country,city,plan,status,description,metadata,created_at')
        .eq('id',id)
        .single();
      if(error) throw error;
      const m=data.metadata || {};
      const location =
        data.city && data.country
          ? `${data.city}, ${data.country}`
          : data.country || data.city || null;

      paymentContext.title = data.title;
      paymentContext.description = m.short_desc || data.description || location || null;
      paymentContext.cover = m.cover_image || m.logo || '/public/assets/jobs/default-cover.jpg';
      paymentContext.amount = m.amount || m.salary_amount || null;
      paymentContext.currency = m.currency || 'GHS';

      paymentContext.metadata = {
        ...paymentContext.metadata,
        job_id:data.id,
        job_title:data.title,
        job_plan:data.plan || null,
        job_location:location,
        job_company:m.company || null,
        job_type:m.job_type || null,
        salary:m.salary || null,
        raw_job_metadata:m
      };
    }

    async function loadService(id){
      const { data, error } = await sb
        .from('services')
        .select('id,title,category,tags,price,short_desc,full_desc,icon,banner,metadata')
        .eq('id',id)
        .single();
      if(error) throw error;
      const m=data.metadata || {};

      paymentContext.title = data.title;
      paymentContext.description = data.short_desc || data.category || null;
      paymentContext.cover = data.banner || m.cover_image || '/public/assets/services/default.jpg';
      paymentContext.amount = data.price || null;
      paymentContext.currency = m.currency || 'GHS';

      paymentContext.metadata = {
        ...paymentContext.metadata,
        service_id:data.id,
        service_title:data.title,
        service_category:data.category || null,
        service_tags:data.tags || [],
        raw_service_metadata:m
      };
    }

    async function loadContext(){
      try{
        if(paymentContext.type === 'job' || paymentContext.type === 'express'){
          if(!jobId) throw new Error('Missing job_id in URL.');
          summarySubtitle.textContent =
            paymentContext.type === 'express'
              ? 'Express fee for selected job.'
              : 'Payment for selected job.';
          await loadJob(jobId);
        }else if(paymentContext.type === 'service'){
          if(serviceId){
            summarySubtitle.textContent = 'Service payment.';
            await loadService(serviceId);
          }else{
            summarySubtitle.textContent = 'Service payment.';
            paymentContext.title = serviceNameParam || 'Service payment';
            paymentContext.cover = '/public/assets/services/default.jpg';
            paymentContext.description = 'Complete payment for the selected service.';
          }
        }else{
          summarySubtitle.textContent = 'Payment.';
          paymentContext.title = 'General payment';
          paymentContext.cover = '/public/assets/services/default.jpg';
        }

        // Fill summary card
        summaryTitle.textContent = paymentContext.title || 'Payment';
        summaryDesc.textContent = paymentContext.description || 'Complete payment for this request.';

        const coverSrc = paymentContext.cover || '/public/assets/services/default.jpg';
        summaryCover.innerHTML = `<img src="${coverSrc}" alt="Cover">`;

        summaryPills.innerHTML = '';
        if(paymentContext.metadata.job_plan){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-layer-group"></i> ${paymentContext.metadata.job_plan}</span>
          `);
        }
        if(paymentContext.metadata.job_company){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-building"></i> ${paymentContext.metadata.job_company}</span>
          `);
        }
        if(paymentContext.metadata.job_location){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-location-dot"></i> ${paymentContext.metadata.job_location}</span>
          `);
        }
        if(paymentContext.metadata.job_type){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-briefcase"></i> ${paymentContext.metadata.job_type}</span>
          `);
        }
        if(paymentContext.metadata.service_category){
          summaryPills.insertAdjacentHTML('beforeend',`
            <span class="pill"><i class="fa fa-tag"></i> ${paymentContext.metadata.service_category}</span>
          `);
        }

        // Amount
        if(paymentContext.amount){
          const val = Number(paymentContext.amount);
          const fmt = isNaN(val)
            ? paymentContext.amount
            : val.toLocaleString(undefined,{ minimumFractionDigits:2, maximumFractionDigits:2 });
          summaryAmount.textContent = `${paymentContext.currency} ${fmt}`;
          amountInput.value = !isNaN(val) ? val : '';
        }else{
          summaryAmount.textContent = `${paymentContext.currency} 0.00`;
        }

        // Type badge
        if(paymentContext.type === 'job'){
          summaryTypeBadge.innerHTML = `<i class="fa fa-briefcase"></i> Job payment`;
        }else if(paymentContext.type === 'express'){
          summaryTypeBadge.innerHTML = `<i class="fa fa-bolt"></i> Express job payment`;
        }else if(paymentContext.type === 'service'){
          summaryTypeBadge.innerHTML = `<i class="fa fa-suitcase"></i> Service payment`;
        }else{
          summaryTypeBadge.innerHTML = `<i class="fa fa-credit-card"></i> Payment`;
        }
      }catch(e){
        console.error(e);
        summarySubtitle.textContent = e.message || 'Failed to load payment context.';
        infoBox.innerHTML = '<strong>Note:</strong> We could not load extra context for this payment. If you know what you are paying for, you can still proceed.';
      }
    }

    await loadContext();

    /* Payment channel UI */
    function getSelectedChannel(){
      const checked = methodOptions.querySelector('input[name="channel"]:checked');
      return checked ? checked.value : 'paystack';
    }

    function handleChannelChange(channel){
      if(channel === 'momo'){
        momoExtra.style.display = 'block';
        summaryAmountNote.textContent = 'Pay using your mobile money account, then paste your transaction reference below.';
      }else{
        momoExtra.style.display = 'none';
        summaryAmountNote.textContent = 'You will be redirected to Paystack (or see confirmation instructions) to complete payment.';
      }
    }

    methodOptions.querySelectorAll('.method-option').forEach(opt=>{
      const input = opt.querySelector('input[type="radio"]');
      opt.addEventListener('click',()=>{
        methodOptions.querySelectorAll('.method-option').forEach(o=>o.classList.remove('active'));
        opt.classList.add('active');
        input.checked = true;
        handleChannelChange(input.value);
      });
    });

    handleChannelChange(getSelectedChannel());

    /* Back button */
    cancelBtn.addEventListener('click',()=>{
      if(from === 'job' && paymentContext.jobId){
        window.location.href = `/views/pages/job.html?id=${encodeURIComponent(paymentContext.jobId)}`;
      }else if(from === 'service' && (paymentContext.serviceId || paymentContext.serviceName)){
        window.location.href = '/views/pages/services.html';
      }else{
        window.history.back();
      }
    });

    /* Submit payment */
    paymentForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      formStatus.textContent = '';
      formStatus.style.color = '#9ca3af';

      const channel = getSelectedChannel();  // paystack | momo
      const name = payerName.value.trim();
      const phone = payerPhone.value.trim();
      const email = payerEmail.value.trim();
      const amountVal = parseFloat(amountInput.value);
      const note = userNote.value.trim();
      const userTxnRef = txnRef.value.trim();

      if(!name || !phone || !email || isNaN(amountVal) || amountVal <= 0){
        formStatus.textContent = 'Please fill all required fields and a valid amount.';
        formStatus.style.color = '#fecaca';
        return;
      }
      if(channel === 'momo' && !userTxnRef){
        formStatus.textContent = 'Please enter your MoMo transaction ID / reference.';
        formStatus.style.color = '#fecaca';
        return;
      }

      payBtn.disabled = true;
      payBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
      formStatus.textContent = 'Creating payment record...';

      try{
        const ref = `${paymentContext.type.toUpperCase()}-${Date.now()}-${Math.floor(Math.random()*10000)}`;

        const metadata = {
          type:paymentContext.type,
          job_id:paymentContext.jobId,
          service_id:paymentContext.serviceId,
          service_name:paymentContext.serviceName,
          title:paymentContext.title,
          description:paymentContext.description,
          from,
          payer_name:name,
          payer_phone:phone,
          payer_email:email,
          user_note:note || null,
          user_txn_ref:userTxnRef || null,
          context:paymentContext.metadata
        };

        const payload = {
          user_id:user.id,
          ref,
          status:'pending',
          amount:amountVal,
          currency:paymentContext.currency || 'GHS',
          channel:channel,           // matches payments.channel
          metadata                  // jsonb
        };

        const { error } = await sb.from('payments').insert(payload);
        if(error) throw error;

        if(channel === 'paystack'){
          formStatus.textContent = 'Payment created. Redirecting you to Paystack (or your payment page)...';
          formStatus.style.color = '#bbf7d0';
          showToast('Payment record saved. Complete payment in the Paystack window.', 4000);
          // TODO: integrate actual Paystack redirect or inline checkout using `ref`
          // window.location.href = `/views/pages/paystack-checkout.html?ref=${encodeURIComponent(ref)}`;
        }else{
          formStatus.textContent = 'MoMo payment recorded. Our admin will verify the transaction and mark it as paid.';
          formStatus.style.color = '#bbf7d0';
          showToast('MoMo payment submitted for verification.', 3500);
        }

        // Optional: redirect user to profile payments section
        // setTimeout(()=> window.location.href='/views/pages/profile.html#payments', 2500);
      }catch(err){
        console.error(err);
        formStatus.textContent = err.message || 'Failed to create payment.';
        formStatus.style.color = '#fecaca';
        showToast('Failed to create payment. Try again.');
      }finally{
        payBtn.disabled = false;
        payBtn.innerHTML = '<i class="fa fa-lock"></i> Proceed to pay';
      }
    });
  </script>
</body>
</html>
