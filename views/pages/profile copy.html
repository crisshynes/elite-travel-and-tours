<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>User Profile — Elite Travel & Tour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Your Elite Travel & Tour profile: applications, tracking, payments, notifications, and account settings with realtime updates."/>
  <link rel="stylesheet" href="/public/css/base.css">
  <link rel="stylesheet" href="/public/css/layout.css">
  <link rel="stylesheet" href="/public/css/components.css">
  <link rel="stylesheet" href="/public/css/index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --brand:#0077cc;
      --brand-600:#0060a3;
      --brand-700:#004b80;
      --dark:#020617;
      --bg:#f7f8fa;
      --muted:#64748b;
      --light:#fff;
      --shadow:0 16px 40px rgba(15,23,42,.16);
      --warning:#f59e0b;
    }

    body{
      background:var(--bg);
      color:#111827;
    }

    /* Header nav */
    nav{
      position:sticky; top:0; z-index:40;
      background:#ffffff;
      box-shadow:0 2px 4px rgba(15,23,42,.08);
    }
    nav .wrap{
      max-width:1100px; margin:0 auto;
      padding:.5rem 1rem;
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    }
    nav .logo{
      display:flex; align-items:center; gap:.4rem;
      font-weight:800; color:#0f172a; text-decoration:none;
    }
    nav .logo i{ color:var(--brand); }
    nav ul.primary{
      list-style:none; display:flex; gap:.6rem; margin:0; padding:0;
    }
    nav ul.primary a{
      text-decoration:none; padding:.4rem .6rem;
      border-radius:999px;
      color:#111827; font-weight:500;
      display:inline-flex; align-items:center; gap:.35rem;
      font-size:.9rem;
    }
    nav ul.primary a.active,
    nav ul.primary a:hover{
      background:rgba(0,119,204,.08);
      color:var(--brand-700);
    }

    .nav-right{
      display:flex; align-items:center; gap:.4rem;
    }
    .btn{
      display:inline-flex; align-items:center; gap:.4rem;
      border:none; border-radius:999px;
      padding:.45rem .8rem;
      font-size:.85rem; font-weight:600;
      cursor:pointer; text-decoration:none;
      transition:all .15s ease-out;
    }
    .btn.outline{
      background:#ffffff;
      border:1px solid #e5e7eb;
      color:#111827;
    }
    .btn.outline:hover{
      border-color:var(--brand);
      color:var(--brand-700);
      background:#f3f4ff;
    }
    .btn.brand{
      background:var(--brand);
      color:#f9fafb;
      box-shadow:0 10px 26px rgba(37,99,235,.4);
    }
    .btn.brand:hover{
      background:var(--brand-600);
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(37,99,235,.55);
    }
    .btn-sm{ padding:.3rem .6rem; font-size:.8rem; }

    .auth-pill{
      display:inline-flex; align-items:center; gap:.3rem;
      border-radius:999px;
      padding:.25rem .6rem;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      font-size:.78rem;
      color:#0f172a;
    }
    .auth-pill i{ color:var(--brand); }

    .menu-toggle{
      display:none;
      border:none; border-radius:8px;
      padding:.4rem .55rem;
      background:#f1f5f9; color:#111827;
      cursor:pointer;
    }
    @media(max-width:900px){
      nav ul.primary{ display:none; }
      .menu-toggle{ display:inline-flex; }
      #logoutBtn{ display:none !important; }
      #profileBtn{ display:none !important; }
    }

    .mobile-panel{
      display:none;
      background:#ffffff;
      border-top:1px solid #e5e7eb;
      box-shadow:0 12px 34px rgba(15,23,42,.16);
    }
    .mobile-panel.open{ display:block; }
    .mobile-panel .block{
      padding:.5rem 1rem;
      border-bottom:1px solid #e5e7eb;
    }
    .mobile-panel .block a{
      display:flex; align-items:center; gap:.4rem;
      padding:.4rem 0;
      text-decoration:none;
      color:#111827;
      font-size:.9rem;
    }
    .mobile-panel .block a.active{
      color:var(--brand-700);
      font-weight:600;
    }

    /* Notification feed */
    .feed{
      position:fixed;
      top:70px; right:10px;
      width:280px;
      background:#ffffff;
      border-radius:10px;
      border:1px solid #e5e7eb;
      box-shadow:0 12px 30px rgba(15,23,42,.16);
      padding:.6rem .7rem;
      z-index:900;
    }
    .feed.hidden{ display:none; }
    .feed-toolbar{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:.25rem;
    }
    .feed-toolbar button{
      font-size:.75rem;
      padding:.15rem .45rem;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:.25rem;
    }
    .feed-toolbar button:hover{
      border-color:#38bdf8;
      background:#eff6ff;
    }
    .feed .list{
      max-height:260px; overflow:auto; font-size:.82rem;
      border-top:1px solid #e5e7eb;
      margin-top:.3rem;
      padding-top:.3rem;
    }

    .notif-item .title{ font-weight:600; }
    .notif-item .body{ color:#4b5563; font-size:.82rem; }
    .notif-item{
      border-bottom:1px solid #e5e7eb; padding:.3rem 0;
      display:flex; flex-direction:column; gap:.05rem;
    }
    .notif-item:last-child{ border-bottom:none; }

    .notif-meta{
      display:flex; justify-content:space-between; align-items:center;
      font-size:.75rem; color:#9ca3af;
    }
    .notif-chip{
      display:inline-flex; align-items:center; gap:.2rem;
      padding:.05rem .4rem; border-radius:999px;
      background:#f3f4f6; border:1px solid #e5e7eb;
      font-size:.7rem; color:#6b7280;
    }

    /* Toast */
    .toast{
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:#020617; color:#e5e7eb; padding:.75rem 1rem; border-radius:999px;
      box-shadow:0 16px 40px rgba(15,23,42,.85); z-index:2000; display:none; max-width:90vw;
      font-size:.9rem;
    }
    .toast.show{ display:flex; align-items:center; gap:.6rem; }
    .toast i{ color:#38bdf8; }

    .page-wrap{
      max-width:1100px;
      margin:1.3rem auto 2rem;
      padding:0 1rem;
    }

    .profile-layout{
      margin-top:.5rem;
      display:grid;
      grid-template-columns:minmax(0,1.9fr) minmax(0,1.1fr);
      gap:1rem;
    }
    @media(max-width:980px){
      .profile-layout{ grid-template-columns:1fr; }
    }

    .card{
      background:#ffffff;
      border-radius:14px;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 40px rgba(15,23,42,.12);
      overflow:hidden;
    }
    .card .body{
      padding:1rem 1.1rem 1.1rem;
    }

    /* Hero */
    .profile-hero{
      position:relative;
      padding:1.1rem 1.1rem 0.9rem;
      display:grid; gap:.5rem;
    }
    .hero-cover{
      position:relative; border-radius:18px;
      height:170px; overflow:hidden;
      background:radial-gradient(circle at top, #1d4ed8, #020617);
    }
    .hero-cover img{
      width:100%; height:100%; object-fit:cover;
      opacity:.96; filter:contrast(1.02) saturate(1.02);
    }
    .hero-cover::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(to bottom, rgba(15,23,42,.05), rgba(15,23,42,.6));
      mix-blend-mode:multiply;
    }
    .hero-main{
      display:flex; justify-content:space-between; align-items:flex-end;
      margin-top:-6px; gap:1rem; flex-wrap:wrap;
    }
    .hero-left{ display:flex; gap:.75rem; align-items:flex-end; }
    .hero-avatar{
      width:78px; height:78px; border-radius:50%;
      border:3px solid #fff; overflow:hidden;
      box-shadow:0 16px 35px rgba(15,23,42,.45);
      background:#020617;
    }
    .hero-avatar img{ width:100%; height:100%; object-fit:cover; }
    .hero-meta h2{ margin:0; font-size:1.35rem; color:#f9fafb; }
    .hero-meta p{ margin:.15rem 0 0; font-size:.9rem; color:#e5e7eb; }
    .hero-meta .tags{ margin-top:.3rem; display:flex; gap:.4rem; flex-wrap:wrap; }
    .hero-meta .tags span{
      font-size:.78rem; padding:.12rem .45rem; border-radius:999px;
      background:rgba(15,23,42,.75); color:#e5e7eb;
      border:1px solid rgba(148,163,184,.7);
    }
    .hero-actions{ display:flex; gap:.4rem; flex-wrap:wrap; }

    .hero-stats{
      display:flex; justify-content:space-between; gap:.6rem; margin-top:.75rem; flex-wrap:wrap;
    }
    .stat-pill{
      flex:1 1 110px; min-width:0;
      background:#0f172a; border-radius:12px;
      box-shadow:0 14px 30px rgba(15,23,42,.7); padding:.6rem .7rem;
    }
    .stat-pill span.label{ font-size:.78rem; color:#e5e7eb; }
    .stat-pill div.value{ font-size:1.1rem; font-weight:700; color:#fbbf24; }

    .tabs{
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid #e5e7eb; margin-top:.65rem;
    }
    .tab-list{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .tab-btn{
      border:none; background:transparent; padding:.45rem .65rem;
      border-radius:999px; font-size:.9rem; color:#374151; cursor:pointer;
    }
    .tab-btn.active{
      background:#1d4ed8; color:#eff6ff; font-weight:600;
    }
    .tab-panel{ display:none; padding-top:.75rem; }
    .tab-panel.active{ display:block; }

    .section-title{ font-size:1.05rem; margin:0 0 .3rem; }
    .muted{ color:var(--muted); }
    .small-text{ font-size:.8rem; }

    .about-grid{ display:grid; gap:.6rem; grid-template-columns:1.1fr 1.2fr; }
    @media(max-width:780px){ .about-grid{ grid-template-columns:1fr; } }

    .list-simple{ list-style:none; padding:0; margin:0; }
    .list-simple li{
      padding:.45rem 0; border-bottom:1px solid #edf1f7; font-size:.9rem;
      display:flex; justify-content:space-between; gap:.5rem;
    }
    .list-simple li:last-child{ border-bottom:none; }

    .apps-grid{ display:grid; gap:.6rem; }
    .app-card{
      border-radius:12px; border:1px solid #e5e7eb; padding:.6rem .7rem; background:#f9fafb;
      display:grid; gap:.25rem;
    }
    .app-card .top{ display:flex; justify-content:space-between; align-items:center; gap:.5rem; }
    .app-card .meta{ font-size:.82rem; color:#4b5563; display:flex; gap:.5rem; flex-wrap:wrap; }

    .pay-card,.test-card{
      border-radius:12px; box-shadow:0 16px 35px rgba(15,23,42,.06); padding:.6rem .7rem; background:#f9fafb; font-size:.9rem;
      display:grid; gap:.2rem;
    }

    .pill-soft{
      display:inline-flex; align-items:center; gap:.25rem;
      padding:.18rem .5rem; border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-size:.78rem;
      color:#92400e;
    }
    .badge{
      display:inline-flex; align-items:center; gap:.25rem;
      padding:.12rem .45rem; border-radius:999px;
      font-size:.75rem;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      color:#111827;
    }
    .badge.success{ border-color:#22c55e; background:#dcfce7; color:#166534; }
    .badge.danger{ border-color:#ef4444; background:#fee2e2; color:#991b1b; }
    .badge.warning{ border-color:#fbbf24; background:#fef9c3; color:#92400e; }

    .chip-row{ display:flex; gap:.3rem; flex-wrap:wrap; }

    .timeline{
      margin-top:.4rem;
      border-left:3px solid var(--warning);
      padding-left:.6rem;
      padding-top:5px;
      padding-bottom:5px;
      font-size:.82rem;
      border-radius:4px;
      box-shadow:0 12px 30px rgba(15,23,42,.08);
      background:#fffaf0;
    }
    .timeline-item{
      margin-bottom:.35rem;
    }
    .timeline-item strong{
      display:block;
      color:#92400e;
    }
    .timeline-item span{
      color:#6b7280;
    }

    .profile-layout-right .card{ margin-bottom:1rem; }
    .widget h3{ font-size:1.05rem; margin-bottom:.2rem; }

    .modal{
      display:none; position:fixed; inset:0;
      background:rgba(15,23,42,.65);
      align-items:center; justify-content:center; z-index:1200;
    }
    .modal .card{
      max-width:480px; width:92%;
      border-radius:14px;
      border:1px solid #e5e7eb;
      box-shadow:0 24px 60px rgba(15,23,42,.8);
      background:#ffffff; color:#111827;
    }
    .modal .body{
      padding:1rem 1.1rem 1.1rem;
    }
    .modal h3{ margin-top:0; }
    .modal .subtitle{ font-size:.85rem; color:#6b7280; }

    .input, .textarea{
      width:100%;
      box-sizing:border-box;
      padding:.55rem .7rem;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#ffffff;
      font-size:.9rem;
      color:#111827;
      transition:border-color .12s, box-shadow .12s;
    }
    .input:focus, .textarea:focus{
      outline:none;
      border-color:#38bdf8;
      box-shadow:0 0 0 2px rgba(56,189,248,.35);
    }
    .textarea{ min-height:80px; resize:vertical; }
  </style>
</head>
<body>
  <!-- Header -->
  <nav aria-label="Primary">
    <div class="wrap">
      <a class="logo" href="/"><i class="fa-solid fa-compass"></i> Elite Travel & Tour</a>
      <ul class="primary">
        <li><a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a></li>
        <li><a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a></li>
        <li><a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a></li>
        <li><a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a></li>
        <li><a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a></li>
        <li><a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a></li>
        <li><a href="/views/pages/profile.html" class="active"><i class="fa fa-user"></i> Profile</a></li>
      </ul>
      <div class="nav-right">
        <button id="bellBtn" class="btn outline bell" aria-label="Notifications">
          <i class="fa-regular fa-bell"></i>
          <span id="bellCount" class="count hidden">0</span>
        </button>
        <span id="navAuthPill" class="auth-pill" style="display:none;">
          <i class="fa fa-user-check"></i><span id="navAuthText">Guest</span>
        </span>
        <button id="loginBtn" class="btn outline"><i class="fa fa-right-to-bracket"></i> Login</button>
        <button id="profileBtn" class="btn outline" style="display:none"><i class="fa fa-user"></i></button>
        <button id="logoutBtn" class="btn outline" style="display:none"><i class="fa fa-right-from-bracket"></i></button>
        <button id="menuToggle" class="menu-toggle" aria-expanded="false"><i class="fa fa-bars"></i></button>
      </div>
    </div>

    <!-- Mobile panel -->
    <div id="mobilePanel" class="mobile-panel">
      <div class="block">
        <a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a>
        <a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a>
        <a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a>
        <a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a>
        <a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a>
        <a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a>
        <a href="/views/pages/profile.html" class="active"><i class="fa fa-user"></i> Profile</a>
      </div>
      <div class="block">
        <span class="auth-pill"><i class="fa fa-user"></i><span id="mobileAuthText">Guest</span></span>
        <div class="toolbar" style="margin-top:.4rem;">
          <button id="mobileLoginBtn" class="btn outline"><i class="fa fa-right-to-bracket"></i> Login</button>
          <button id="mobileProfileBtn" class="btn outline" style="display:none"><i class="fa fa-user"></i> Profile</button>
          <button id="mobileLogoutBtn" class="btn outline" style="display:none"><i class="fa fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Notification feed -->
  <div id="notifFeed" class="feed hidden">
    <div class="feed-toolbar">
      <span class="muted small-text">Notifications</span>
      <div style="display:flex;gap:.25rem;">
        <button id="markAllReadBtn" title="Mark all as read"><i class="fa fa-check-double"></i> Read</button>
        <button id="clearAllNotifBtn" title="Clear all"><i class="fa fa-trash"></i> Clear</button>
      </div>
    </div>
    <div id="notifList" class="list"></div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <i class="fa fa-info-circle"></i><span id="toastText">Notice</span>
  </div>

  <div class="page-wrap">
    <main class="profile-layout">
      <!-- Left: Profile + tabs -->
      <section class="card" aria-label="Profile overview and history">
        <div class="profile-hero">
          <div class="hero-cover">
            <img id="profileCoverImg" src="/public/assets/profile/cover.jpg" alt="Profile cover">
          </div>
          <div class="hero-main">
            <div class="hero-left">
              <div class="hero-avatar">
                <img id="profileAvatarImg" src="/public/assets/profile/avatar.jpg" alt="Avatar">
              </div>
              <div class="hero-meta">
                <h2 id="profileName">Loading...</h2>
                <p id="profileEmail">—</p>
                <div class="tags">
                  <span id="profileStatusTag"><i class="fa fa-circle-check"></i> Verified account</span>
                  <span id="profileCountryTag" style="display:none;"><i class="fa fa-location-dot"></i> <span id="profileCountryText">Ghana</span></span>
                  <span id="profileModeTag" style="display:none;"><i class="fa fa-shield-halved"></i> Admin viewing</span>
                </div>
              </div>
            </div>
            <div class="hero-actions">
              <button class="btn outline" id="aboutBtn"><i class="fa fa-id-card"></i> About</button>
              <button class="btn outline" id="editProfileBtn"><i class="fa fa-user-pen"></i> Edit profile</button>
              <button class="btn brand" id="followBtn"><i class="fa fa-bell"></i> Follow Elite updates</button>
            </div>
          </div>

          <div class="hero-stats" id="heroStats">
            <div class="stat-pill">
              <span class="label">Applications</span>
              <div class="value" id="statApps">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Active</span>
              <div class="value" id="statActiveApps">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Completed</span>
              <div class="value" id="statCompletedApps">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Pending payments</span>
              <div class="value" id="statPendingPayments">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Account age</span>
              <div class="value" id="statAge">–</div>
            </div>
          </div>

          <div class="tabs" aria-label="Profile sections">
            <div class="tab-list">
              <button class="tab-btn active" data-tab="overview">Overview</button>
              <button class="tab-btn" data-tab="applications">Applications</button>
              <button class="tab-btn" data-tab="payments">Payments</button>
              <button class="tab-btn" data-tab="testimonials">Testimonials</button>
              <button class="tab-btn" data-tab="account">Account & security</button>
            </div>
          </div>
        </div>

        <div class="body">
          <!-- Overview -->
          <section class="tab-panel active" id="tab-overview">
            <h3 class="section-title">Overview</h3>
            <p class="muted small-text" id="overviewIntro">A quick snapshot of your journey with Elite Travel & Tour.</p>

            <div class="about-grid" style="margin-top:.5rem;">
              <div>
                <h4 style="margin-bottom:.25rem;">Profile details</h4>
                <ul class="list-simple" id="profileDetailsList"></ul>
              </div>
              <div>
                <h4 style="margin-bottom:.25rem;">Latest activity</h4>
                <div id="overviewActivity">
                  <div class="muted small-text">Loading recent activity…</div>
                </div>
              </div>
            </div>
          </section>

          <!-- Applications -->
          <section class="tab-panel" id="tab-applications">
            <div class="toolbar" style="margin-bottom:.35rem;justify-content:space-between;align-items:center;">
              <h3 class="section-title" style="margin:0;">Applications</h3>
              <span class="pill-soft">
                <i class="fa fa-location-crosshairs"></i>
                Track with your ID on Tracking page
              </span>
            </div>
            <div id="apps" class="apps-grid"></div>
            <div class="toolbar" style="margin-top:.4rem;gap:.5rem;flex-wrap:wrap;">
              <a class="btn outline" href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Explore work programs</a>
              <a class="btn outline" href="/views/pages/tracking.html"><i class="fa fa-location-arrow"></i> Open tracking</a>
              <button class="btn outline btn-sm" id="refreshAppsBtn"><i class="fa fa-rotate"></i> Refresh</button>
            </div>
          </section>

          <!-- Payments -->
          <section class="tab-panel" id="tab-payments">
            <div class="toolbar" style="margin-bottom:.35rem;justify-content:space-between;align-items:center;">
              <h3 class="section-title" style="margin:0;">Payments</h3>
              <span class="pill-soft"><i class="fa fa-shield-alt"></i> Payments are secured via verified gateways</span>
            </div>
            <div id="pays"></div>
            <div class="toolbar" style="margin-top:.4rem;">
              <button class="btn outline btn-sm" id="refreshPaysBtn"><i class="fa fa-rotate"></i> Refresh</button>
            </div>
          </section>

          <!-- Testimonials -->
          <section class="tab-panel" id="tab-testimonials">
            <div class="toolbar" style="margin-bottom:.35rem;justify-content:space-between;align-items:center;">
              <h3 class="section-title" style="margin:0;">Testimonials</h3>
              <span class="pill-soft"><i class="fa fa-star"></i> Help others choose with confidence</span>
            </div>
            <div id="tests"></div>
            <h4 class="section-title" style="margin-top:1rem;">Add a testimonial</h4>
            <textarea class="textarea" id="tText" placeholder="Share your experience with Elite Travel & Tour"></textarea>
            <div class="toolbar" style="margin-top:.3rem;">
              <button class="btn brand" id="tAdd"><i class="fa fa-plus"></i> Submit</button>
              <button class="btn outline btn-sm" id="refreshTestsBtn"><i class="fa fa-rotate"></i> Refresh</button>
            </div>
          </section>

          <!-- Account / security -->
          <section class="tab-panel" id="tab-account">
            <h3 class="section-title">Account & security</h3>
            <p class="muted small-text" id="accountIntro">Update your display name, phone, country, and secure your account.</p>
            <div class="about-grid" style="margin-top:.6rem;">
              <div>
                <h4>Account</h4>
                <ul class="list-simple">
                  <li><span>Email</span> <span id="settingsEmail">—</span></li>
                  <li><span>Full name</span> <span id="settingsFullname">—</span></li>
                  <li><span>Joined</span> <span id="settingsJoined">—</span></li>
                </ul>
              </div>
              <div>
                <h4>Edit profile</h4>
                <form id="profileForm">
                  <label class="small-text">Full name</label>
                  <input id="inputFullname" class="input" placeholder="Your full name">
                  <label class="small-text" style="margin-top:.4rem;">Phone</label>
                  <input id="inputPhone" class="input" placeholder="Phone number">
                  <label class="small-text" style="margin-top:.4rem;">Country</label>
                  <input id="inputCountry" class="input" placeholder="Country of residence">
                  <div class="toolbar" style="margin-top:.6rem;">
                    <button type="submit" class="btn brand" id="profileSaveBtn"><i class="fa fa-save"></i> Save profile</button>
                    <button type="button" class="btn outline" id="editPasswordBtn"><i class="fa fa-key"></i> Change password</button>
                  </div>
                  <p id="uStatus" class="muted small-text" style="margin-top:.4rem;"></p>
                </form>
                <div class="toolbar" style="margin-top:.6rem;">
                  <button class="btn outline btn-sm" id="editAvatarBtn"><i class="fa fa-image"></i> Change avatar</button>
                  <button class="btn outline btn-sm" id="editCoverBtn"><i class="fa fa-photo-film"></i> Change cover</button>
                </div>
              </div>
            </div>
            <p class="muted small-text" id="adminViewNote" style="margin-top:.4rem;display:none;">
              You are viewing another user as admin. Profile edits here apply only to your own account; use the admin panel to manage users.
            </p>
          </section>
        </div>
      </section>

      <!-- Right: Activity / quick actions -->
      <section aria-label="Sidebar" class="card profile-layout-right">
        <div class="body">
          <div class="widget">
            <h3>Quick shortcuts</h3>
            <div class="toolbar" style="gap:.4rem;flex-wrap:wrap;">
              <a href="/views/pages/services.html" class="btn outline btn-sm"><i class="fa fa-suitcase"></i> Services</a>
              <a href="/views/pages/work-and-pay.html" class="btn outline btn-sm"><i class="fa fa-briefcase"></i> Work & Pay</a>
              <a href="/views/pages/tracking.html" class="btn outline btn-sm"><i class="fa fa-location-arrow"></i> Tracking</a>
            </div>
          </div>

          <div class="widget" style="margin-top:1rem;">
            <h3>Elite Travel updates</h3>
            <p class="muted small-text">Follow our official account to receive new jobs, visa updates, and service changes in your notifications.</p>
            <button class="btn brand" id="followEliteBtn" style="margin-top:.4rem;"><i class="fa fa-bell"></i> Follow Elite updates</button>
            <p class="muted small-text" id="followStatus" style="margin-top:.35rem;"></p>
          </div>

          <div class="widget" style="margin-top:1rem;">
            <h3>Current journey</h3>
            <p class="muted small-text" id="currentJourneyText">No active application selected.</p>
            <div id="currentJourneyTimeline" class="timeline"></div>
          </div>

          <div class="widget" style="margin-top:1rem;">
            <h3>Quick tracking</h3>
            <p class="muted small-text">Enter a tracking ID to jump directly to the tracking page.</p>
            <div class="toolbar" style="margin-top:.4rem;flex-wrap:wrap;">
              <input id="quickTrackInput" class="input" placeholder="Tracking ID (e.g., ET-WP-2025-000123)">
              <button id="quickTrackBtn" class="btn outline btn-sm"><i class="fa fa-location-crosshairs"></i> Track</button>
            </div>
          </div>

          <div class="widget" style="margin-top:1rem;">
            <h3>Profile completeness</h3>
            <p class="muted small-text">Complete your details to help admins review your applications faster.</p>
            <div class="chip-row" id="profileCompletenessRow" style="margin-top:.4rem;"></div>
          </div>

          <div class="widget" style="margin-top:1rem;">
            <h3>Recent notifications</h3>
            <div id="sidebarNotifs" style="margin-top:.2rem;font-size:.85rem;">
              <div class="muted small-text">New items will appear here.</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Footer -->
  <footer id="footer">
    <div class="grid">
      <div>
        <h4>Elite Travel & Tour</h4>
        <p>Trusted partner for seamless journeys worldwide.</p>
        <p class="muted">Visa assistance, Work & Pay programs, and flight bookings with premium support.</p>
      </div>
      <div>
        <h4>Quick Links</h4>
        <ul>
          <li><a href="/views/pages/services.html">Services</a></li>
          <li><a href="/views/pages/work-and-pay.html">Work & Pay</a></li>
          <li><a href="/views/pages/appointment.html">Book Appointment</a></li>
          <li><a href="/views/pages/contact.html">Contact</a></li>
          <li><a href="/views/pages/about.html">About</a></li>
        </ul>
      </div>
      <div>
        <h4>Contact</h4>
        <p><i class="fa fa-phone"></i> +233 20 123 4567</p>
        <p><i class="fa fa-envelope"></i> info@elitetravel.com</p>
        <p><i class="fa fa-map-marker-alt"></i> Tema, Greater Accra, Ghana</p>
        <div class="newsletter" style="margin-top:.4rem;">
          <label for="newsletterEmail" class="muted small-text">Subscribe to our newsletter:</label><br>
          <input id="newsletterEmail" type="email" placeholder="Your email">
          <button id="subscribeBtn"><i class="fa fa-paper-plane"></i> Subscribe</button>
        </div>
        <div id="subscribeMsg" class="muted small-text" style="margin-top:.5rem;"></div>
      </div>
      <div>
        <h4>Resources</h4>
        <ul class="list">
          <li><a href="/views/pages/profile.html">Profile</a></li>
          <li><a href="/views/pages/tracking.html">Tracking</a></li>
          <li><a href="/views/pages/privacy.html">Privacy Policy</a></li>
          <li><a href="/views/pages/terms.html">Terms of Service</a></li>
        </ul>
      </div>
      <div class="social">
        <h4>Follow Us</h4>
        <div class="toolbar">
          <a href="#"><i class="fa-brands fa-facebook"></i></a>
          <a href="#"><i class="fa-brands fa-x-twitter"></i></a>
          <a href="#"><i class="fa-brands fa-instagram"></i></a>
          <a href="#"><i class="fa-brands fa-linkedin"></i></a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">© <span id="year"></span> Elite Travel & Tour. All rights reserved.</div>
  </footer>

  <!-- Modals -->
  <div class="modal" id="nameModal">
    <section class="card"><div class="body">
      <h3>Edit display name</h3>
      <p class="subtitle">Update the name shown across your profile, applications, and testimonials.</p>
      <input class="input" id="newName" placeholder="New display name">
      <div class="toolbar" style="margin-top:.6rem;">
        <button class="btn brand" id="saveName">Save</button>
        <button class="btn outline" id="cancelName">Cancel</button>
      </div>
    </div></section>
  </div>

  <div class="modal" id="passwordModal">
    <section class="card"><div class="body">
      <h3>Change password</h3>
      <p class="subtitle">Use a strong password to keep your account secure.</p>
      <input class="input" type="password" id="newPassword" placeholder="New password">
      <div class="muted small-text" style="margin-top:.3rem;">Password must be at least 8 characters.</div>
      <div class="toolbar" style="margin-top:.75rem;">
        <button class="btn brand" id="savePassword">Save</button>
        <button class="btn outline" id="cancelPassword">Cancel</button>
      </div>
    </div></section>
  </div>

  <div class="modal" id="avatarModal">
    <section class="card"><div class="body">
      <h3>Change avatar</h3>
      <p class="subtitle">Upload a square image (1:1) for best results.</p>
      <input class="input" type="file" id="newAvatar" accept="image/*">
      <div class="toolbar" style="margin-top:.6rem;">
        <button class="btn brand" id="saveAvatar">Save</button>
        <button class="btn outline" id="cancelAvatar">Cancel</button>
      </div>
    </div></section>
  </div>

  <div class="modal" id="coverModal">
    <section class="card"><div class="body">
      <h3>Change cover photo</h3>
      <p class="subtitle">Use a wide image (16:9) for the best profile header.</p>
      <input class="input" type="file" id="newCover" accept="image/*">
      <div class="toolbar" style="margin-top:.6rem;">
        <button class="btn brand" id="saveCover">Save</button>
        <button class="btn outline" id="cancelCover">Cancel</button>
      </div>
    </div></section>
  </div>

  <div class="modal" id="aboutModal">
    <section class="card"><div class="body">
      <h3>About this account</h3>
      <p class="subtitle">A summary of the information associated with this Elite Travel & Tour account.</p>
      <div id="aboutContent"></div>
      <div class="toolbar" style="margin-top:.8rem;">
        <button class="btn brand" id="closeAbout"><i class="fa fa-check"></i> Close</button>
      </div>
    </div></section>
  </div>

  <!-- Scripts -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="/public/js/supabase.js"></script>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const subscribeBtn=document.getElementById('subscribeBtn');
    const eemailInput=document.getElementById('newsletterEmail');
    const subscribeMsg=document.getElementById('subscribeMsg');
    subscribeBtn?.addEventListener('click',()=>{
      const eemail=eemailInput.value.trim();
      if(!eemail){ subscribeMsg.textContent="Please enter your email."; subscribeMsg.style.color="red"; return; }
      subscribeMsg.textContent=`Thank you for subscribing, ${eemail}!`;
      subscribeMsg.style.color="lightgreen";
      eemailInput.value="";
    });
  </script>

  <script type="module">
    import { sb } from '/public/js/supabase.js';

    /* Toast */
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');
    function showToast(message, ms = 2500) {
      if (!toast || !toastText) return;
      toastText.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), ms);
    }

    /* Helper: safely set metadata.seen = true */
    function withSeenTrue(metadata) {
      const base = (metadata && typeof metadata === 'object') ? metadata : {};
      return { ...base, seen: true };
    }

    /* Notification feed & controls */
    const bellBtn = document.getElementById('bellBtn');
    const notifFeed = document.getElementById('notifFeed');
    const notifList = document.getElementById('notifList');
    const bellCount = document.getElementById('bellCount');
    const sidebarNotifs = document.getElementById('sidebarNotifs');
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    const clearAllNotifBtn = document.getElementById('clearAllNotifBtn');

    let notifChannel = null;
    let notifHistory = [];
    let unreadCount = 0;

    document.addEventListener('click', (e) => {
      if (bellBtn && e.target.closest('#bellBtn')) {
        notifFeed.classList.toggle('hidden');
        if (!notifFeed.classList.contains('hidden')) {
          resetBellCounter();
        }
      } else if (!e.target.closest('#notifFeed') && !e.target.closest('#bellBtn')) {
        notifFeed.classList.add('hidden');
      }
    });

    function resetBellCounter() {
      unreadCount = 0;
      if (bellCount) {
        bellCount.textContent = '0';
        bellCount.classList.add('hidden');
      }
      notifHistory = notifHistory.map(n => ({
        ...n,
        metadata: withSeenTrue(n.metadata)
      }));
      renderNotificationFeed(notifHistory);
      renderSidebarNotifications(notifHistory);
    }

    function renderNotificationItem(n) {
      const when = n.created_at ? new Date(n.created_at).toLocaleString() : '';
      const isUnread = !n.metadata?.seen;
      const el = document.createElement('div');
      el.className = 'notif-item';
      el.innerHTML = `
        <div class="title">${n.title || 'Notification'}</div>
        <div class="body">${n.message || n.text || ''}</div>
        <div class="notif-meta">
          <span>${when}</span>
          <span class="notif-chip">${isUnread ? '<i class="fa fa-circle-dot"></i> New' : '<i class="fa fa-circle-check"></i> Read'}</span>
        </div>
      `;
      return el;
    }

    function recomputeUnread() {
      unreadCount = notifHistory.filter(n => !n.metadata?.seen).length;
    }

    function updateBellCounter() {
      recomputeUnread();
      if (bellCount) {
        if (unreadCount > 0) {
          bellCount.textContent = String(unreadCount);
          bellCount.classList.remove('hidden');
        } else {
          bellCount.textContent = '0';
          bellCount.classList.add('hidden');
        }
      }
    }

    function renderNotificationFeed(list) {
      if (!notifList) return;
      notifList.innerHTML = '';
      if (!list.length) {
        notifList.innerHTML = '<div class="muted small-text">No recent notifications.</div>';
        bellCount?.classList.add('hidden');
        return;
      }
      list.slice().reverse().forEach(n => {
        notifList.appendChild(renderNotificationItem(n));
      });
      updateBellCounter();
    }

    function renderSidebarNotifications(list) {
      if (!sidebarNotifs) return;
      sidebarNotifs.innerHTML = '';
      if (!list.length) {
        sidebarNotifs.innerHTML = '<div class="muted small-text">New items will appear here.</div>';
        return;
      }
      list.slice(0,5).forEach(n => {
        const when = n.created_at ? new Date(n.created_at).toLocaleString() : '';
        const div = document.createElement('div');
        div.className = 'notif-item';
        div.innerHTML = `
          <div class="title">${n.title || 'Notification'}</div>
          <div class="body">${n.message || n.text || ''}</div>
          <div class="small-text">${when}</div>
        `;
        sidebarNotifs.appendChild(div);
      });
    }

    function addNotificationToHistory(n) {
      notifHistory.unshift({
        ...n,
        metadata:n.metadata || {}
      });
      if (notifHistory.length > 50) notifHistory.length = 50;
      renderNotificationFeed(notifHistory);
      renderSidebarNotifications(notifHistory);
    }

    async function subscribeNotifications(userId) {
      if (notifChannel) {
        await sb.removeChannel(notifChannel);
        notifChannel = null;
      }
      notifChannel = sb
        .channel(`profile-notifs-${userId}`)
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'notifications',
            filter: `user_id=eq.${userId}`
          },
          (payload) => {
            const n = payload.new;
            addNotificationToHistory(n);
            showToast(n.title || 'New notification', 3000);
          }
        )
        .subscribe();
    }

    async function loadInitialNotifications(userId) {
      try {
        const { data, error } = await sb
          .from('notifications')
          .select('id,title,message,text,created_at,user_id,metadata')
          .eq('user_id', userId)
          .order('created_at', { ascending:false })
          .limit(30);
        if (error) throw error;
        notifHistory = (data || []).map(n => ({
          ...n,
          metadata:n.metadata || {}
        }));
        renderNotificationFeed(notifHistory);
        renderSidebarNotifications(notifHistory);
      } catch (e) {
        console.error(e);
      }
    }

    async function markAllNotificationsRead(userId) {
      try {
        // Update local cache
        notifHistory = notifHistory.map(n => ({
          ...n,
          metadata: withSeenTrue(n.metadata)
        }));
        renderNotificationFeed(notifHistory);
        renderSidebarNotifications(notifHistory);
        if (bellCount) {
          bellCount.textContent = '0';
          bellCount.classList.add('hidden');
        }

        // Persist to DB
        const ids = notifHistory.map(n => n.id).filter(Boolean);
        if (!ids.length) return;

        const { data: rows, error: fetchErr } = await sb
          .from('notifications')
          .select('id,metadata')
          .in('id', ids);
        if (fetchErr) {
          console.warn('Failed to fetch notifications for markAllNotificationsRead', fetchErr);
          return;
        }

        for (const row of rows) {
          const newMeta = withSeenTrue(row.metadata);
          const { error: updErr } = await sb
            .from('notifications')
            .update({ metadata: newMeta })
            .eq('id', row.id);
          if (updErr) {
            console.warn('Failed to update notification metadata for id', row.id, updErr);
          }
        }
      } catch (e) {
        console.warn('markAllNotificationsRead failed', e);
      }
    }

    async function clearAllNotifications(userId) {
      notifHistory = [];
      renderNotificationFeed(notifHistory);
      renderSidebarNotifications(notifHistory);
      try{
        const { error } = await sb
          .from('notifications')
          .delete()
          .eq('user_id', userId);
        if (error) console.warn('Failed to clear notifications from DB', error);
      }catch(e){
        console.warn('Failed to clear notifications', e);
      }
    }

    /* Auth + nav UI + admin mode */
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileBtn = document.getElementById('profileBtn');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    const mobileProfileBtn = document.getElementById('mobileProfileBtn');
    const navAuthText = document.getElementById('navAuthText');
    const navAuthPill = document.getElementById('navAuthPill');
    const mobileAuthText = document.getElementById('mobileAuthText');
    const menuToggle = document.getElementById('menuToggle');
    const mobilePanel = document.getElementById('mobilePanel');
    const profileModeTag = document.getElementById('profileModeTag');
    const accountIntro = document.getElementById('accountIntro');
    const adminViewNote = document.getElementById('adminViewNote');
    const profileSaveBtn = document.getElementById('profileSaveBtn');
    const editPasswordBtn = document.getElementById('editPasswordBtn');
    const editAvatarBtn = document.getElementById('editAvatarBtn');
    const editCoverBtn = document.getElementById('editCoverBtn');
    const followBtn = document.getElementById('followBtn');
    const followEliteBtn = document.getElementById('followEliteBtn');

    const urlParams = new URLSearchParams(window.location.search);
    const emailParam = urlParams.get('email');

    let sessionUser = null;
    let viewedUser = null;
    let viewedUserId = null;
    let viewedUserEmail = null;
    let isAdmin = false;
    let isAdminViewingOther = false;

    function setAuthPills(session) {
      const user = session?.user || null;
      sessionUser = user;
      if (user) {
        navAuthPill.style.display = 'inline-flex';
        navAuthText.textContent = user.email || 'User';
        mobileAuthText.textContent = user.email || 'User';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        profileBtn.style.display = 'inline-flex';
        mobileLoginBtn.style.display = 'none';
        mobileLogoutBtn.style.display = 'inline-flex';
        mobileProfileBtn.style.display = 'inline-flex';
      } else {
        navAuthPill.style.display = 'none';
        navAuthText.textContent = 'Guest';
        mobileAuthText.textContent = 'Guest';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        profileBtn.style.display = 'none';
        mobileLoginBtn.style.display = 'inline-flex';
        mobileLogoutBtn.style.display = 'none';
        mobileProfileBtn.style.display = 'none';
      }
    }

    async function fetchSessionAndRole() {
      const { data: sessionData } = await sb.auth.getSession();
      const session = sessionData.session;
      setAuthPills(session);

      if (!session?.user) {
        showToast('Please log in to view your profile.');
        window.location.href = '/views/pages/login.html';
        return false;
      }

      const { data: userRow, error } = await sb
        .from('users')
        .select('id,email,role')
        .eq('id', session.user.id)
        .maybeSingle();
      if (error) console.error(error);
      isAdmin = userRow?.role === 'admin' || userRow?.role === 'superadmin';

      return true;
    }

    loginBtn?.addEventListener('click', () => (window.location.href = '/views/pages/login.html'));
    mobileLoginBtn?.addEventListener('click', () => (window.location.href = '/views/pages/login.html'));

    async function handleLogout() {
      await sb.auth.signOut();
      window.location.href = '/views/pages/login.html';
    }
    logoutBtn?.addEventListener('click', handleLogout);
    mobileLogoutBtn?.addEventListener('click', handleLogout);

    profileBtn?.addEventListener('click', () => (window.location.href = '/views/pages/profile.html'));
    mobileProfileBtn?.addEventListener('click', () => (window.location.href = '/views/pages/profile.html'));

    menuToggle?.addEventListener('click', () => {
      const isOpen = mobilePanel.classList.toggle('open');
      menuToggle.setAttribute('aria-expanded', String(isOpen));
    });
    mobilePanel?.addEventListener('click', (e) => {
      if (e.target.matches('a')) {
        mobilePanel.classList.remove('open');
        menuToggle.setAttribute('aria-expanded', 'false');
      }
    });

    /* DOM refs for profile */
    const profileNameEl = document.getElementById('profileName');
    const profileEmailEl = document.getElementById('profileEmail');
    const profileAvatarImg = document.getElementById('profileAvatarImg');
    const profileCoverImg = document.getElementById('profileCoverImg');
    const profileDetailsList = document.getElementById('profileDetailsList');
    const overviewActivity = document.getElementById('overviewActivity');

    const appsEl = document.getElementById('apps');
    const paysEl = document.getElementById('pays');
    const testsEl = document.getElementById('tests');

    const statApps = document.getElementById('statApps');
    const statActiveApps = document.getElementById('statActiveApps');
    const statCompletedApps = document.getElementById('statCompletedApps');
    const statAge = document.getElementById('statAge');
    const statPendingPayments = document.getElementById('statPendingPayments');

    const completenessRow = document.getElementById('profileCompletenessRow');
    const uStatus = document.getElementById('uStatus');

    const settingsEmail = document.getElementById('settingsEmail');
    const settingsFullname = document.getElementById('settingsFullname');
    const settingsJoined = document.getElementById('settingsJoined');

    const inputFullname = document.getElementById('inputFullname');
    const inputPhone = document.getElementById('inputPhone');
    const inputCountry = document.getElementById('inputCountry');
    const profileForm = document.getElementById('profileForm');

    const countryTag = document.getElementById('profileCountryTag');
    const countryText = document.getElementById('profileCountryText');

    const currentJourneyText = document.getElementById('currentJourneyText');
    const currentJourneyTimeline = document.getElementById('currentJourneyTimeline');

    const quickTrackInput = document.getElementById('quickTrackInput');
    const quickTrackBtn = document.getElementById('quickTrackBtn');

    const followStatus = document.getElementById('followStatus');

    const nameModal = document.getElementById('nameModal');
    const passwordModal = document.getElementById('passwordModal');
    const avatarModal = document.getElementById('avatarModal');
    const coverModal = document.getElementById('coverModal');
    const aboutModal = document.getElementById('aboutModal');

    const btnEditProfile = document.getElementById('editProfileBtn');
    const btnAbout = document.getElementById('aboutBtn');

    function setStatus(text, type = 'muted') {
      if (!uStatus) return;
      uStatus.textContent = text || '';
      uStatus.className = `muted small-text ${type}`;
    }

    let userProfile = null;
    let userApps = [];
    let userPayments = [];
    let userTests = [];

    function mapAppStage(app) {
      const status = app.status || 'submitted';
      const steps = Array.isArray(app.progress) ? app.progress : [];
      const keys = new Set(steps.map((s) => (s.step || s.status || '').toLowerCase()));

      if (status === 'completed' || keys.has('completed') || keys.has('departure')) return 'completed';
      if (keys.has('visa_submitted') || keys.has('visa_approved') || keys.has('process_handling')) return 'visa_processing';
      if (keys.has('documents_submitted') || keys.has('docs_submitted')) return 'documents';
      if (status === 'paid' || keys.has('payment_received') || keys.has('paid')) return 'paid';
      if (status === 'accepted') return 'accepted';
      return 'application';
    }

    function stageLabel(stage) {
      switch (stage) {
        case 'accepted':
          return 'Accepted';
        case 'paid':
          return 'Payment received';
        case 'documents':
          return 'Documents submitted';
        case 'visa_processing':
          return 'Visa & process handling';
        case 'completed':
          return 'Completed';
        default:
          return 'Application';
      }
    }

    function formatAmount(amount, currency) {
      const val = Number(amount);
      if (Number.isNaN(val)) return `${currency || 'GHS'} ${amount}`;
      return `${currency || 'GHS'} ${val.toLocaleString(undefined,{ minimumFractionDigits:2, maximumFractionDigits:2 })}`;
    }

    async function resolveViewedUser() {
      if (!sessionUser) return false;

      if (emailParam && emailParam !== sessionUser.email) {
        if (!isAdmin) {
          showToast('You are not allowed to view other users profiles.');
          window.location.href = '/views/pages/profile.html';
          return false;
        }
        const { data, error } = await sb
          .from('users')
          .select('*')
          .eq('email', emailParam)
          .maybeSingle();
        if (error || !data) {
          showToast('Target user not found for this email.');
          window.location.href = '/views/pages/profile.html';
          return false;
        }
        viewedUser = data;
        viewedUserId = data.id;
        viewedUserEmail = data.email;
        isAdminViewingOther = true;
        profileModeTag.style.display = 'inline-flex';
        profileModeTag.innerHTML = `<i class="fa fa-shield-halved"></i> Admin viewing`;
        accountIntro.textContent = 'Account & security (you are viewing another user as admin).';
        adminViewNote.style.display = 'block';
        profileSaveBtn.disabled = true;
        editPasswordBtn.disabled = true;
        editAvatarBtn.disabled = true;
        editCoverBtn.disabled = true;
        followBtn.disabled = true;
        followEliteBtn.disabled = false;
      } else {
        const { data, error } = await sb
          .from('users')
          .select('*')
          .eq('id', sessionUser.id)
          .maybeSingle();
        if (error || !data) {
          showToast('Could not load your profile.');
          return false;
        }
        viewedUser = data;
        viewedUserId = data.id;
        viewedUserEmail = data.email;
        isAdminViewingOther = false;
        profileModeTag.style.display = 'none';
        adminViewNote.style.display = 'none';
        profileSaveBtn.disabled = false;
        editPasswordBtn.disabled = false;
        editAvatarBtn.disabled = false;
        editCoverBtn.disabled = false;
        followBtn.disabled = false;
        followEliteBtn.disabled = false;
      }
      return true;
    }

    async function loadProfile() {
      if (!viewedUserId) return;
      const u = viewedUser;
      userProfile = u;

      const displayName = u.fullname || u.name || viewedUserEmail;
      profileNameEl.textContent = displayName;
      profileEmailEl.textContent = viewedUserEmail;
      settingsEmail.textContent = viewedUserEmail;
      settingsFullname.textContent = displayName;

      if (profileAvatarImg && u.avatar_url) profileAvatarImg.src = u.avatar_url;
      if (profileCoverImg && u.cover) profileCoverImg.src = u.cover;

      if (u.country) {
        countryTag.style.display = 'inline-flex';
        countryText.textContent = u.country;
      } else {
        countryTag.style.display = 'none';
      }

      const created = u.created_at ? new Date(u.created_at) : null;
      if (created) {
        const diffDays = Math.floor((Date.now() - created.getTime()) / (1000 * 60 * 60 * 24));
        statAge.textContent = diffDays <= 0 ? 'New' : `${diffDays}d`;
        settingsJoined.textContent = created.toLocaleDateString();
      } else {
        statAge.textContent = '–';
        settingsJoined.textContent = '–';
      }

      const chips = [
        { label: 'Name', ok: !!displayName },
        { label: 'Avatar', ok: !!u.avatar_url },
        { label: 'Cover', ok: !!u.cover },
        { label: 'Country', ok: !!u.country },
        { label: 'Phone', ok: !!u.phone }
      ];

      completenessRow.innerHTML = '';
      chips.forEach((c) => {
        const span = document.createElement('span');
        span.className = 'pill-soft';
        span.innerHTML = `<i class="fa ${c.ok ? 'fa-check-circle' : 'fa-circle-exclamation'}"></i> ${c.label}`;
        completenessRow.appendChild(span);
      });

      profileDetailsList.innerHTML = `
        <li><span>Email</span><span class="muted">${viewedUserEmail}</span></li>
        <li><span>Display name</span><span class="muted">${displayName}</span></li>
        <li><span>Status</span><span class="badge">${u.status || 'active'}</span></li>
        ${u.country ? `<li><span>Country</span><span class="muted">${u.country}</span></li>` : ''}
        ${u.created_at ? `<li><span>Joined</span><span class="muted">${new Date(u.created_at).toLocaleDateString()}</span></li>` : ''}
      `;

      document.getElementById('aboutContent').innerHTML = `
        <ul class="list-simple">
          <li><span>Email</span><span class="muted">${viewedUserEmail}</span></li>
          <li><span>Display name</span><span class="muted">${displayName}</span></li>
          <li><span>Status</span><span class="badge">${u.status || 'active'}</span></li>
          ${u.country ? `<li><span>Country</span><span class="muted">${u.country}</span></li>` : ''}
          ${u.created_at ? `<li><span>Joined</span><span class="muted">${new Date(u.created_at).toLocaleString()}</span></li>` : ''}
          <li><span>User ID</span><span class="muted" style="max-width:220px;overflow:hidden;text-overflow:ellipsis;">${viewedUserId}</span></li>
        </ul>
        <p class="muted small-text" style="margin-top:.6rem;">Admins can see additional details needed for verification and compliance, but they are not exposed publicly.</p>
      `;

      inputFullname.value = u.fullname || u.name || '';
      inputPhone.value = u.phone || '';
      inputCountry.value = u.country || '';
    }

    function renderCurrentJourney(apps) {
      if (!apps.length) {
        currentJourneyText.textContent = 'No active application selected.';
        currentJourneyTimeline.innerHTML = '';
        return;
      }
      const active = apps.filter(a => {
        const s = mapAppStage(a);
        return s !== 'completed';
      });
      const target = active[0] || apps[0];
      const stage = mapAppStage(target);
      const title = target.jobs?.title || 'Application';
      currentJourneyText.textContent = `${title} — ${stageLabel(stage)}`;

      const steps = Array.isArray(target.progress) ? target.progress : [];
      const created = target.created_at ? new Date(target.created_at).toLocaleString() : null;

      const timelineEvents = [];
      if (created) timelineEvents.push({ label:'Application submitted', at:created });

      const map = {
        accepted:'Application accepted',
        payment_received:'Payment received',
        documents_submitted:'Documents submitted',
        visa_submitted:'Visa submitted',
        visa_approved:'Visa approved',
        completed:'Completed / departure'
      };
      steps.forEach(s=>{
        const key = (s.step || s.status || '').toLowerCase();
        const label = map[key] || s.step || s.status || 'Update';
        const at = s.at || s.time || null;
        timelineEvents.push({ label, at: at ? new Date(at).toLocaleString() : '' });
      });

      currentJourneyTimeline.innerHTML = timelineEvents.map(ev=>`
        <div class="timeline-item">
          <strong>${ev.label}</strong>
          <span>${ev.at || ''}</span>
        </div>
      `).join('');
    }

    function renderApplications(apps) {
      userApps = apps;
      statApps.textContent = apps.length;
      const active = apps.filter(a=>{
        const st = mapAppStage(a);
        return st !== 'completed';
      }).length;
      const completed = apps.filter(a=> mapAppStage(a) === 'completed').length;
      statActiveApps.textContent = active;
      statCompletedApps.textContent = completed;

      if (!apps.length) {
        appsEl.innerHTML =
          '<div class="muted small-text">No applications yet for this user.</div>';
        overviewActivity.innerHTML = '<div class="muted small-text">No application activity yet.</div>';
        renderCurrentJourney([]);
        return;
      }

      appsEl.innerHTML = apps.map(app=>{
        const job = app.jobs || {};
        const jobTitle = job.title || 'Application';
        const jobLocation =
          job.city && job.country ? `${job.city}, ${job.country}` : job.country || job.city || '—';
        const stage = mapAppStage(app);
        const status = app.status || 'submitted';
        const tracking = app.tracking_id || null;
        const created = app.created_at ? new Date(app.created_at).toLocaleString() : '—';
        const badgeClass =
          stage === 'completed' ? 'success' :
          (status === 'failed' || status === 'rejected') ? 'danger' :
          'warning';

        const hasSuccessForThisApp = userPayments.some(p=>{
          const meta = p.metadata || {};
          return p.status === 'success' && meta.application_id === app.id;
        });

        const canPayNow = !isAdminViewingOther && (stage === 'accepted' || stage === 'application') && !hasSuccessForThisApp;

        const payLink = canPayNow
          ? `/views/pages/payments.html?type=job&job_id=${encodeURIComponent(app.job_id || '')}&application_id=${encodeURIComponent(app.id)}&tracking=${encodeURIComponent(tracking || '')}&from=profile`
          : null;

        return `
          <article class="app-card">
            <div class="top">
              <div>
                <strong>${jobTitle}</strong>
                <div class="meta">
                  <span>${app.plan || 'Plan'}</span>
                  <span>${app.application_type || 'Application'}</span>
                  <span>${jobLocation}</span>
                  <span>${stageLabel(stage)}</span>
                </div>
              </div>
              <div>
                <span class="badge ${badgeClass}">${status}</span>
              </div>
            </div>
            <div class="meta">
              <span><i class="fa fa-calendar"></i> ${created}</span>
              ${tracking ? `<span><i class="fa fa-location-dot"></i> Tracking: ${tracking}</span>` : ''}
            </div>
            <div class="toolbar" style="margin-top:.3rem;gap:.35rem;flex-wrap:wrap;">
              ${tracking ? `<a class="btn outline btn-sm" href="/views/pages/tracking.html?tracking=${encodeURIComponent(tracking)}"><i class="fa fa-location-arrow"></i> Open tracking</a>`:''}
              ${payLink ? `<a class="btn outline btn-sm" href="${payLink}"><i class="fa fa-credit-card"></i> Pay now</a>`:''}
            </div>
          </article>
        `;
      }).join('');

      const latest = apps[0];
      const latestStage = mapAppStage(latest);
      const latestCreated = latest.created_at ? new Date(latest.created_at).toLocaleString() : '—';
      overviewActivity.innerHTML = `
        <div class="timeline">
          <div class="timeline-item">
            <strong>Latest application — ${latest.jobs?.title || 'Application'}</strong>
            <span>${latestCreated} · ${stageLabel(latestStage)}</span>
          </div>
        </div>
      `;

      renderCurrentJourney(apps);
    }

    async function loadApps() {
      if (!viewedUserId || !appsEl) return;
      try{
        const { data, error } = await sb
          .from('applications')
          .select(`
            id,
            user_id,
            job_id,
            status,
            plan,
            application_type,
            tracking_id,
            progress,
            details,
            created_at,
            jobs:job_id ( id, title, country, city )
          `)
          .eq('user_id', viewedUserId)
          .order('created_at', { ascending: false });
        if (error) throw error;
        const rows = data || [];
        renderApplications(rows);
      }catch(e){
        console.error(e);
        appsEl.innerHTML = '<div class="muted small-text">Failed to load applications.</div>';
      }
    }

    function renderPayments(list) {
      userPayments = list;
      const pending = list.filter(p=>p.status==='pending').length;
      statPendingPayments.textContent = pending;

      if (!list.length) {
        paysEl.innerHTML = '<p class="muted small-text">No payments on record yet for this user.</p>';
        return;
      }

      const html = list.map(p=>{
        const meta = p.metadata || {};
        const amountStr = formatAmount(p.amount,p.currency);
        const created = p.created_at ? new Date(p.created_at).toLocaleString() : '—';
        const statusClass = p.status==='success' ? 'success' : p.status==='failed' ? 'danger' : 'warning';
        const channelLabel =
          p.channel==='paystack' ? 'Paystack' :
          p.channel==='momo_auto' ? 'MoMo automatic' :
          p.channel==='momo_manual' ? 'MoMo manual' :
          p.channel || 'Payment';
        const title = meta.title || meta.description || 'Payment';

        const appLink = meta.tracking_id
          ? `<a href="/views/pages/tracking.html?tracking=${encodeURIComponent(meta.tracking_id)}" class="btn outline btn-sm"><i class="fa fa-location-arrow"></i> View tracking</a>`
          : '';

        return `
          <article class="pay-card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
              <div>
                <strong>${title}</strong>
                <div class="small-text">${channelLabel} · Ref: ${p.ref}</div>
              </div>
              <div style="text-align:right;">
                <div>${amountStr}</div>
                <span class="badge ${statusClass}">${p.status}</span>
              </div>
            </div>
            <div class="small-text">
              <span><i class="fa fa-calendar"></i> ${created}</span>
            </div>
            <div class="toolbar" style="margin-top:.25rem;">
              ${appLink}
            </div>
          </article>
        `;
      }).join('');

      paysEl.innerHTML = html;
    }

    async function loadPays() {
      if (!viewedUserId || !paysEl) return;
      try{
        const { data, error } = await sb
          .from('payments')
          .select('id,ref,status,amount,currency,channel,metadata,created_at,user_id')
          .eq('user_id', viewedUserId)
          .order('created_at', { ascending:false });
        if (error) throw error;
        const rows = data || [];
        renderPayments(rows);
      }catch(e){
        console.error(e);
        paysEl.innerHTML='<p class="muted small-text">Failed to load payments.</p>';
      }
    }

    function renderTestimonials(list) {
      userTests = list;
      if (!list.length) {
        testsEl.innerHTML='<p class="muted small-text">No testimonials yet for this user.</p>';
        return;
      }

      testsEl.innerHTML = list.map(t=>{
        const when = t.created_at ? new Date(t.created_at).toLocaleString() : '';
        return `
          <article class="test-card">
            <div>${t.text || ''}</div>
            <div class="small-text">${when}</div>
          </article>
        `;
      }).join('');
    }

    async function loadTests() {
      if (!viewedUserId || !testsEl) return;
      try{
        const { data, error } = await sb
          .from('testimonials')
          .select('id,text,created_at,user_id')
          .eq('user_id', viewedUserId)
          .order('created_at', { ascending:false });
        if (error) throw error;
        renderTestimonials(data || []);
      }catch(e){
        console.error(e);
        testsEl.innerHTML='<p class="muted small-text">Failed to load testimonials.</p>';
      }
    }

    document.getElementById('tAdd')?.addEventListener('click', async () => {
      const txt = document.getElementById('tText').value.trim();
      if (!txt) {
        setStatus('Please enter text', 'danger');
        return;
      }
      if (isAdminViewingOther) {
        setStatus('You cannot post testimonials on behalf of another user from here.', 'danger');
        return;
      }
      try{
        const { error } = await sb.from('testimonials').insert({ user_id: viewedUserId, text: txt });
        if (error) throw error;
        setStatus('Testimonial submitted', 'success');
        document.getElementById('tText').value = '';
        await loadTests();
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to save testimonial.', 'danger');
      }
    });

    /* Tabs */
    document.querySelectorAll('.tab-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach((p) => p.classList.remove('active'));
        document.getElementById(`tab-${tab}`)?.classList.add('active');
      });
    });

    /* Modals & profile actions */
    function trapFocus(container) {
      const focusable = container.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      function handler(e) {
        if (e.key !== 'Tab') return;
        if (e.shiftKey) {
          if (document.activeElement === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
      container.addEventListener('keydown', handler);
      first && first.focus();
    }

    btnEditProfile?.addEventListener('click', () => {
      if (isAdminViewingOther) {
        showToast('This editor only updates your own account. Use admin panel for other users.');
        return;
      }
      nameModal.style.display = 'flex';
      document.getElementById('newName').value = userProfile?.fullname || userProfile?.name || viewedUserEmail || '';
      trapFocus(nameModal);
    });
    btnAbout?.addEventListener('click', () => {
      aboutModal.style.display = 'flex';
      trapFocus(aboutModal);
    });
    editPasswordBtn?.addEventListener('click', () => {
      if (isAdminViewingOther) {
        showToast('You cannot change another user’s password here.');
        return;
      }
      passwordModal.style.display = 'flex';
      trapFocus(passwordModal);
    });
    editAvatarBtn?.addEventListener('click', () => {
      if (isAdminViewingOther) {
        showToast('You cannot change another user’s avatar here.');
        return;
      }
      avatarModal.style.display = 'flex';
      trapFocus(avatarModal);
    });
    editCoverBtn?.addEventListener('click', () => {
      if (isAdminViewingOther) {
        showToast('You cannot change another user’s cover here.');
        return;
      }
      coverModal.style.display = 'flex';
      trapFocus(coverModal);
    });

    document.getElementById('cancelName')?.addEventListener('click', () => {
      nameModal.style.display = 'none';
    });
    document.getElementById('cancelPassword')?.addEventListener('click', () => {
      passwordModal.style.display = 'none';
    });
    document.getElementById('cancelAvatar')?.addEventListener('click', () => {
      avatarModal.style.display = 'none';
    });
    document.getElementById('cancelCover')?.addEventListener('click', () => {
      coverModal.style.display = 'none';
    });
    document.getElementById('closeAbout')?.addEventListener('click', () => {
      aboutModal.style.display = 'none';
    });

    [nameModal, passwordModal, avatarModal, coverModal, aboutModal].forEach((mod) => {
      mod?.addEventListener('click', (e) => {
        if (e.target === mod) mod.style.display = 'none';
      });
    });

    document.getElementById('saveName')?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        setStatus('Name changes here affect only your own account.', 'danger');
        return;
      }
      const newName = document.getElementById('newName').value.trim();
      if (!newName) {
        setStatus('Enter a name', 'danger');
        return;
      }
      try{
        const { error } = await sb.from('users').update({ fullname: newName }).eq('id', sessionUser.id);
        if (error) throw error;
        setStatus('Name updated', 'success');
        nameModal.style.display = 'none';
        if (!isAdminViewingOther) {
          const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
          if (!uErr && data) {
            viewedUser = data;
          }
          await loadProfile();
        }
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update name', 'danger');
      }
    });

    document.getElementById('savePassword')?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        setStatus('You cannot change another user’s password here.', 'danger');
        return;
      }
      const newPass = document.getElementById('newPassword').value.trim();
      if (!newPass || newPass.length < 8) {
        setStatus('Enter a password of at least 8 characters', 'danger');
        return;
      }
      try{
        const { error } = await sb.auth.updateUser({ password: newPass });
        if (error) throw error;
        setStatus('Password updated', 'success');
        passwordModal.style.display = 'none';
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update password', 'danger');
      }
    });

    document.getElementById('saveAvatar')?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        setStatus('You cannot change another user’s avatar here.', 'danger');
        return;
      }
      const file = document.getElementById('newAvatar').files[0];
      if (!file) {
        setStatus('Please select an image', 'danger');
        return;
      }
      const fileName = `${sessionUser.id}-avatar-${Date.now()}.png`;
      try{
        const { error: uploadError } = await sb.storage.from('avatars').upload(fileName, file, {
          upsert: true
        });
        if (uploadError) throw uploadError;
        const { data: pub } = sb.storage.from('avatars').getPublicUrl(fileName);
        const url = pub.publicUrl;
        const { error } = await sb.from('users').update({ avatar_url: url }).eq('id', sessionUser.id);
        if (error) throw error;
        setStatus('Avatar updated', 'success');
        avatarModal.style.display = 'none';
        if (!isAdminViewingOther) {
          const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
          if (!uErr && data) {
            viewedUser = data;
          }
          await loadProfile();
        }
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update avatar', 'danger');
      }
    });

    document.getElementById('saveCover')?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        setStatus('You cannot change another user’s cover here.', 'danger');
        return;
      }
      const file = document.getElementById('newCover').files[0];
      if (!file) {
        setStatus('Please select an image', 'danger');
        return;
      }
      const fileName = `${sessionUser.id}-cover-${Date.now()}.png`;
      try{
        const { error: uploadError } = await sb.storage.from('covers').upload(fileName, file, {
          upsert: true
        });
        if (uploadError) throw uploadError;
        const { data: pub } = sb.storage.from('covers').getPublicUrl(fileName);
        const url = pub.publicUrl;
        const { error } = await sb.from('users').update({ cover: url }).eq('id', sessionUser.id);
        if (error) throw error;
        setStatus('Cover photo updated', 'success');
        coverModal.style.display = 'none';
        if (!isAdminViewingOther) {
          const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
          if (!uErr && data) {
            viewedUser = data;
          }
          await loadProfile();
        }
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update cover', 'danger');
      }
    });

    profileForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isAdminViewingOther) {
        setStatus('Profile edits here apply only to your own account.', 'danger');
        return;
      }
      if (!sessionUser?.id) {
        setStatus('Please log in first', 'danger');
        return;
      }
      const fullname = inputFullname.value.trim() || null;
      const phone = inputPhone.value.trim() || null;
      const country = inputCountry.value.trim() || null;

      try{
        setStatus('Saving profile...', 'muted');
        const { error } = await sb
          .from('users')
          .update({ fullname, phone, country })
          .eq('id', sessionUser.id);
        if (error) throw error;
        setStatus('Profile updated', 'success');
        if (!isAdminViewingOther) {
          const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
          if (!uErr && data) {
            viewedUser = data;
          }
          await loadProfile();
        }
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update profile', 'danger');
      }
    });

    quickTrackBtn?.addEventListener('click', () => {
      const t = quickTrackInput.value.trim();
      if (!t) {
        showToast('Enter a tracking ID first.');
        return;
      }
      window.location.href = `/views/pages/tracking.html?tracking=${encodeURIComponent(t)}`;
    });

    quickTrackInput?.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        quickTrackBtn?.click();
      }
    });

    async function toggleFollowElite() {
      if (!sessionUser?.id) {
        showToast('Log in to follow Elite updates.');
        return;
      }

      try{
        const { error } = await sb.from('followers').insert({
          follower_id: sessionUser.id,
          target_type: 'brand',
          target_id: 'd9dfb9cd-2f74-4541-9cc8-8fc5fbc62257',
          meta: { source: 'profile_follow_button' }
        });
        if (error && !/duplicate|unique/i.test(error.message)) {
          followStatus.textContent = error.message;
          followStatus.className = 'muted small-text danger';
          return;
        }

        followStatus.textContent = 'You are following Elite updates. We will send you new jobs and important changes.';
        followStatus.className = 'muted small-text success';
        showToast('You are now following Elite updates.');
      }catch(e){
        console.error(e);
        followStatus.textContent = e.message || 'Failed to follow Elite updates.';
        followStatus.className = 'muted small-text danger';
      }
    }

    followEliteBtn?.addEventListener('click', toggleFollowElite);
    followBtn?.addEventListener('click', toggleFollowElite);

    markAllReadBtn?.addEventListener('click', async ()=>{
      if (!viewedUserId) return;
      await markAllNotificationsRead(viewedUserId);
    });

    clearAllNotifBtn?.addEventListener('click', async ()=>{
      if (!viewedUserId) return;
      if (!confirm('Clear all notifications for this account?')) return;
      await clearAllNotifications(viewedUserId);
    });

    document.getElementById('refreshAppsBtn')?.addEventListener('click', loadApps);
    document.getElementById('refreshPaysBtn')?.addEventListener('click', loadPays);
    document.getElementById('refreshTestsBtn')?.addEventListener('click', loadTests);

    (async ()=>{
      const ok = await fetchSessionAndRole();
      if (!ok) return;

      const viewedOk = await resolveViewedUser();
      if (!viewedOk) return;

      await loadInitialNotifications(viewedUserId);
      await subscribeNotifications(viewedUserId);

      await loadProfile();
      await loadPays();
      await loadApps();
      await loadTests();
    })();
  </script>
</body>
</html>
