<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Update Password — Elite Travel & Tour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Securely update your Elite Travel & Tour account password"/>
  <link rel="stylesheet" href="/icons/fontawesome.min.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/pages.css">
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="/src/js/supabase.js"></script>

  <!-- Standard ICO -->
<link rel="icon" href="/favicon.ico" type="image/x-icon">

<!-- Or PNG -->
<link rel="icon" href="/favicon.png" type="image/png">

<!-- Optional: SVG -->
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<style>
    .page-title{ font-size:1.8rem; margin-bottom:.4rem; }
    .tracking-card{ max-width:700px; margin:2rem auto; }

    .form-grid{ display:grid; gap:1rem; max-width:400px; margin:auto; }
    .form-grid .input{ border-radius:10px; }
    .form-grid .btn{ border-radius:10px; }

    .input[disabled]{ opacity:.6; cursor:not-allowed; }
    .btn[disabled]{ opacity:.7; cursor:not-allowed; }

    .helper-text{ font-size:.9rem; color:var(--muted); margin-top:.15rem; }

    .alert{
      margin-top:.75rem;
      padding:.6rem .75rem;
      border-radius:10px;
      border:1px solid var(--gray-300);
      background:#fff;
      font-size:.9rem;
    }
    .alert.info{
      border-color:#cfe6ff;
      background:#f2f8ff;
      color:#0a4d7a;
    }
    .alert.success{
      border-color:#bde5cb;
      background:#e7f7ee;
      color:#155724;
    }
    .alert.danger{
      border-color:#f4c7c8;
      background:#fdecec;
      color:#8a1c1d;
    }
    .alert.warning{
      border-color:#facc15;
      background:#fffbeb;
      color:#92400e;
    }

    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,.6);
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .modal .card{ max-width:400px; width:90%; }

    .toast{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#0b1120;
      color:#e5e7eb;
      padding:.75rem 1rem;
      border-radius:999px;
      box-shadow:0 16px 40px rgba(15,23,42,.85);
      z-index:2000;
      display:none;
      max-width:90vw;
      font-size:.85rem;
    }
    .toast.show{ display:flex; align-items:center; gap:.6rem; }
    .toast i{ color:#38bdf8; }

    .small-muted{ font-size:.85rem; color:var(--muted); margin-top:.35rem; }
  </style>
</head>
<body>
  <nav aria-label="Primary">
    <div class="wrap">
      <a class="logo" href="/"><img src="/assets/logo/logo.png" alt="Elite Travel & Tour"></a>
      <ul class="primary">
        <li><a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a></li>
        <li><a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a></li>
        <li><a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a></li>
        <li><a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a></li>
        <li><a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a></li>
        <li><a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a></li>
      </ul>
      <div class="nav-right">
        <button id="bellBtn" class="btn outline bell" aria-label="Notifications">
          <i class="fa-regular fa-bell"></i>
          <span id="bellCount" class="count hidden">0</span>
        </button>
        <span id="authStatus" class="auth-pill" style="display:none;">
          <i class="fa fa-user-check"></i><span class="auth-text">Guest</span>
        </span>
        <button id="loginBtn" class="btn outline"><i class="fa fa-right-to-bracket"></i> Login</button>
        <button id="profileBtn" class="btn outline" style="display:none"><i class="fa fa-user"></i></button>
        <button id="logoutBtn" class="btn outline" style="display:none"><i class="fa fa-right-from-bracket"></i> Logout</button>
        <button id="menuToggle" class="menu-toggle" aria-expanded="false"><i class="fa fa-bars"></i></button>
      </div>
    </div>

    <!-- Mobile panel -->
    <div id="mobilePanel" class="mobile-panel">
      <div class="block">
        <a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a>
        <a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a>
        <a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a>
        <a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a>
        <a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a>
        <a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a>
      </div>
      <div class="block">
        <span class="auth-pill"><i class="fa fa-user"></i><span id="mobileAuthText">Guest</span></span>
        <div class="toolbar">
          <button id="mobileLoginBtn" class="btn brand"><i class="fa fa-right-to-bracket"></i> Login</button>
          <button id="mobileProfileBtn" class="btn outline" style="display:none"><i class="fa fa-user"></i> Profile</button>
          <button id="mobileLogoutBtn" class="btn outline" style="display:none"><i class="fa fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div id="notifFeed" class="feed hidden">
    <h4>Notifications</h4>
    <div id="notifList" class="list"></div>
  </div>

  <div class="container">
    <section class="card tracking-card">
      <div class="body">
        <h2 class="page-title">Update Password</h2>
        <p class="muted" id="pageHint">
          We’re verifying your reset link. If everything looks good, you can set a new password below.
        </p>

        <form id="updateForm" class="form-grid" novalidate>
          <div>
            <input class="input" type="password" id="newPassword" placeholder="New password" required autocomplete="new-password">
            <div class="helper-text">Use at least 8 characters. Mix letters, numbers, and symbols for stronger security.</div>
          </div>
          <div>
            <input class="input" type="password" id="confirmPassword" placeholder="Confirm password" required autocomplete="new-password">
          </div>
          <button type="submit" class="btn brand" id="updateBtn">
            <i class="fa fa-lock"></i> Update Password
          </button>
          <div id="statusMsg" class="alert info" role="status" aria-live="polite" style="display:none;"></div>
        </form>

        <p class="small-muted">
          If this page was opened accidentally or you did not request a password reset, you can safely close this tab.
        </p>
      </div>
    </section>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <section class="card">
      <div class="body">
        <h3 id="confirmTitle">Password Updated</h3>
        <p>Your password has been successfully changed. You can now log in with your new credentials.</p>
        <div class="toolbar" style="display:flex;gap:.5rem;justify-content:flex-end;">
          <button class="btn outline" id="closeModal"><i class="fa fa-xmark"></i> Close</button>
          <a href="/views/pages/login.html" class="btn brand" id="goLogin"><i class="fa fa-sign-in-alt"></i> Go to Login</a>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <i class="fa fa-info-circle"></i><span id="toastText">Notice</span>
  </div>

  <!-- Footer -->
  <footer id="footer">
    <div class="grid">
      <div>
        <h4>Elite Travel & Tour</h4>
        <p>Trusted partner for seamless journeys worldwide.</p>
        <p class="muted">Visa assistance, Work & Pay programs, and flight bookings with premium support.</p>
      </div>
      <div>
        <h4>Quick Links</h4>
        <ul>
          <li><a href="/views/pages/services.html">Services</a></li>
          <li><a href="/views/pages/work-and-pay.html">Work & Pay</a></li>
          <li><a href="/views/pages/appointment.html">Book Appointment</a></li>
          <li><a href="/views/pages/contact.html">Contact</a></li>
          <li><a href="/views/pages/about.html">About</a></li>
        </ul>
      </div>
      <div>
        <h4>Contact</h4>
        <p><i class="fa fa-phone"></i> +233 59 911 7007</p>
        <p><i class="fa fa-envelope"></i> info@elitetravel.com</p>
        <p><i class="fa fa-map-marker-alt"></i> Adabraka Akasanoma rd, Greater Accra, Ghana</p>
        <div class="newsletter">
          <label for="newsletterEmail" class="muted">Subscribe to our newsletter:</label><br>
          <input id="newsletterEmail" type="email" placeholder="Your email">
          <button id="subscribeBtn"><i class="fa fa-paper-plane"></i> Subscribe</button>
        </div>
        <div id="subscribeMsg" class="muted" style="margin-top:.5rem;"></div>
      </div>
      <div>
        <h4>Resources</h4>
        <ul class="list">
          <li><a href="/views/pages/profile.html">Profile</a></li>
          <li><a href="/views/pages/tracking.html">Tracking</a></li>
          <li><a href="/views/pages/privacy.html">Privacy Policy</a></li>
          <li><a href="/views/pages/terms.html">Terms of Service</a></li>
        </ul>
      </div>
      <div class="social">
        <h4>Follow Us</h4>
        <div class="toolbar">
          <a href="#"><i class="fa-brands fa-facebook"></i></a>
          <a href="#"><i class="fa-brands fa-x-twitter"></i></a>
          <a href="#"><i class="fa-brands fa-instagram"></i></a>
          <a href="#"><i class="fa-brands fa-linkedin"></i></a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">© <span id="year"></span> Elite Travel & Tour. All rights reserved.</div>
  </footer>

  <script>
    // Dynamic year + newsletter
    document.getElementById('year').textContent=new Date().getFullYear();
    const subscribeBtn=document.getElementById('subscribeBtn');
    const eemailInput=document.getElementById('newsletterEmail');
    const subscribeMsg=document.getElementById('subscribeMsg');
    subscribeBtn?.addEventListener('click',()=>{
      const eemail=eemailInput.value.trim();
      if(!eemail){
        subscribeMsg.textContent="Please enter your email.";
        subscribeMsg.style.color="red";
        return;
      }
      subscribeMsg.textContent=`Thank you for subscribing, ${eemail}!`;
      subscribeMsg.style.color="lightgreen";
      eemailInput.value="";
    });
  </script>

  <script type="module">
    import { sb } from '/src/js/supabase.js';

    const RESET_URL = '/views/pages/reset-password.html';

    const form = document.getElementById('updateForm');
    const statusMsg = document.getElementById('statusMsg');
    const pageHint = document.getElementById('pageHint');
    const updateBtn = document.getElementById('updateBtn');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');

    const confirmModal = document.getElementById('confirmModal');
    const closeModalBtn = document.getElementById('closeModal');

    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');

    function showToast(message, ms=2500){
      toastText.textContent=message;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), ms);
    }

    function setStatus(text, type='info'){
      if(!text){
        statusMsg.style.display='none';
        statusMsg.textContent='';
        statusMsg.className='alert info';
        return;
      }
      statusMsg.textContent=text;
      statusMsg.className=`alert ${type}`;
      statusMsg.style.display='block';
    }

    function setFormEnabled(enabled){
      [newPasswordInput, confirmPasswordInput, updateBtn].forEach(el=>{
        if(!el) return;
        el.disabled = !enabled;
      });
      if(enabled){
        updateBtn.innerHTML='<i class="fa fa-lock"></i> Update Password';
      }else{
        updateBtn.innerHTML='<i class="fa fa-spinner fa-spin"></i> Please wait...';
      }
    }

    function trapFocus(modal){
      const focusable = modal.querySelectorAll('a[href],button,textarea,input,select,[tabindex]:not([tabindex="-1"])');
      if(!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length-1];
      function keyHandler(e){
        if(e.key!=='Tab') return;
        if(e.shiftKey){
          if(document.activeElement===first){
            e.preventDefault();
            last.focus();
          }
        }else{
          if(document.activeElement===last){
            e.preventDefault();
            first.focus();
          }
        }
      }
      modal.addEventListener('keydown', keyHandler);
      first.focus();
    }

    function openModal(m){
      m.style.display='flex';
      trapFocus(m);
    }
    function closeModal(m){
      m.style.display='none';
    }

    // Basic header/mobile toggles (minimal)
    const menuToggle=document.getElementById('menuToggle');
    const mobilePanel=document.getElementById('mobilePanel');
    menuToggle?.addEventListener('click',()=>{
      const isOpen=mobilePanel.classList.toggle('open');
      menuToggle.setAttribute('aria-expanded',String(isOpen));
    });
    mobilePanel?.addEventListener('click',(e)=>{
      if(e.target.matches('a')){
        mobilePanel.classList.remove('open');
        menuToggle.setAttribute('aria-expanded','false');
      }
    });

    // Minimal auth UI: we just reflect if user is logged in (optional)
    const loginBtn=document.getElementById('loginBtn');
    const logoutBtn=document.getElementById('logoutBtn');
    const profileBtn=document.getElementById('profileBtn');
    const mobileLoginBtn=document.getElementById('mobileLoginBtn');
    const mobileLogoutBtn=document.getElementById('mobileLogoutBtn');
    const mobileProfileBtn=document.getElementById('mobileProfileBtn');
    const authText=document.querySelector('#authStatus .auth-text');
    const authStatus=document.getElementById('authStatus');
    const mobileAuthText=document.getElementById('mobileAuthText');

    function updateAuthUI(session){
      const user=session?.user;
      if(user){
        if(authText) authText.textContent=user.email;
        authStatus?.style.setProperty('display','inline-flex');
        if(mobileAuthText) mobileAuthText.textContent=user.email;

        loginBtn?.style.setProperty('display','none');
        logoutBtn?.style.setProperty('display','inline-flex');
        profileBtn?.style.setProperty('display','inline-flex');

        mobileLoginBtn?.style.setProperty('display','none');
        mobileLogoutBtn?.style.setProperty('display','inline-flex');
        mobileProfileBtn?.style.setProperty('display','inline-flex');

        profileBtn.onclick=()=> window.location.href=`/views/pages/user/profile.html?id=${user.id}`;
        mobileProfileBtn.onclick=()=> window.location.href=`/views/pages/user/profile.html?id=${user.id}`;
      }else{
        if(authText) authText.textContent='Guest';
        authStatus?.style.setProperty('display','none');
        if(mobileAuthText) mobileAuthText.textContent='Guest';

        loginBtn?.style.setProperty('display','inline-flex');
        logoutBtn?.style.setProperty('display','none');
        profileBtn?.style.setProperty('display','none');

        mobileLoginBtn?.style.setProperty('display','inline-flex');
        mobileLogoutBtn?.style.setProperty('display','none');
        mobileProfileBtn?.style.setProperty('display','none');
      }
    }

    loginBtn?.addEventListener('click',()=> window.location.href='/views/pages/login.html');
    mobileLoginBtn?.addEventListener('click',()=> window.location.href='/views/pages/login.html');
    logoutBtn?.addEventListener('click',async()=>{
      await sb.auth.signOut();
      updateAuthUI(null);
      window.location.href='/views/pages/login.html';
    });
    mobileLogoutBtn?.addEventListener('click',async()=>{
      await sb.auth.signOut();
      updateAuthUI(null);
      window.location.href='/views/pages/login.html';
    });

    // Notifications toggle (minimal)
    document.addEventListener('click',(e)=>{
      const feed=document.getElementById('notifFeed');
      if(!feed) return;
      if(e.target.closest('#bellBtn')){
        feed.classList.toggle('hidden');
      }else if(!e.target.closest('#notifFeed')){
        feed.classList.add('hidden');
      }
    });

    // Initial state: disable form while verifying token/session
    setFormEnabled(false);
    setStatus('Verifying your reset link. Please wait...', 'info');

    // Deep check: verify we have a valid session from the reset link
    (async()=>{
      const { data:{ session }, error } = await sb.auth.getSession();
      updateAuthUI(session);

      if(error){
        setStatus('We could not verify your reset link. Redirecting to request a new one...', 'danger');
        showToast('Reset link check failed. Redirecting...', 3500);
        setTimeout(()=> window.location.href=RESET_URL, 5000);
        return;
      }

      if(!session || !session.user){
        // Option C: show error, then redirect after a delay
        setStatus('Your reset link is invalid or has expired. You will be redirected to request a new link.', 'danger');
        pageHint.textContent='Reset link invalid or expired. You will be redirected shortly.';
        showToast('Reset link expired. Request a new one.', 3500);
        setFormEnabled(false);
        setTimeout(()=> window.location.href=RESET_URL, 5000);
        return;
      }

      // Session looks valid – enable form
      setStatus('Link verified. Please create a new password to secure your account.', 'info');
      pageHint.textContent='Create a new password for your Elite Travel & Tour account.';
      setFormEnabled(true);
    })();

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const pass = newPasswordInput.value.trim();
      const confirm = confirmPasswordInput.value.trim();

      if(!pass || !confirm){
        setStatus('Please fill both password fields.', 'danger');
        return;
      }
      if(pass.length < 8){
        setStatus('Password must be at least 8 characters long.', 'danger');
        return;
      }
      if(pass !== confirm){
        setStatus('Passwords do not match.', 'danger');
        return;
      }

      setFormEnabled(false);
      setStatus('Updating your password. Please wait...', 'info');

      try{
        const { error } = await sb.auth.updateUser({ password: pass });
        if(error){
          setStatus(error.message || 'Failed to update password. Please try again.', 'danger');
          showToast('Failed to update password.', 3000);
          setFormEnabled(true);
        }else{
          setStatus('Your password has been updated successfully.', 'success');
          showToast('Password updated.', 2500);
          form.reset();
          openModal(confirmModal);
        }
      }catch(err){
        setStatus('Something went wrong. Please try again.', 'danger');
        showToast('Unexpected error while updating password.', 3000);
        setFormEnabled(true);
      }
    });

    // Modal interactions
    closeModalBtn.addEventListener('click', ()=> closeModal(confirmModal));
    confirmModal.addEventListener('click',(e)=>{
      if(e.target===confirmModal) closeModal(confirmModal);
    });

    // Keyboard accessibility: Enter submits
    form.addEventListener('keydown',(e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
      }
    });
  </script>
</body>
</html>
