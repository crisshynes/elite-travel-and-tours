<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>User Profile — Elite Travel & Tour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Your Elite Travel & Tour profile: applications, tracking, payments, notifications, appointments, testimonials, and account settings with realtime updates."/>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <style>
    /* :root{
      --brand:#1d4ed8;
      --brand-600:#0f172a;
      --bg:#ffffff;
      --muted:#6b7280;
      --light:#64748b;
      --warning:#fbbf24;
      --success:#22c55e;
      --danger:#ef4444;
      --shadow:0 8px 24px rgba(2,6,23,.08);
    } */
    body{margin-top:100px;} 
    .page-wrap{max-width:1100px;margin:1.3rem auto 2rem;padding:0 1rem;}
    .profile-layout{margin-top:.5rem;display:grid;grid-template-columns:minmax(0,1.9fr) minmax(0,1.1fr);gap:1rem;}
    @media(max-width:980px){.profile-layout{grid-template-columns:1fr;}}

    /* Cards */
    /* .card{background:#ffffff;border-radius:14px;border:1px solid #e5e7eb;box-shadow:0 18px 40px rgba(15,23,42,.12);overflow:hidden;}
    .card .body{padding:1rem 1.1rem 1.1rem;} */

    /* Hero */
    .profile-hero{position:relative;padding:1.1rem 1.1rem 0.9rem;display:grid;gap:.5rem;background:linear-gradient(180deg,#0b1221,#0f172a);}
    .hero-cover{position:relative;border-radius:18px;height:170px;overflow:hidden;background:radial-gradient(circle at top,#1d4ed8,#020617);}
    .hero-cover img{width:100%;height:100%;object-fit:cover;opacity:.96;filter:contrast(1.02) saturate(1.02);}
    .hero-cover::after{content:"";position:absolute;inset:0;background:linear-gradient(to bottom,rgba(15,23,42,.05),rgba(15,23,42,.6));mix-blend-mode:multiply;}
    .hero-main{display:flex;justify-content:space-between;align-items:flex-end;margin-top:-6px;gap:1rem;flex-wrap:wrap;}
    .hero-left{display:flex;gap:.75rem;align-items:flex-end;}
    .hero-avatar{width:78px;height:78px;border-radius:50%;border:3px solid #fff;overflow:hidden;box-shadow:0 16px 35px rgba(15,23,42,.45);background:#020617;}
    .hero-avatar img{width:100%;height:100%;object-fit:cover;}
    .hero-meta h2{margin:0;font-size:1.35rem;color:#f9fafb;}
    .hero-meta p{margin:.15rem 0 0;font-size:.9rem;color:#e5e7eb;}
    .hero-meta .tags{margin-top:.3rem;display:flex;gap:.4rem;flex-wrap:wrap;}
    .hero-meta .tags span{font-size:.78rem;padding:.12rem .45rem;border-radius:999px;background:rgba(15,23,42,.75);color:#e5e7eb;border:1px solid rgba(148,163,184,.7);}
    .hero-actions{display:flex;gap:.4rem;flex-wrap:wrap;}
    .hero-stats{display:flex;justify-content:space-between;gap:.6rem;margin-top:.75rem;flex-wrap:wrap;}
    .stat-pill{flex:1 1 110px;min-width:0;background:#0f172a;border-radius:12px;box-shadow:0 14px 30px rgba(15,23,42,.7);padding:.6rem .7rem;}
    .stat-pill span.label{font-size:.78rem;color:#e5e7eb;}
    .stat-pill div.value{font-size:1.1rem;font-weight:700;color:#fbbf24;}

    .tabs{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #e5e7eb;margin-top:.65rem;}
    .tab-list{display:flex;gap:.5rem;flex-wrap:wrap;}
    .tab-btn{border:none;background:transparent;padding:.45rem .65rem;border-radius:999px;font-size:.9rem;color:var(--brand);cursor:pointer;}
    .tab-btn.active{background:#1d4ed8;color:#eff6ff;font-weight:600;}
    .tab-panel{display:none;padding-top:.75rem;}
    .tab-panel.active{display:block;}

    .section-title{font-size:1.05rem;margin:0 0 .3rem;}
    .muted{color:var(--muted);}
    .small-text{font-size:.8rem;}

    .about-grid{display:grid;gap:.6rem;grid-template-columns:1.1fr 1.2fr;}
    @media(max-width:780px){.about-grid{grid-template-columns:1fr;}}

    .list-simple{list-style:none;padding:0;margin:0;}
    .list-simple li{padding:.45rem 0;border-bottom:1px solid #edf1f7;font-size:.9rem;display:flex;justify-content:space-between;gap:.5rem;}
    .list-simple li:last-child{border-bottom:none;}
/* 
    .apps-grid{display:grid;gap:.6rem;}
    .app-card{border-radius:12px;border:1px solid rgba(15,23,42,.06);padding:.6rem .7rem;background:var(--bg);display:grid;gap:.25rem;box-shadow:var(--shadow);}
    .app-card .top{display:flex;justify-content:space-between;align-items:center;gap:.5rem;}
    .app-card .meta{font-size:.82rem;color:var(--light);display:flex;gap:.5rem;flex-wrap:wrap;} */

    .pay-card,.test-card{border-radius:12px;box-shadow:0 16px 35px rgba(15,23,42,.06);padding:.6rem .7rem;background:var(--bg);font-size:.9rem;display:grid;gap:.2rem;}

    .pill-soft{display:inline-flex;align-items:center;gap:.25rem;padding:.18rem .5rem;border-radius:999px;border:1px solid rgba(15,23,42,.06);background:#f9fafb;font-size:.78rem;color:#92400e;}
    .badge.success{border-color:#22c55e;background:#dcfce7;color:#166534;}
    .badge.danger{border-color:#ef4444;background:#fee2e2;color:#991b1b;}
    .badge.warning{border-color:#fbbf24;background:#fef9c3;color:#92400e;}

    .chip-row{display:flex;gap:.3rem;flex-wrap:wrap;}
    .timeline{margin-top:.4rem;border-left:3px solid var(--warning);padding-left:.6rem;padding-top:5px;padding-bottom:5px;font-size:.82rem;border-radius:4px;box-shadow:0 12px 30px rgba(15,23,42,.08);background:var(--brand-600);}
    .timeline-item{margin-bottom:.35rem;}
    .timeline-item strong{display:block;color:var(--warning);}
    .timeline-item span{color:var(--light);}

    .profile-layout-right .card{margin-bottom:1rem;}
    .widget h3{font-size:1.05rem;margin-bottom:.2rem;}

    /* Inputs */
    .input,.textarea{width:100%;box-sizing:border-box;padding:.55rem .7rem;border-radius:10px;border:1px solid #d1d5db;background:rgba(56,189,248,.35);font-size:.9rem;color:#0b1221;transition:border-color .12s, box-shadow .12s;}
    .input:focus,.textarea:focus{outline:none;border-color:#38bdf8;box-shadow:0 0 0 2px rgba(56,189,248,.35);}
    .textarea{min-height:80px;resize:vertical;}
/* 
    /* Notifications drawer */
    .feed{position:fixed;top:72px;right:24px;width:380px;max-width:92vw;max-height:60vh;display:none;flex-direction:column;gap:.5rem;background:#0b1221;border:1px solid #1f2937;border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,.4);z-index:1200;}
    .feed.open{display:flex;}
    .feed-toolbar{display:flex;justify-content:space-between;align-items:center;padding:.6rem .7rem;border-bottom:1px solid #1f2937;}
    .feed .list{overflow:auto;padding:.6rem .7rem;gap:.5rem;display:flex;flex-direction:column;}
    .feed .list::-webkit-scrollbar{width:8px;}
    .feed .list::-webkit-scrollbar-thumb{background:#1f2937;border-radius:8px;}

    /* Toast */
    .toast{position:fixed;bottom:24px;left:24px;display:flex;align-items:center;gap:.5rem;background:#0b1221;color:#e5e7eb;border:1px solid #1f2937;border-radius:10px;padding:.5rem .7rem;opacity:0;pointer-events:none;transform:translateY(8px);transition:opacity .15s, transform .15s;z-index:1500;}
    .toast.show{opacity:1;transform:translateY(0);pointer-events:auto;}

    /* Buttons */
    /* .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.45rem .65rem;border-radius:10px;border:1px solid #1f2937;background:#0b1221;color:#e5e7eb;cursor:pointer;}
    .btn.brand{background:#1d4ed8;border-color:#1d4ed8;color:#fff;}
    .btn.outline{background:transparent;color:#1d4ed8;border-color:#1d4ed8;}
    .btn.btn-sm{padding:.35rem .55rem;border-radius:9px;font-size:.85rem;} */

    /* Mobile panel */
    /* .mobile-panel{position:fixed;top:0;right:0;width:84vw;max-width:400px;height:100vh;background:#0b1221;box-shadow:-12px 0 40px rgba(2,6,23,.5);transform:translateX(100%);transition:transform .2s ease;z-index:1300;}
    .mobile-panel.open{transform:translateX(0);}
    .mobile-panel .block{padding:1rem;display:grid;gap:.5rem;}
    .mobile-panel a{color:#e5e7eb;text-decoration:none;padding:.6rem;border:1px solid #1f2937;border-radius:10px;} */

    /* Modal base */
    /* .modal{display:none;position:fixed;inset:0;background:rgba(15,23,42,.65);align-items:center;justify-content:center;z-index:1600;}
    .modal .card{max-width:540px;width:92%;border-radius:14px;border:1px solid #e5e7eb;box-shadow:0 24px 60px rgba(15,23,42,.8);background:#ffffff;color:#111827;}
    .modal .body{padding:1rem 1.1rem 1.1rem;}
    .modal h3{margin-top:0;}
    .modal .subtitle{font-size:.85rem;color:#6b7280;} */ 

    /* Edit profile modal sections */
    .edit-grid{display:grid;gap:.6rem;grid-template-columns:1fr 1fr;}
    @media(max-width:700px){.edit-grid{grid-template-columns:1fr;}}

    /* Accessibility helpers */
    .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
  </style>
</head>
<body>
  <!-- Header -->
  <nav aria-label="Primary">
    <div class="wrap">
      <a class="logo" href="/"><img src="/assets/logo/logo.png" alt="Elite Travel & Tour"></a>
      <ul class="primary">
        <li><a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a></li>
        <li><a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a></li>
        <li><a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a></li>
        <li><a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a></li>
        <li><a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a></li>
        <li><a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a></li>
        <li><a href="/views/pages/profile.html" class="active"><i class="fa fa-user"></i> Profile</a></li>
      </ul>
      <div class="nav-right">
        <button id="bellBtn" class="btn outline bell" aria-label="Notifications">
          <i class="fa-regular fa-bell"></i>
          <span id="bellCount" class="count hidden">0</span>
        </button>
        <span id="navAuthPill" class="auth-pill" style="display:none;">
          <i class="fa fa-user-check"></i><span id="navAuthText">Guest</span>
        </span>
        <button id="loginBtn" class="btn outline"><i class="fa fa-right-to-bracket"></i> Login</button>
        <button id="profileBtn" class="btn outline" style="display:none"><i class="fa fa-user"></i></button>
        <button id="logoutBtn" class="btn outline" style="display:none"><i class="fa fa-right-from-bracket"></i></button>
        <button id="menuToggle" class="menu-toggle" aria-expanded="false"><i class="fa fa-bars"></i></button>
      </div>
    </div>

    <!-- Mobile panel -->
    <div id="mobilePanel" class="mobile-panel">
      <div class="block">
        <a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a>
        <a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a>
        <a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a>
        <a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a>
        <a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a>
        <a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a>
        <a href="/views/pages/profile.html" class="active"><i class="fa fa-user"></i> Profile</a>
      </div>
      <div class="block">
        <span class="auth-pill"><i class="fa fa-user"></i><span id="mobileAuthText">Guest</span></span>
        <div class="toolbar" style="margin-top:.4rem;">
          <button id="mobileLoginBtn" class="btn outline"><i class="fa fa-right-to-bracket"></i> Login</button>
          <button id="mobileProfileBtn" class="btn outline" style="display:none"><i class="fa fa-user"></i> Profile</button>
          <button id="mobileLogoutBtn" class="btn outline" style="display:none"><i class="fa fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Notification feed -->
  <div id="notifFeed" class="feed">
    <div class="feed-toolbar">
      <span class="muted small-text">Notifications</span>
      <div style="color:var(--brand);display:flex;gap:.25rem;">
        <button id="markAllReadBtn" class="btn"><i class="fa fa-check-double"></i> Mark as Read</button>
        <button id="clearAllNotifBtn" class="btn"><i class="fa fa-trash"></i> Clear</button>
      </div>
    </div>
    <div id="notifList" class="list"></div>
  </div>
  <script type="module" src="/src/js/notifications.js"></script>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <i class="fa fa-info-circle"></i><span id="toastText">Notice</span>
  </div>

  <div class="page-wrap">
    <main class="profile-layout">
      <!-- Left: Profile + tabs -->
      <section class="card" aria-label="Profile overview and history">
        <div class="profile-hero">
          <div class="hero-cover">
            <img id="profileCoverImg" src="/assets/profile/cover.jpg" alt="Profile cover">
          </div>
          <div class="hero-main">
            <div class="hero-left">
              <div class="hero-avatar">
                <img id="profileAvatarImg" src="/assets/profile/avatar.jpg" alt="Avatar">
              </div>
              <div class="hero-meta">
                <h2 id="profileName">Loading...</h2>
                <p id="profileEmail">—</p>
                <div class="tags">
                  <span id="profileStatusTag"><i class="fa fa-circle-check"></i> Verified account</span>
                  <span id="profileCountryTag" style="display:none;"><i class="fa fa-location-dot"></i> <span id="profileCountryText">Ghana</span></span>
                  <span id="profileModeTag" style="display:none;"><i class="fa fa-shield-halved"></i> Admin viewing</span>
                </div>
              </div>
            </div>
            <div class="hero-actions">
              <button class="btn outline" id="aboutBtn"><i class="fa fa-id-card"></i> About</button>
              <button class="btn outline" id="editProfileBtn"><i class="fa fa-user-pen"></i> Edit profile</button>
              <button class="btn brand" id="followBtn"><i class="fa fa-bell"></i> Follow Elite updates</button>
            </div>
          </div>

          <div class="hero-stats">
            <div class="stat-pill">
              <span class="label">Account age</span>
              <div class="value" id="statAge">–</div>
            </div>
            <div class="stat-pill">
              <span class="label">Applications</span>
              <div class="value" id="statApps">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Active applications</span>
              <div class="value" id="statActiveApps">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Completed</span>
              <div class="value" id="statCompletedApps">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Pending payments</span>
              <div class="value" id="statPendingPayments">0</div>
            </div>
          </div>

          <div class="tabs">
            <div class="tab-list">
              <button class="tab-btn active" data-tab="overview">Overview</button>
              <button class="tab-btn" data-tab="apps">Applications</button>
              <button class="tab-btn" data-tab="appointments">Appointments</button>
              <button class="tab-btn" data-tab="pays">Payments</button>
              <button class="tab-btn" data-tab="tests">Testimonials</button>
            </div>
          </div>
        </div>

        <div class="body">
          <!-- Overview -->
          <section id="tab-overview" class="tab-panel active" aria-label="Overview">
            <div class="about-grid">
              <div>
                <h3 class="section-title">Account details</h3>
                <ul id="profileDetailsList" class="list-simple">
                  <li><span>Email</span><span class="muted">Loading...</span></li>
                </ul>
                <p id="accountIntro" class="muted small-text" style="margin-top:.6rem;">
                  Use this dashboard to track your applications, appointments, payments, and notifications in one place.
                </p>
              </div>
              <div>
                <h3 class="section-title">Profile completeness</h3>
                <div id="completenessRow" class="chip-row">
                  <span class="pill-soft"><i class="fa fa-circle-notch"></i> Loading...</span>
                </div>
              </div>
            </div>

            <div style="margin-top:1rem;">
              <h3 class="section-title">Current journey</h3>
              <p id="currentJourneyText" class="muted small-text">No active application selected.</p>
              <div id="currentJourneyTimeline" class="timeline" style="margin-top:.4rem;"></div>
            </div>

            <div style="margin-top:1rem;">
              <h3 class="section-title">Latest activity</h3>
              <div id="overviewActivity" class="timeline"></div>
            </div>
          </section>

          <!-- Applications -->
          <section id="tab-apps" class="tab-panel" aria-label="Applications">
            <h3 class="section-title">Applications</h3>
            <p class="muted small-text">All applications you have made for jobs, visas, or programs.</p>
            <div class="toolbar" style="margin:.4rem 0;gap:.3rem;flex-wrap:wrap;">
              <button id="refreshAppsBtn" class="btn outline btn-sm"><i class="fa fa-rotate"></i> Refresh</button>
              <div class="pill-soft">
                <i class="fa fa-location-arrow"></i>
                <input id="quickTrackInput" class="input" style="border:none;padding:0 .2rem;background:transparent;box-shadow:none;" placeholder="Quick tracking ID"/>
                <button id="quickTrackBtn" class="btn outline btn-sm"><i class="fa fa-arrow-right"></i> Open</button>
              </div>
            </div>
            <div id="appsEl" class="apps-grid">
              <div class="muted small-text">Loading applications...</div>
            </div>
          </section>

          <!-- Appointments -->
          <section id="tab-appointments" class="tab-panel" aria-label="Appointments history">
            <h3 class="section-title">Appointments</h3>
            <p class="muted small-text">
              View all appointments booked with Elite Travel &amp; Tour. Click “View details” to see more information
              or open the full appointment details page.
            </p>

            <div class="toolbar" style="margin:.5rem 0;gap:.35rem;flex-wrap:wrap;">
              <button id="refreshApptsBtn" class="btn outline btn-sm">
                <i class="fa fa-rotate"></i> Refresh
              </button>
              <span id="apptsSummary" class="muted small-text"></span>
            </div>

            <div id="apptsList" class="apps-grid">
              <p class="muted small-text">Loading appointments...</p>
            </div>
          </section>

          <!-- Payments -->
          <section id="tab-pays" class="tab-panel" aria-label="Payments">
            <h3 class="section-title">Payments</h3>
            <p class="muted small-text">Payment history linked to your applications or services.</p>
            <div class="toolbar" style="margin:.5rem 0;gap:.35rem;flex-wrap:wrap;">
              <button id="refreshPaysBtn" class="btn outline btn-sm"><i class="fa fa-rotate"></i> Refresh</button>
            </div>
            <div id="paysEl" class="apps-grid">
              <p class="muted small-text">Loading payments...</p>
            </div>
          </section>

          <!-- Testimonials -->
          <section id="tab-tests" class="tab-panel" aria-label="Testimonials">
            <h3 class="section-title">Testimonials</h3>
            <p class="muted small-text">
              Share your experience with Elite Travel &amp; Tour. Testimonials may appear on our site (with your consent).
            </p>

            <!-- One-testimonial policy: dynamic section switches between Add or Edit -->
            <div id="testimonialEditor" class="test-card" style="margin:.6rem 0;"></div>
            <div id="testsEl" class="apps-grid"></div>
          </section>
        </div>
      </section>

      <!-- Right: widgets -->
      <aside class="profile-layout-right">
        <section class="card widget">
          <div class="body">
            <h3>Settings</h3>
            <p id="adminViewNote" class="muted small-text" style="display:none;margin-bottom:.4rem;">
              You are viewing another user’s profile as an admin. Use admin tools for sensitive changes.
            </p>
            <form id="profileForm" class="list-simple" style="border:none;">
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Email</label>
                <div id="settingsEmail" class="small-text muted">—</div>
              </div>
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Full name</label>
                <input id="inputFullname" class="input" placeholder="Your name" autocomplete="name">
              </div>
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Phone</label>
                <input id="inputPhone" class="input" placeholder="Phone number" autocomplete="tel">
              </div>
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Country</label>
                <input id="inputCountry" class="input" placeholder="Country" autocomplete="country-name">
              </div>
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Joined</label>
                <div id="settingsJoined" class="small-text muted">—</div>
              </div>
              <div class="toolbar" style="margin-top:.6rem;justify-content:space-between;flex-wrap:wrap;">
                <span id="profileStatus" class="muted small-text"></span>
                <button id="profileSaveBtn" class="btn brand btn-sm" type="submit">
                  <i class="fa fa-save"></i> Save
                </button>
              </div>
            </form>
          </div>
        </section>

        <section class="card widget">
          <div class="body">
            <h3>Quick actions</h3>
            <div class="chip-row" style="margin-bottom:.4rem;">
              <span class="pill-soft"><i class="fa fa-calendar-check"></i> Appointments</span>
              <span class="pill-soft"><i class="fa fa-credit-card"></i> Payments</span>
              <span class="pill-soft"><i class="fa fa-globe"></i> Travel</span>
            </div>
            <div style="display:grid;gap:.45rem;">
              <button id="followEliteBtn" class="btn outline btn-sm">
                <i class="fa fa-bell"></i> Follow Elite updates
              </button>
              <a href="/views/pages/appointment.html" class="btn outline btn-sm">
                <i class="fa fa-calendar"></i> Book appointment
              </a>
              <a href="/views/pages/contact.html" class="btn outline btn-sm">
                <i class="fa fa-envelope"></i> Contact support
              </a>
            </div>
            <p id="followStatus" class="muted small-text" style="margin-top:.5rem;"></p>
          </div>
        </section>

        <section class="card widget">
          <div class="body">
            <h3>Sidebar notifications</h3>
            <div id="sidebarNotifs" class="list" style="font-size:.82rem;"></div>
          </div>
        </section>
      </aside>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal" id="editProfileModal" role="dialog" aria-modal="true" aria-labelledby="editProfileTitle">
    <section class="card">
      <div class="body">
        <h3 id="editProfileTitle">Edit profile</h3>
        <p class="subtitle">Update your details, avatar and cover photo. Changes apply to your account only.</p>
        <div class="edit-grid">
          <div>
            <label class="small-text">Full name</label>
            <input id="modalFullname" class="input" placeholder="Your name" autocomplete="name">
          </div>
          <div>
            <label class="small-text">Phone</label>
            <input id="modalPhone" class="input" placeholder="Phone number" autocomplete="tel">
          </div>
          <div>
            <label class="small-text">Country</label>
            <input id="modalCountry" class="input" placeholder="Country" autocomplete="country-name">
          </div>
          <div style="display:grid;gap:.4rem;">
            <label class="small-text">Avatar</label>
            <input id="modalAvatar" type="file" accept="image/*">
            <button id="saveModalAvatar" class="btn outline btn-sm"><i class="fa fa-upload"></i> Upload avatar</button>
          </div>
          <div style="display:grid;gap:.4rem;">
            <label class="small-text">Cover photo</label>
            <input id="modalCover" type="file" accept="image/*">
            <button id="saveModalCover" class="btn outline btn-sm"><i class="fa fa-upload"></i> Upload cover</button>
          </div>
        </div>
        <div class="toolbar" style="margin-top:.7rem;justify-content:flex-end;gap:.4rem;">
          <button id="cancelEditProfile" class="btn outline btn-sm"><i class="fa fa-xmark"></i> Cancel</button>
          <button id="saveEditProfile" class="btn brand btn-sm"><i class="fa fa-save"></i> Save</button>
        </div>
        <div id="editProfileStatus" class="muted small-text" style="margin-top:.4rem;"></div>
      </div>
    </section>
  </div>

  <div class="modal" id="aboutModal">
    <section class="card"><div class="body">
      <h3>About this account</h3>
      <p class="subtitle">High‑level details for this account, including status and history.</p>
      <div id="aboutContent"></div>
      <div class="toolbar" style="margin-top:.7rem;justify-content:flex-end;">
        <button id="closeAbout" class="btn outline btn-sm"><i class="fa fa-xmark"></i> Close</button>
      </div>
    </div></section>
  </div>

  <!-- Appointment details modal (profile-side) -->
  <div class="modal" id="apptModal" role="dialog" aria-modal="true" aria-labelledby="apptModalTitle">
    <section class="card">
      <div class="body">
        <h3 id="apptModalTitle">Appointment details</h3>
        <p id="apptModalSubtitle" class="subtitle small-text"></p>

        <div id="apptModalContent" class="small-text" style="margin-top:.5rem;"></div>

        <div class="toolbar" style="margin-top:.7rem;justify-content:flex-end;gap:.4rem;">
          <button id="apptModalClose" class="btn outline btn-sm">
            <i class="fa fa-xmark"></i> Close
          </button>
          <a id="apptDetailsLink" href="#" class="btn brand btn-sm" target="_blank" rel="noopener">
            <i class="fa fa-up-right-from-square"></i> Open full page
          </a>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { sb } from '/src/js/supabase.js';

    /* Utility: toast */
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');
    function showToast(message, ms=2500){
      if (!toast || !toastText) return;
      toastText.textContent = message;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), ms);
    }

    /* Notifications drawer toggle handled in notifications.js via bellBtn; keep defensive close */
    document.addEventListener('click',(e)=>{
      const feed=document.getElementById('notifFeed');
      if(!feed) return;
      if(e.target.closest('#bellBtn')){ feed.classList.toggle('open'); }
      else if(!e.target.closest('#notifFeed')){ feed.classList.remove('open'); }
    });

    /* DOM refs */
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileBtn = document.getElementById('profileBtn');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    const mobileProfileBtn = document.getElementById('mobileProfileBtn');
    const navAuthText = document.getElementById('navAuthText');
    const navAuthPill = document.getElementById('navAuthPill');
    const mobileAuthText = document.getElementById('mobileAuthText');
    const menuToggle = document.getElementById('menuToggle');
    const mobilePanel = document.getElementById('mobilePanel');
    const profileModeTag = document.getElementById('profileModeTag');
    const accountIntro = document.getElementById('accountIntro');
    const adminViewNote = document.getElementById('adminViewNote');

    const profileStatus = document.getElementById('profileStatus');
    const profileNameEl = document.getElementById('profileName');
    const profileEmailEl = document.getElementById('profileEmail');
    const profileAvatarImg = document.getElementById('profileAvatarImg');
    const profileCoverImg = document.getElementById('profileCoverImg');
    const countryTag = document.getElementById('profileCountryTag');
    const countryText = document.getElementById('profileCountryText');
    const statAge = document.getElementById('statAge');
    const statApps = document.getElementById('statApps');
    const statActiveApps = document.getElementById('statActiveApps');
    const statCompletedApps = document.getElementById('statCompletedApps');
    const statPendingPayments = document.getElementById('statPendingPayments');
    const completenessRow = document.getElementById('completenessRow');
    const profileDetailsList = document.getElementById('profileDetailsList');
    const currentJourneyText = document.getElementById('currentJourneyText');
    const currentJourneyTimeline = document.getElementById('currentJourneyTimeline');
    const overviewActivity = document.getElementById('overviewActivity');
    const appsEl = document.getElementById('appsEl');
    const paysEl = document.getElementById('paysEl');
    const testsEl = document.getElementById('testsEl');
    const settingsEmail = document.getElementById('settingsEmail');
    const settingsJoined = document.getElementById('settingsJoined');
    const inputFullname = document.getElementById('inputFullname');
    const inputPhone = document.getElementById('inputPhone');
    const inputCountry = document.getElementById('inputCountry');
    const quickTrackInput = document.getElementById('quickTrackInput');
    const quickTrackBtn = document.getElementById('quickTrackBtn');
    const followStatus = document.getElementById('followStatus');

    const aboutBtn = document.getElementById('aboutBtn');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const aboutModal = document.getElementById('aboutModal');
    const profileForm = document.getElementById('profileForm');

    const apptsList = document.getElementById('apptsList');
    const apptsSummary = document.getElementById('apptsSummary');
    const refreshApptsBtn = document.getElementById('refreshApptsBtn');
    const apptModal = document.getElementById('apptModal');
    const apptModalTitle = document.getElementById('apptModalTitle');
    const apptModalSubtitle = document.getElementById('apptModalSubtitle');
    const apptModalContent = document.getElementById('apptModalContent');
    const apptModalClose = document.getElementById('apptModalClose');
    const apptDetailsLink = document.getElementById('apptDetailsLink');

    /* New unified Edit Profile modal refs */
    const editProfileModal = document.getElementById('editProfileModal');
    const modalFullname = document.getElementById('modalFullname');
    const modalPhone = document.getElementById('modalPhone');
    const modalCountry = document.getElementById('modalCountry');
    const modalAvatar = document.getElementById('modalAvatar');
    const modalCover = document.getElementById('modalCover');
    const saveModalAvatar = document.getElementById('saveModalAvatar');
    const saveModalCover = document.getElementById('saveModalCover');
    const cancelEditProfile = document.getElementById('cancelEditProfile');
    const saveEditProfile = document.getElementById('saveEditProfile');
    const editProfileStatus = document.getElementById('editProfileStatus');

    /* Testimonial editor refs (one-per-user) */
    const testimonialEditor = document.getElementById('testimonialEditor');

    const urlParams = new URLSearchParams(window.location.search);
    const emailParam = urlParams.get('email');

    let sessionUser = null;
    let viewedUser = null;
    let viewedUserId = null;
    let viewedUserEmail = null;
    let isAdmin = false;
    let isAdminViewingOther = false;

    let userProfile = null;
    let userApps = [];
    let userPayments = [];
    let userTests = [];
    let userAppts = [];
    let userOwnTestimonial = null;

    function setStatus(msg, type='muted'){
      if(!profileStatus) return;
      profileStatus.textContent = msg || '';
      profileStatus.className = `small-text ${type}`;
    }

    function trapFocus(container) {
      const focusable = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      function handler(e) {
        if (e.key !== 'Tab') return;
        if (e.shiftKey) {
          if (document.activeElement === first) { e.preventDefault(); last.focus(); }
        } else {
          if (document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      }
      container.addEventListener('keydown', handler);
      first && first.focus();
    }

    function setAuthPills(session) {
      const user = session?.user || null;
      sessionUser = user;
      if (user) {
        navAuthPill.style.display = 'none';
        navAuthText.textContent = user.email || 'User';
        mobileAuthText.textContent = user.email || 'User';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        profileBtn.style.display = 'inline-flex';
        mobileLoginBtn.style.display = 'none';
        mobileLogoutBtn.style.display = 'inline-flex';
        mobileProfileBtn.style.display = 'inline-flex';
      } else {
        navAuthPill.style.display = 'none';
        navAuthText.textContent = 'Guest';
        mobileAuthText.textContent = 'Guest';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        profileBtn.style.display = 'none';
        mobileLoginBtn.style.display = 'inline-flex';
        mobileLogoutBtn.style.display = 'none';
        mobileProfileBtn.style.display = 'none';
      }
    }

    async function fetchSessionAndRole() {
      const { data, error } = await sb.auth.getSession();
      if (error) {
        console.error(error);
        showToast('Failed to get session information.');
        return false;
      }
      const session = data.session;
      setAuthPills(session);
      if (!session?.user) {
        showToast('Please log in to view your profile.');
        window.location.href = '/views/pages/login.html';
        return false;
      }

      sessionUser = session.user;

      // isAdmin from users table
      try{
        const { data: rows, error: uErr } = await sb
          .from('users')
          .select('id,email,role')
          .eq('id', sessionUser.id)
          .maybeSingle();
        if (!uErr && rows) {
          isAdmin = rows.role === 'admin' || rows.role === 'superadmin';
        }
      }catch(e){
        console.error(e);
      }
      return true;
    }

    async function resolveViewedUser() {
      if (!sessionUser) return false;

      if (emailParam && isAdmin) {
        // Admin viewing another user by email
        try{
          const { data, error } = await sb
            .from('users')
            .select('*')
            .eq('email', emailParam)
            .maybeSingle();
          if (error) throw error;
          if (!data) {
            showToast('User not found for provided email.');
            return false;
          }
          viewedUser = data;
          viewedUserId = data.id;
          viewedUserEmail = data.email;
          isAdminViewingOther = viewedUserId !== sessionUser.id;
        }catch(e){
          console.error(e);
          showToast('Failed to load user.');
          return false;
        }
      } else {
        // Normal: current user
        try{
          const { data, error } = await sb
            .from('users')
            .select('*')
            .eq('id', sessionUser.id)
            .maybeSingle();
          if (error) throw error;
          if (!data) {
            showToast('User profile not found.');
            return false;
          }
          viewedUser = data;
          viewedUserId = data.id;
          viewedUserEmail = data.email;
          isAdminViewingOther = false;
        }catch(e){
          console.error(e);
          showToast('Failed to load your profile.');
          return false;
        }
      }

      if (isAdminViewingOther) {
        profileModeTag.style.display = 'inline-flex';
        adminViewNote.style.display = 'block';
        accountIntro.textContent = 'You are viewing this profile as an admin. Use admin tools for privileged changes.';
      } else {
        profileModeTag.style.display = 'none';
        adminViewNote.style.display = 'none';
      }

      return true;
    }

    async function loadProfile() {
      if (!viewedUserId) return;
      const u = viewedUser;
      userProfile = u;

      const displayName = u.fullname || u.name || viewedUserEmail;
      profileNameEl.textContent = displayName;
      profileEmailEl.textContent = viewedUserEmail;
      settingsEmail.textContent = viewedUserEmail;

      if (profileAvatarImg && u.avatar_url) profileAvatarImg.src = u.avatar_url;
      if (profileCoverImg && u.cover) profileCoverImg.src = u.cover;

      if (u.country) {
        countryTag.style.display = 'inline-flex';
        countryText.textContent = u.country;
      } else {
        countryTag.style.display = 'none';
      }

      const created = u.created_at ? new Date(u.created_at) : null;
      if (created) {
        const diffDays = Math.floor((Date.now() - created.getTime()) / (1000 * 60 * 60 * 24));
        statAge.textContent = diffDays <= 0 ? 'New' : `${diffDays}d`;
        settingsJoined.textContent = created.toLocaleDateString();
      } else {
        statAge.textContent = '–';
        settingsJoined.textContent = '–';
      }

      const chips = [
        { label: 'Name', ok: !!displayName },
        { label: 'Avatar', ok: !!u.avatar_url },
        { label: 'Cover', ok: !!u.cover },
        { label: 'Country', ok: !!u.country },
        { label: 'Phone', ok: !!u.phone }
      ];

      completenessRow.innerHTML = '';
      chips.forEach((c) => {
        const span = document.createElement('span');
        span.className = 'pill-soft';
        span.innerHTML = `<i class="fa ${c.ok ? 'fa-check-circle' : 'fa-circle-exclamation'}"></i> ${c.label}`;
        completenessRow.appendChild(span);
      });

      profileDetailsList.innerHTML = `
        <li><span>Email</span><span class="muted">${viewedUserEmail}</span></li>
        <li><span>Display name</span><span class="muted">${displayName}</span></li>
        <li><span>Status</span><span class="badge">${u.status || 'active'}</span></li>
        ${u.country ? `<li><span>Country</span><span class="muted">${u.country}</span></li>` : ''}
        ${u.created_at ? `<li><span>Joined</span><span class="muted">${new Date(u.created_at).toLocaleDateString()}</span></li>` : ''}
      `;

      document.getElementById('aboutContent').innerHTML = `
        <ul class="list-simple">
          <li><span>Email</span><span class="muted">${viewedUserEmail}</span></li>
          <li><span>Display name</span><span class="muted">${displayName}</span></li>
          <li><span>Status</span><span class="badge">${u.status || 'active'}</span></li>
          ${u.country ? `<li><span>Country</span><span class="muted">${u.country}</span></li>` : ''}
          ${u.created_at ? `<li><span>Joined</span><span class="muted">${new Date(u.created_at).toLocaleString()}</span></li>` : ''}
          <li><span>User ID</span><span class="muted" style="max-width:220px;overflow:hidden;text-overflow:ellipsis;">${viewedUserId}</span></li>
        </ul>
        <p class="muted small-text" style="margin-top:.6rem;">Admins can see additional details needed for verification and compliance, but they are not exposed publicly.</p>
      `;

      inputFullname.value = u.fullname || u.name || '';
      inputPhone.value = u.phone || '';
      inputCountry.value = u.country || '';

      // Pre-fill modal fields
      modalFullname.value = u.fullname || u.name || '';
      modalPhone.value = u.phone || '';
      modalCountry.value = u.country || '';
    }

    function mapAppStage(app) {
      const status = (app.status || '').toLowerCase();
      if (status === 'completed' || status === 'approved') return 'completed';
      if (status === 'accepted') return 'accepted';
      if (status === 'rejected') return 'rejected';
      if (status === 'pending' || status === 'submitted') return 'application';
      return 'application';
    }

    function stageLabel(stage) {
      switch(stage){
        case 'completed': return 'Completed';
        case 'accepted': return 'Accepted';
        case 'rejected': return 'Rejected';
        case 'application':
        default: return 'In review';
      }
    }

    function renderCurrentJourney(apps) {
      if (!apps.length) {
        currentJourneyText.textContent = 'No active application selected.';
        currentJourneyTimeline.innerHTML = '';
        return;
      }
      const active = apps.filter(a => {
        const s = mapAppStage(a);
        return s !== 'completed';
      });
      const target = active[0] || apps[0];
      const stage = mapAppStage(target);
      const title = target.jobs?.title || 'Application';
      currentJourneyText.textContent = `${title} — ${stageLabel(stage)}`;

      const steps = Array.isArray(target.progress) ? target.progress : [];
      const created = target.created_at ? new Date(target.created_at).toLocaleString() : null;

      const timelineEvents = [];
      if (created) timelineEvents.push({ label:'Application submitted', at:created });

      const map = {
        accepted:'Application accepted',
        payment_received:'Payment received',
        documents_submitted:'Documents submitted',
        visa_submitted:'Visa submitted',
        visa_approved:'Visa approved',
        completed:'Completed / departure'
      };
      steps.forEach(s=>{
        const key = (s.step || s.status || '').toLowerCase();
        const label = map[key] || s.step || s.status || 'Update';
        const at = s.at || s.time || null;
        timelineEvents.push({ label, at: at ? new Date(at).toLocaleString() : '' });
      });

      currentJourneyTimeline.innerHTML = timelineEvents.map(ev=>`
        <div class="timeline-item">
          <strong>${ev.label}</strong>
          <span>${ev.at || ''}</span>
        </div>
      `).join('');
    }

    function renderApplications(apps) {
      userApps = apps;
      statApps.textContent = apps.length;
      const active = apps.filter(a=>{
        const st = mapAppStage(a);
        return st !== 'completed';
      }).length;
      const completed = apps.filter(a=> mapAppStage(a) === 'completed').length;
      statActiveApps.textContent = active;
      statCompletedApps.textContent = completed;

      if (!apps.length) {
        appsEl.innerHTML =
          '<div class="muted small-text">No applications yet for this user.</div>';
        overviewActivity.innerHTML = '<div class="muted small-text">No application activity yet.</div>';
        renderCurrentJourney([]);
        return;
      }

      appsEl.innerHTML = apps.map(app=>{
        const job = app.jobs || {};
        const jobTitle = job.title || 'Application';
        const jobLocation =
          job.city && job.country ? `${job.city}, ${job.country}` : job.country || job.city || '—';
        const stage = mapAppStage(app);
        const status = app.status || 'submitted';
        const tracking = app.tracking_id || null;
        const created = app.created_at ? new Date(app.created_at).toLocaleString() : '—';
        const badgeClass =
          stage === 'completed' ? 'success' :
          (status === 'failed' || status === 'rejected') ? 'danger' :
          'warning';

        const hasSuccessForThisApp = userPayments.some(p=>{
          const meta = p.metadata || {};
          return p.status === 'success' && meta.application_id === app.id;
        });

        const canPayNow = !isAdminViewingOther && (stage === 'accepted' || stage === 'application') && !hasSuccessForThisApp;

        const payLink = canPayNow
          ? `/views/pages/payments.html?type=job&job_id=${encodeURIComponent(app.job_id || '')}&application_id=${encodeURIComponent(app.id)}&tracking=${encodeURIComponent(tracking || '')}&from=profile`
          : null;

        return `
          <article class="app-card">
            <div class="top">
              <div>
                <strong>${jobTitle}</strong>
                <div class="meta">
                  <span>${app.plan || 'Plan'}</span>
                  <span>${app.application_type || 'Application'}</span>
                  <span>${jobLocation}</span>
                  <span>${stageLabel(stage)}</span>
                </div>
              </div>
              <div>
                <span class="badge ${badgeClass}">${status}</span>
              </div>
            </div>
            <div class="meta">
              <span><i class="fa fa-calendar"></i> ${created}</span>
              ${tracking ? `<span><i class="fa fa-location-dot"></i> Tracking: ${tracking}</span>` : ''}
            </div>
            <div class="toolbar" style="margin-top:.3rem;gap:.35rem;flex-wrap:wrap;">
              ${tracking ? `<a class="btn outline btn-sm" href="/views/pages/tracking.html?tracking=${encodeURIComponent(tracking)}"><i class="fa fa-location-arrow"></i> Open tracking</a>`:''}
              ${payLink ? `<a class="btn outline btn-sm" href="${payLink}"><i class="fa fa-credit-card"></i> Pay now</a>`:''}
            </div>
          </article>
        `;
      }).join('');

      const latest = apps[0];
      const latestStage = mapAppStage(latest);
      const latestCreated = latest.created_at ? new Date(latest.created_at).toLocaleString() : '—';
      overviewActivity.innerHTML = `
        <div class="timeline">
          <div class="timeline-item">
            <strong>Latest application — ${latest.jobs?.title || 'Application'}</strong>
            <span>${latestCreated} · ${stageLabel(latestStage)}</span>
          </div>
        </div>
      `;

      renderCurrentJourney(apps);
    }

    async function loadApps() {
      if (!viewedUserId || !appsEl) return;
      try{
        const { data, error } = await sb
          .from('applications')
          .select(`
            id,
            user_id,
            job_id,
            status,
            plan,
            application_type,
            tracking_id,
            progress,
            details,
            created_at,
            jobs:job_id ( id, title, country, city )
          `)
          .eq('user_id', viewedUserId)
          .order('created_at', { ascending: false })
          .limit(200);
        if (error) throw error;
        const rows = data || [];
        renderApplications(rows);
      }catch(e){
        console.error(e);
        appsEl.innerHTML = '<div class="muted small-text">Failed to load applications.</div>';
      }
    }

    function formatAmount(amount,currency){
      const curr = (currency || 'GHS').toUpperCase();
      const val = (Number(amount)) || 0;
      try{
        return new Intl.NumberFormat(undefined,{ style:'currency', currency: curr }).format(val);
      }catch(_){
        return `${val.toFixed(2)} ${curr}`;
      }
    }

    function renderPayments(list) {
      userPayments = list;
      const pending = list.filter(p=>p.status==='pending').length;
      statPendingPayments.textContent = pending;

      if (!list.length) {
        paysEl.innerHTML = '<p class="muted small-text">No payments on record yet for this user.</p>';
        return;
      }

      const html = list.map(p=>{
        const meta = p.metadata || {};
        const amountStr = formatAmount(p.amount,p.currency);
        const created = p.created_at ? new Date(p.created_at).toLocaleString() : '—';
        const statusClass = p.status==='success' ? 'success' : p.status==='failed' ? 'danger' : 'warning';
        const channelLabel =
          p.channel==='paystack' ? 'Paystack' :
          p.channel==='momo_auto' ? 'MoMo automatic' :
          p.channel==='momo_manual' ? 'MoMo manual' :
          p.channel || 'Payment';
        const title = meta.title || meta.description || 'Payment';

        const appLink = meta.tracking_id
          ? `<a href="/views/pages/tracking.html?tracking=${encodeURIComponent(meta.tracking_id)}" class="btn outline btn-sm"><i class="fa fa-location-arrow"></i> View tracking</a>`
          : '';

        return `
          <article class="pay-card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
              <div>
                <strong>${title}</strong>
                <div class="small-text">${channelLabel} · Ref: ${p.ref}</div>
              </div>
              <div style="text-align:right;">
                <div>${amountStr}</div>
                <span class="badge ${statusClass}">${p.status}</span>
              </div>
            </div>
            <div class="small-text">
              <span><i class="fa fa-calendar"></i> ${created}</span>
            </div>
            <div class="toolbar" style="margin-top:.25rem;">
              ${appLink}
            </div>
          </article>
        `;
      }).join('');

      paysEl.innerHTML = html;
    }

    async function loadPays() {
      if (!viewedUserId || !paysEl) return;
      try{
        const { data, error } = await sb
          .from('payments')
          .select('id,ref,status,amount,currency,channel,metadata,created_at,user_id')
          .eq('user_id', viewedUserId)
          .order('created_at', { ascending:false })
          .limit(200);
        if (error) throw error;
        const rows = data || [];
        renderPayments(rows);
      }catch(e){
        console.error(e);
        paysEl.innerHTML='<p class="muted small-text">Failed to load payments.</p>';
      }
    }

    function renderStars(rating) {
      const r = Number(rating) || 0;
      if (!r) return '';
      const full = '★'.repeat(Math.max(0, Math.min(5, r)));
      const empty = '☆'.repeat(5 - Math.max(0, Math.min(5, r)));
      return `<span style="color:#fbbf24;font-size:.85rem;">${full}${empty}</span>`;
    }

    function renderTestimonialsList(list) {
      if (!testsEl) return;

      if (!list.length) {
        testsEl.innerHTML='<p class="muted small-text">No testimonials yet for this user.</p>';
        return;
      }

      testsEl.innerHTML = list.map(t=>{
        const when = t.created_at ? new Date(t.created_at).toLocaleString() : '';
        const name = t.name || '';
        const rating = t.rating || null;

        return `
          <article class="test-card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:.5rem;">
              <div style='color:var(--brand);display:block;'>
                ${name ? `<strong>${name}</strong><br>` : ''}
                <div>${t.quote || ''}</div>
              </div>
              <div style="text-align:right;">
                ${rating ? renderStars(rating) : ''}
              </div>
            </div>
            <div class="small-text" style="margin-top:.25rem;">${when}</div>
          </article>
        `;
      }).join('');
    }

    function renderTestimonialEditor() {
      // One-testimonial policy: show add if none; else show edit form
      if (!testimonialEditor) return;

      if (isAdminViewingOther) {
        testimonialEditor.innerHTML = `
          <div class="muted small-text">Admins cannot post or edit testimonials on behalf of users here.</div>
        `;
        return;
      }

      if (!userOwnTestimonial) {
        testimonialEditor.innerHTML = `
          <h4 class="small-text" style="margin-top:0;">Write a testimonial</h4>
          <div style="display:grid;gap:.5rem;">
            <div>
              <label class="small-text">Rating</label>
              <select id="tRating" class="input" style="max-width:200px;">
                <option value="">Select rating</option>
                <option value="5">★★★★★ — Excellent</option>
                <option value="4">★★★★☆ — Very good</option>
                <option value="3">★★★☆☆ — Good</option>
                <option value="2">★★☆☆☆ — Fair</option>
                <option value="1">★☆☆☆☆ — Poor</option>
              </select>
            </div>
            <div>
              <label class="small-text">Title</label>
              <input id="tTitle" class="input" placeholder="e.g. Smooth Work & Pay process">
            </div>
            <div>
              <label class="small-text">Your testimonial</label>
              <textarea id="tText" class="textarea" placeholder="Tell us what stood out — clarity, communication, timelines, etc."></textarea>
            </div>
            <div class="toolbar" style="justify-content:space-between;flex-wrap:wrap;">
              <span id="tStatus" class="muted small-text"></span>
              <button id="tAdd" class="btn brand btn-sm">
                <i class="fa fa-paper-plane"></i> Submit
              </button>
            </div>
          </div>
        `;
        attachTestimonialAddHandler();
      } else {
        const t = userOwnTestimonial;
        testimonialEditor.innerHTML = `
          <h4 class="small-text" style="margin-top:0;">Edit your testimonial</h4>
          <div style="display:grid;gap:.5rem;">
            <div>
              <label class="small-text">Rating</label>
              <select id="tRatingEdit" class="input" style="max-width:200px;">
                <option value="">Select rating</option>
                <option value="5"${t.rating===5?' selected':''}>★★★★★ — Excellent</option>
                <option value="4"${t.rating===4?' selected':''}>★★★★☆ — Very good</option>
                <option value="3"${t.rating===3?' selected':''}>★★★☆☆ — Good</option>
                <option value="2"${t.rating===2?' selected':''}>★★☆☆☆ — Fair</option>
                <option value="1"${t.rating===1?' selected':''}>★☆☆☆☆ — Poor</option>
              </select>
            </div>
            <div>
              <label class="small-text">Title</label>
              <input id="tTitleEdit" class="input" placeholder="Title" value="${t.title || ''}">
            </div>
            <div>
              <label class="small-text">Your testimonial</label>
              <textarea id="tTextEdit" class="textarea" placeholder="Update your testimonial">${t.quote || ''}</textarea>
            </div>
            <div class="toolbar" style="justify-content:space-between;flex-wrap:wrap;">
              <span id="tStatusEdit" class="muted small-text"></span>
              <button id="tSaveEdit" class="btn brand btn-sm">
                <i class="fa fa-save"></i> Save changes
              </button>
            </div>
          </div>
        `;
        attachTestimonialEditHandler();
      }
    }

    function attachTestimonialAddHandler() {
      const tRatingSel = document.getElementById('tRating');
      const tTitleInput = document.getElementById('tTitle');
      const tTextArea = document.getElementById('tText');
      const tStatus = document.getElementById('tStatus');

      document.getElementById('tAdd')?.addEventListener('click', async () => {
        const txt = tTextArea.value.trim();
        const ratingVal = tRatingSel.value;
        const titleVal = tTitleInput.value.trim();

        if (!txt) {
          tStatus.textContent = 'Please enter testimonial text.';
          tStatus.className = 'muted small-text danger';
          return;
        }
        if (!ratingVal) {
          tStatus.textContent = 'Please select a rating.';
          tStatus.className = 'muted small-text danger';
          return;
        }
        if (isAdminViewingOther) {
          tStatus.textContent = 'You cannot post testimonials on behalf of another user here.';
          tStatus.className = 'muted small-text danger';
          return;
        }

        const rating = Number(ratingVal);

        try {
          const { data: sessionData } = await sb.auth.getSession();
          const sUser = sessionData?.session?.user;
          if (!sUser) throw new Error('Not logged in.');
          // Check if already has one
          const { data: existing } = await sb
            .from('testimonials')
            .select('id')
            .eq('user_id', sUser.id)
            .limit(1);
          if (existing && existing.length) {
            tStatus.textContent = 'You already submitted a testimonial. You can edit it below.';
            tStatus.className = 'muted small-text warning';
            await loadTests(); // refresh to pick up existing
            return;
          }

          // Fetch full profile for synced fields
          const { data: profile, error: profileErr } = await sb
            .from('users')
            .select('fullname, country, avatar_url')
            .eq('id', sUser.id)
            .maybeSingle();
          if (profileErr) throw profileErr;

          const { error } = await sb.from('testimonials').insert({
            user_id: sUser.id,
            name: profile?.fullname || sUser.email,
            location: profile?.country || null,
            avatar: profile?.avatar_url || null,
            quote: txt,
            title: titleVal || null,
            rating: rating || null
          });
          if (error) throw error;

          tStatus.textContent = 'Testimonial submitted.';
          tStatus.className = 'muted small-text success';
          await loadTests();
        } catch (e) {
          console.error(e);
          tStatus.textContent = e.message || 'Failed to save testimonial.';
          tStatus.className = 'muted small-text danger';
        }
      });
    }

    function attachTestimonialEditHandler() {
      const tRatingSel = document.getElementById('tRatingEdit');
      const tTitleInput = document.getElementById('tTitleEdit');
      const tTextArea = document.getElementById('tTextEdit');
      const tStatus = document.getElementById('tStatusEdit');

      document.getElementById('tSaveEdit')?.addEventListener('click', async () => {
        const txt = tTextArea.value.trim();
        const ratingVal = tRatingSel.value;
        const titleVal = tTitleInput.value.trim();

        if (!txt) {
          tStatus.textContent = 'Please enter testimonial text.';
          tStatus.className = 'muted small-text danger';
          return;
        }
        if (!ratingVal) {
          tStatus.textContent = 'Please select a rating.';
          tStatus.className = 'muted small-text danger';
          return;
        }
        if (isAdminViewingOther) {
          tStatus.textContent = 'You cannot edit another user’s testimonial here.';
          tStatus.className = 'muted small-text danger';
          return;
        }

        try {
          const { data: sessionData } = await sb.auth.getSession();
          const sUser = sessionData?.session?.user;
          if (!sUser) throw new Error('Not logged in.');
          if (!userOwnTestimonial?.id) throw new Error('No testimonial to edit.');

          const { error } = await sb
            .from('testimonials')
            .update({
              quote: txt,
              title: titleVal || null,
              rating: Number(ratingVal) || null
            })
            .eq('id', userOwnTestimonial.id)
            .eq('user_id', sUser.id);
          if (error) throw error;

          tStatus.textContent = 'Testimonial updated.';
          tStatus.className = 'muted small-text success';
          await loadTests();
        } catch (e) {
          console.error(e);
          tStatus.textContent = e.message || 'Failed to update testimonial.';
          tStatus.className = 'muted small-text danger';
        }
      });
    }

    async function loadTests() {
      if (!viewedUserId || !testsEl || !testimonialEditor) return;
      try{
        // Fetch all testimonials for rendering list + the user’s own (if owner)
        const { data, error } = await sb
          .from('testimonials')
          .select('id,quote,name,rating,title,created_at,user_id,location,avatar')
          .eq('user_id', viewedUserId)
          .order('created_at', { ascending:false })
          .limit(5);
        if (error) throw error;

        // If viewing own profile, determine own testimonial
        userOwnTestimonial = null;
        if (!isAdminViewingOther && sessionUser?.id) {
          const mine = (data || []).find(t => String(t.user_id) === String(sessionUser.id));
          if (mine) userOwnTestimonial = mine;
        }

        renderTestimonialEditor();
        renderTestimonialsList(data || []);
      }catch(e){
        console.error(e);
        testsEl.innerHTML='<p class="muted small-text">Failed to load testimonials.</p>';
      }
    }

    /* Tabs */
    document.querySelectorAll('.tab-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach((p) => p.classList.remove('active'));
        document.getElementById(`tab-${tab}`)?.classList.add('active');
      });
    });

    /* Modals & profile actions */
    aboutBtn?.addEventListener('click', () => {
      aboutModal.style.display = 'flex';
      trapFocus(aboutModal);
    });

    editProfileBtn?.addEventListener('click', () => {
      if (isAdminViewingOther) {
        showToast('This editor updates your own account only. Use admin tools for other users.');
        return;
      }
      // Prefill modal fields
      modalFullname.value = userProfile?.fullname || userProfile?.name || viewedUserEmail || '';
      modalPhone.value = userProfile?.phone || '';
      modalCountry.value = userProfile?.country || '';
      editProfileStatus.textContent = '';
      editProfileModal.style.display = 'flex';
      trapFocus(editProfileModal);
    });

    cancelEditProfile?.addEventListener('click', () => {
      editProfileModal.style.display = 'none';
    });

    async function uploadFileToBucket(bucket, file, keyPrefix) {
      const fileName = `${sessionUser.id}-${keyPrefix}-${Date.now()}.png`;
      const { error: uploadError } = await sb.storage.from(bucket).upload(fileName, file, { upsert: true });
      if (uploadError) throw uploadError;
      const { data: pub } = sb.storage.from(bucket).getPublicUrl(fileName);
      return pub.publicUrl;
    }

    saveModalAvatar?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        editProfileStatus.textContent = 'You cannot change another user’s avatar here.';
        editProfileStatus.className = 'muted small-text danger';
        return;
      }
      const file = modalAvatar.files[0];
      if (!file) {
        editProfileStatus.textContent = 'Please select an avatar image.';
        editProfileStatus.className = 'muted small-text danger';
        return;
      }
      try{
        editProfileStatus.textContent = 'Uploading avatar...';
        editProfileStatus.className = 'muted small-text';
        const url = await uploadFileToBucket('avatars', file, 'avatar');
        const { error } = await sb.from('users').update({ avatar_url: url }).eq('id', sessionUser.id);
        if (error) throw error;
        editProfileStatus.textContent = 'Avatar updated.';
        editProfileStatus.className = 'muted small-text success';
        // Refresh local view
        const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
        if (!uErr && data) { viewedUser = data; }
        await loadProfile();
      }catch(e){
        console.error(e);
        editProfileStatus.textContent = e.message || 'Failed to update avatar.';
        editProfileStatus.className = 'muted small-text danger';
      }
    });

    saveModalCover?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        editProfileStatus.textContent = 'You cannot change another user’s cover photo here.';
        editProfileStatus.className = 'muted small-text danger';
        return;
      }
      const file = modalCover.files[0];
      if (!file) {
        editProfileStatus.textContent = 'Please select a cover image.';
        editProfileStatus.className = 'muted small-text danger';
        return;
      }
      try{
        editProfileStatus.textContent = 'Uploading cover...';
        editProfileStatus.className = 'muted small-text';
        const url = await uploadFileToBucket('covers', file, 'cover');
        const { error } = await sb.from('users').update({ cover: url }).eq('id', sessionUser.id);
        if (error) throw error;
        editProfileStatus.textContent = 'Cover photo updated.';
        editProfileStatus.className = 'muted small-text success';
        const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
        if (!uErr && data) { viewedUser = data; }
        await loadProfile();
      }catch(e){
        console.error(e);
        editProfileStatus.textContent = e.message || 'Failed to update cover.';
        editProfileStatus.className = 'muted small-text danger';
      }
    });

    saveEditProfile?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        editProfileStatus.textContent = 'Profile edits apply only to your own account here.';
        editProfileStatus.className = 'muted small-text danger';
        return;
      }
      if (!sessionUser?.id) {
        editProfileStatus.textContent = 'Please log in first.';
        editProfileStatus.className = 'muted small-text danger';
        return;
      }
      const fullname = modalFullname.value.trim() || null;
      const phone = modalPhone.value.trim() || null;
      const country = modalCountry.value.trim() || null;

      try{
        editProfileStatus.textContent = 'Saving profile...';
        editProfileStatus.className = 'muted small-text';
        const { error } = await sb
          .from('users')
          .update({ fullname, phone, country })
          .eq('id', sessionUser.id);
        if (error) throw error;
        editProfileStatus.textContent = 'Profile updated.';
        editProfileStatus.className = 'muted small-text success';

        const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
        if (!uErr && data) { viewedUser = data; }
        await loadProfile();
      }catch(e){
        console.error(e);
        editProfileStatus.textContent = e.message || 'Failed to update profile.';
        editProfileStatus.className = 'muted small-text danger';
      }
    });

    profileForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isAdminViewingOther) {
        setStatus('Profile edits here apply only to your own account.', 'danger');
        return;
      }
      if (!sessionUser?.id) {
        setStatus('Please log in first', 'danger');
        return;
      }
      const fullname = inputFullname.value.trim() || null;
      const phone = inputPhone.value.trim() || null;
      const country = inputCountry.value.trim() || null;

      try{
        setStatus('Saving profile...', 'muted');
        const { error } = await sb
          .from('users')
          .update({ fullname, phone, country })
          .eq('id', sessionUser.id);
        if (error) throw error;
        setStatus('Profile updated', 'success');
        const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
        if (!uErr && data) { viewedUser = data; }
        await loadProfile();
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update profile', 'danger');
      }
    });

    quickTrackBtn?.addEventListener('click', () => {
      const t = quickTrackInput.value.trim();
      if (!t) {
        showToast('Enter a tracking ID first.');
        return;
      }
      window.location.href = `/views/pages/tracking.html?tracking=${encodeURIComponent(t)}`;
    });

    quickTrackInput?.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') { quickTrackBtn?.click(); }
    });

    function mapApptStatus(s) {
      const status = (s || '').toLowerCase();
      if (!status) return { label:'Pending', cls:'warning' };
      if (status === 'confirmed') return { label:'Confirmed', cls:'success' };
      if (status === 'cancelled') return { label:'Cancelled', cls:'danger' };
      if (status === 'completed') return { label:'Completed', cls:'success' };
      return { label: status.charAt(0).toUpperCase() + status.slice(1), cls:'warning' };
    }

    function renderAppointments(list) {
      userAppts = list;

      if (!apptsList) return;
      if (!list.length) {
        apptsList.innerHTML =
          '<p class="muted small-text">No appointments on record yet for this user.</p>';
        if (apptsSummary) apptsSummary.textContent = '';
        return;
      }

      const upcoming = list.filter(a => a.status !== 'completed' && a.status !== 'cancelled').length;
      const completed = list.filter(a => a.status === 'completed').length;
      if (apptsSummary) {
        apptsSummary.textContent = `${list.length} total · ${upcoming} active · ${completed} completed`;
      }

      apptsList.innerHTML = list.map(a => {
        const whenDate = a.date ? new Date(a.date).toLocaleDateString() : '—';
        const whenTime = a.time ? new Date(a.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
        const labelWhen = whenTime ? `${whenDate} · ${whenTime}` : whenDate;

        const st = mapApptStatus(a.status);
        const service = a.service || a.type || 'Appointment';
        const location = a.location || a.city || a.country || '';

        const detailsHref = `/views/pages/appointment-details.html?appointment_id=${encodeURIComponent(a.id)}`;

        return `
          <article class="app-card" data-appt-id="${a.id}">
            <div class="top">
              <div>
                <strong>${service}</strong>
                <div class="meta">
                  <span><i class="fa fa-calendar"></i> ${labelWhen}</span>
                  ${location ? `<span><i class="fa fa-location-dot"></i> ${location}</span>` : ''}
                </div>
              </div>
              <div>
                <span class="badge ${st.cls}">${st.label}</span>
              </div>
            </div>
            <div class="meta">
              ${a.service ? `<span><i class="fa fa-hashtag"></i> Ref: ${a.service}</span>` : ''}
              ${a.channel ? `<span><i class="fa fa-credit-card"></i> ${a.channel}</span>` : ''}
            </div>
            <div class="toolbar" style="margin-top:.3rem;gap:.35rem;flex-wrap:wrap;">
              <button class="btn outline btn-sm" data-action="view-appt">
                <i class="fa fa-eye"></i> View details
              </button>
              <a href="${detailsHref}" class="btn outline btn-sm">
                <i class="fa fa-up-right-from-square"></i> Open full page
              </a>
            </div>
          </article>
        `;
      }).join('');
    }

    async function loadAppointments() {
      if (!viewedUserId || !apptsList) return;
      apptsList.innerHTML = '<p class="muted small-text">Loading appointments...</p>';
      try {
        const { data, error } = await sb
          .from('appointments')
          .select(`
            id,
            user_id,
            status,
            type,
            service,
            date,
            time,
            location,
            channel,
            notes,
            created_at
          `)
          .eq('user_id', viewedUserId)
          .order('date', { ascending:false })
          .order('created_at', { ascending:false })
          .limit(200);
        if (error) throw error;
        renderAppointments(data || []);
      } catch (e) {
        console.error(e);
        apptsList.innerHTML = '<p class="muted small-text">Failed to load appointments.</p>';
      }
    }

    function openApptModal(appt) {
      if (!apptModal) return;
      const service = appt.service || appt.type || 'Appointment';
      const whenDate = appt.date ? new Date(appt.date).toLocaleDateString() : '—';
      const whenTime = appt.time ? new Date(appt.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
      const st = mapApptStatus(appt.status);

      apptModalTitle.textContent = service;
      apptModalSubtitle.textContent = `${whenDate}${whenTime ? ' · ' + whenTime : ''} · ${st.label}`;
      apptModalContent.innerHTML = `
        <ul class="list-simple">
          <li><span>Status</span><span class="badge ${st.cls}">${st.label}</span></li>
          ${appt.service ? `<li><span>Service</span><span class="muted">${appt.service}</span></li>` : ''}
          ${appt.channel ? `<li><span>Channel</span><span class="muted">${appt.channel}</span></li>` : ''}
          ${appt.location ? `<li><span>Location</span><span class="muted">${appt.location}</span></li>` : ''}
          ${appt.created_at ? `<li><span>Created</span><span class="muted">${new Date(appt.created_at).toLocaleString()}</span></li>` : ''}
        </ul>
        ${appt.notes ? `<p class="muted small-text" style="margin-top:.5rem;">${appt.notes}</p>` : ''}
      `;

      if (apptDetailsLink) {
        apptDetailsLink.href = `/views/pages/appointment-details.html?appointment_id=${encodeURIComponent(appt.id)}`;
      }

      apptModal.style.display = 'flex';
      trapFocus(apptModal);
    }

    function closeApptModal() {
      if (apptModal) apptModal.style.display = 'none';
    }

    apptModalClose?.addEventListener('click', closeApptModal);
    apptModal?.addEventListener('click',(e)=>{
      if (e.target === apptModal) closeApptModal();
    });

    apptsList?.addEventListener('click',(e)=>{
      const btn = e.target.closest('[data-action="view-appt"]');
      if (!btn) return;
      const card = btn.closest('[data-appt-id]');
      if (!card) return;
      const id = card.getAttribute('data-appt-id');
      const appt = userAppts.find(a => String(a.id) === String(id));
      if (!appt) return;
      openApptModal(appt);
    });

    refreshApptsBtn?.addEventListener('click', loadAppointments);

    async function toggleFollowElite() {
      if (!sessionUser?.id) {
        showToast('Log in to follow Elite updates.');
        return;
      }

      try{
        const { error } = await sb.from('followers').insert({
          follower_id: sessionUser.id,
          target_type: 'brand',
          target_id: 'd9dfb9cd-2f74-4541-9cc8-8fc5fbc62257',
          meta: { source: 'profile_follow_button' }
        });
        if (error && !/duplicate|unique/i.test(error.message)) {
          followStatus.textContent = error.message;
          followStatus.className = 'muted small-text danger';
          return;
        }

        followStatus.textContent = 'You are following Elite updates. We will send you new jobs and important changes.';
        followStatus.className = 'muted small-text success';
        showToast('You are now following Elite updates.');
      }catch(e){
        console.error(e);
        followStatus.textContent = e.message || 'Failed to follow Elite updates.';
        followStatus.className = 'muted small-text danger';
      }
    }

    document.getElementById('refreshAppsBtn')?.addEventListener('click', loadApps);
    document.getElementById('refreshPaysBtn')?.addEventListener('click', loadPays);
    document.getElementById('refreshTestsBtn')?.addEventListener('click', loadTests);

    // Nav auth actions
    loginBtn?.addEventListener('click', ()=> window.location.href='/views/pages/login.html');
    mobileLoginBtn?.addEventListener('click', ()=> window.location.href='/views/pages/login.html');

    logoutBtn?.addEventListener('click', async ()=>{
      await sb.auth.signOut();
      setAuthPills(null);
      window.location.href='/views/pages/login.html';
    });
    mobileLogoutBtn?.addEventListener('click', async ()=>{
      await sb.auth.signOut();
      setAuthPills(null);
      window.location.href='/views/pages/login.html';
    });

    profileBtn?.addEventListener('click', ()=> window.location.href='/views/pages/profile.html');
    mobileProfileBtn?.addEventListener('click', ()=> window.location.href='/views/pages/profile.html');

    // Mobile menu
    menuToggle?.addEventListener('click', ()=>{
      const isOpen = mobilePanel.classList.toggle('open');
      menuToggle.setAttribute('aria-expanded', String(isOpen));
    });
    mobilePanel?.addEventListener('click',(e)=>{
      if(e.target.matches('a')){
        mobilePanel.classList.remove('open');
        menuToggle.setAttribute('aria-expanded','false');
      }
    });

    // About modal
    document.getElementById('closeAbout')?.addEventListener('click', () => {
      aboutModal.style.display = 'none';
    });
    aboutModal?.addEventListener('click', (e) => {
      if (e.target === aboutModal) aboutModal.style.display = 'none';
    });

    // Init
    (async ()=>{
      const ok = await fetchSessionAndRole();
      if (!ok) return;

      const viewedOk = await resolveViewedUser();
      if (!viewedOk) return;

      await loadProfile();
      await loadPays();
      await loadApps();
      await loadTests();
      await loadAppointments();

      followEliteBtn?.addEventListener('click', toggleFollowElite);
      followBtn?.addEventListener('click', toggleFollowElite);
    })();
  </script>
</body>
</html>
