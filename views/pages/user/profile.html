<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>User Profile — Elite Travel & Tour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Your Elite Travel & Tour profile: applications, tracking, payments, notifications, appointments, testimonials, and account settings with realtime updates."/>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Standard ICO -->
<link rel="icon" href="/favicon.ico" type="image/x-icon">

<!-- Or PNG -->
<link rel="icon" href="/favicon.png" type="image/png">

<!-- Optional: SVG -->
<link rel="icon" href="/favicon.svg" type="image/svg+xml">

  <style>
    body{margin-top: 100px;}
   
    .page-wrap{
      max-width:1100px;
      margin:1.3rem auto 2rem;
      padding:0 1rem;
    }

    .profile-layout{
      margin-top:.5rem;
      display:grid;
      grid-template-columns:minmax(0,1.9fr) minmax(0,1.1fr);
      gap:1rem;
    }
    @media(max-width:980px){
      .profile-layout{ grid-template-columns:1fr; }
    }

    /* .card{
      background:#ffffff;
      border-radius:14px;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 40px rgba(15,23,42,.12);
      overflow:hidden;
    }
    .card .body{
      padding:1rem 1.1rem 1.1rem;
    } */

    /* Hero */
    .profile-hero{
      position:relative;
      padding:1.1rem 1.1rem 0.9rem;
      display:grid; gap:.5rem;
    }
    .hero-cover{
      position:relative; border-radius:18px;
      height:170px; overflow:hidden;
      background:radial-gradient(circle at top, #1d4ed8, #020617);
    }
    .hero-cover img{
      width:100%; height:100%; object-fit:cover;
      opacity:.96; filter:contrast(1.02) saturate(1.02);
    }
    .hero-cover::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(to bottom, rgba(15,23,42,.05), rgba(15,23,42,.6));
      mix-blend-mode:multiply;
    }
    .hero-main{
      display:flex; justify-content:space-between; align-items:flex-end;
      margin-top:-6px; gap:1rem; flex-wrap:wrap;
    }
    .hero-left{ display:flex; gap:.75rem; align-items:flex-end; }
    .hero-avatar{
      width:78px; height:78px; border-radius:50%;
      border:3px solid #fff; overflow:hidden;
      box-shadow:0 16px 35px rgba(15,23,42,.45);
      background:#020617;
    }
    .hero-avatar img{ width:100%; height:100%; object-fit:cover; }
    .hero-meta h2{ margin:0; font-size:1.35rem; color:#f9fafb; }
    .hero-meta p{ margin:.15rem 0 0; font-size:.9rem; color:#e5e7eb; }
    .hero-meta .tags{ margin-top:.3rem; display:flex; gap:.4rem; flex-wrap:wrap; }
    .hero-meta .tags span{
      font-size:.78rem; padding:.12rem .45rem; border-radius:999px;
      background:rgba(15,23,42,.75); color:#e5e7eb;
      border:1px solid rgba(148,163,184,.7);
    }
    .hero-actions{ display:flex; gap:.4rem; flex-wrap:wrap; }

    .hero-stats{
      display:flex; justify-content:space-between; gap:.6rem; margin-top:.75rem; flex-wrap:wrap;
    }
    .stat-pill{
      flex:1 1 110px; min-width:0;
      background:#0f172a; border-radius:12px;
      box-shadow:0 14px 30px rgba(15,23,42,.7); padding:.6rem .7rem;
    }
    .stat-pill span.label{ font-size:.78rem; color:#e5e7eb; }
    .stat-pill div.value{ font-size:1.1rem; font-weight:700; color:#fbbf24; }

    .tabs{
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid #e5e7eb; margin-top:.65rem;
    }
    .tab-list{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .tab-btn{
      border:none; background:transparent; padding:.45rem .65rem;
      border-radius:999px; font-size:.9rem; color:var(--brand); cursor:pointer;
    }
    .tab-btn.active{
      background:#1d4ed8; color:#eff6ff; font-weight:600;
    }
    .tab-panel{ display:none; padding-top:.75rem; }
    .tab-panel.active{ display:block; }

    .section-title{ font-size:1.05rem; margin:0 0 .3rem; }
    .muted{ color:var(--muted); }
    .small-text{ font-size:.8rem; }

    .about-grid{ display:grid; gap:.6rem; grid-template-columns:1.1fr 1.2fr; }
    @media(max-width:780px){ .about-grid{ grid-template-columns:1fr; } }

    .list-simple{ list-style:none; padding:0; margin:0; }
    .list-simple li{
      padding:.45rem 0; border-bottom:1px solid #edf1f7; font-size:.9rem;
      display:flex; justify-content:space-between; gap:.5rem;
    }
    .list-simple li:last-child{ border-bottom:none; }

    .apps-grid{ display:grid; gap:.6rem; }
    .app-card{
      border-radius:12px; border:1px solid rgba(15,23,42,.06); padding:.6rem .7rem; background:var(--bg);
      display:grid; gap:.25rem; box-shadow: var(--shadow);
    }
    .app-card .top{ display:flex; justify-content:space-between; align-items:center; gap:.5rem; }
    .app-card .meta{ font-size:.82rem; color:var(--light); display:flex; gap:.5rem; flex-wrap:wrap; }

    .pay-card,.test-card{
      border-radius:12px; box-shadow:0 16px 35px rgba(15,23,42,.06); padding:.6rem .7rem; background:var(--bg); font-size:.9rem;
      display:grid; gap:.2rem;
    }

    .pill-soft{
      display:inline-flex; align-items:center; gap:.25rem;
      padding:.18rem .5rem; border-radius:999px;
      border:1px solid rgba(15,23,42,.06);
      background:#f9fafb;
      font-size:.78rem;
      color:#92400e;
    }
    
    .badge.success{ border-color:#22c55e; background:#dcfce7; color:#166534; }
    .badge.danger{ border-color:#ef4444; background:#fee2e2; color:#991b1b; }
    .badge.warning{ border-color:#fbbf24; background:#fef9c3; color:#92400e; }

    .chip-row{ display:flex; gap:.3rem; flex-wrap:wrap; }

    .timeline{
      margin-top:.4rem;
      border-left:3px solid var(--warning);
      padding-left:.6rem;
      padding-top:5px;
      padding-bottom:5px;
      font-size:.82rem;
      border-radius:4px;
      box-shadow:0 12px 30px rgba(15,23,42,.08);
      background:var(--brand-600);
    }
    .timeline-item{
      margin-bottom:.35rem;
    }
    .timeline-item strong{
      display:block;
      color:var(--warning);
    }
    .timeline-item span{
      color:var(--light);
    }

    .profile-layout-right .card{ margin-bottom:1rem; }
    .widget h3{ font-size:1.05rem; margin-bottom:.2rem; }

    /* .modal{
      display:none; position:fixed; inset:0;
      background:rgba(15,23,42,.65);
      align-items:center; justify-content:center; z-index:1200;
    }
    .modal .card{
      max-width:480px; width:92%;
      border-radius:14px;
      border:1px solid #e5e7eb;
      box-shadow:0 24px 60px rgba(15,23,42,.8);
      background:#ffffff; color:#111827;
    }
    .modal .body{
      padding:1rem 1.1rem 1.1rem;
    }
    .modal h3{ margin-top:0; }
    .modal .subtitle{ font-size:.85rem; color:#6b7280; } */

    .input, .textarea{
      width:100%;
      box-sizing:border-box;
      padding:.55rem .7rem;
      border-radius:10px;
      border:1px solid #d1d5db;
      background: rgba(56,189,248,.35);
      font-size:.9rem;
      color:var(--light);
      transition:border-color .12s, box-shadow .12s;
    }
    .input:focus, .textarea:focus{
      outline:none;
      border-color:#38bdf8;
      box-shadow:0 0 0 2px rgba(56,189,248,.35);
    }
    .textarea{ min-height:80px; resize:vertical; }
  </style>
</head>
<body>
  <!-- Header -->
  <nav aria-label="Primary">
    <div class="wrap">
      <a class="logo" href="/"><img src="/assets/logo/logo.png" alt="Elite Travel & Tour"></a>
      <ul class="primary">
        <li><a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a></li>
        <li><a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a></li>
        <li><a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a></li>
        <li><a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a></li>
        <li><a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a></li>
        <li><a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a></li>
        <li><a href="/views/pages/profile.html" class="active"><i class="fa fa-user"></i> Profile</a></li>
      </ul>
      <div class="nav-right">
        <button id="bellBtn" class="btn outline bell" aria-label="Notifications">
          <i class="fa-regular fa-bell"></i>
          <span id="bellCount" class="count hidden">0</span>
        </button>
        <span id="navAuthPill" class="auth-pill" style="display:none;">
          <i class="fa fa-user-check"></i><span id="navAuthText">Guest</span>
        </span>
        <button id="loginBtn" class="btn outline"><i class="fa fa-right-to-bracket"></i> Login</button>
        <button id="profileBtn" class="btn outline" style="display:none"><i class="fa fa-user"></i></button>
        <button id="logoutBtn" class="btn outline" style="display:none"><i class="fa fa-right-from-bracket"></i></button>
        <button id="menuToggle" class="menu-toggle" aria-expanded="false"><i class="fa fa-bars"></i></button>
      </div>
    </div>

    <!-- Mobile panel -->
    <div id="mobilePanel" class="mobile-panel">
      <div class="block">
        <a href="/views/pages/index.html"><i class="fa fa-house"></i> Home</a>
        <a href="/views/pages/services.html"><i class="fa fa-suitcase"></i> Services</a>
        <a href="/views/pages/work-and-pay.html"><i class="fa fa-briefcase"></i> Work & Pay</a>
        <a href="/views/pages/appointment.html"><i class="fa fa-calendar"></i> Book</a>
        <a href="/views/pages/contact.html"><i class="fa fa-envelope"></i> Contact</a>
        <a href="/views/pages/about.html"><i class="fa fa-circle-info"></i> About</a>
        <a href="/views/pages/profile.html" class="active"><i class="fa fa-user"></i> Profile</a>
      </div>
      <div class="block">
        <span class="auth-pill"><i class="fa fa-user"></i><span id="mobileAuthText">Guest</span></span>
        <div class="toolbar" style="margin-top:.4rem;">
          <button id="mobileLoginBtn" class="btn outline"><i class="fa fa-right-to-bracket"></i> Login</button>
          <button id="mobileProfileBtn" class="btn outline" style="display:none"><i class="fa fa-user"></i> Profile</button>
          <button id="mobileLogoutBtn" class="btn outline" style="display:none"><i class="fa fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Notification feed -->
  <div id="notifFeed" class="feed hidden">
  <div class="feed-toolbar">
    <span class="muted small-text">Notifications</span>
    <div style="color:var(--brand);display:flex;gap:.25rem;">
      <button id="markAllReadBtn" class='btn ' style="color:var(--brand);" ><i class="fa fa-check-double"></i> Mark as Read</button>
      <button id="clearAllNotifBtn" class='btn '><i class="fa fa-trash"></i> Clear</button>
    </div>
  </div>
  <div id="notifList" class="list"></div>
</div>
<script type="module" src="/src/js/notifications.js"></script>
  

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <i class="fa fa-info-circle"></i><span id="toastText">Notice</span>
  </div>

  <div class="page-wrap">
    <main class="profile-layout">
      <!-- Left: Profile + tabs -->
      <section class="card" aria-label="Profile overview and history">
        <div class="profile-hero">
          <div class="hero-cover">
            <img id="profileCoverImg" src="/assets/profile/cover.jpg" alt="Profile cover">
          </div>
          <div class="hero-main">
            <div class="hero-left">
              <div class="hero-avatar">
                <img id="profileAvatarImg" src="/assets/profile/avatar.jpg" alt="Avatar">
              </div>
              <div class="hero-meta">
                <h2 id="profileName">Loading...</h2>
                <p id="profileEmail">—</p>
                <div class="tags">
                  <span id="profileStatusTag"><i class="fa fa-circle-check"></i> Verified account</span>
                  <span id="profileCountryTag" style="display:none;"><i class="fa fa-location-dot"></i> <span id="profileCountryText">Ghana</span></span>
                  <span id="profileModeTag" style="display:none;"><i class="fa fa-shield-halved"></i> Admin viewing</span>
                </div>
              </div>
            </div>
            <div class="hero-actions">
              <button class="btn outline" id="aboutBtn"><i class="fa fa-id-card"></i> About</button>
              <button class="btn outline" id="editProfileBtn"><i class="fa fa-user-pen"></i> Edit profile</button>
              <button class="btn brand" id="followBtn"><i class="fa fa-bell"></i> Follow Elite updates</button>
            </div>
          </div>

          <div class="hero-stats">
            <div class="stat-pill">
              <span class="label">Account age</span>
              <div class="value" id="statAge">–</div>
            </div>
            <div class="stat-pill">
              <span class="label">Applications</span>
              <div class="value" id="statApps">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Active applications</span>
              <div class="value" id="statActiveApps">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Completed</span>
              <div class="value" id="statCompletedApps">0</div>
            </div>
            <div class="stat-pill">
              <span class="label">Pending payments</span>
              <div class="value" id="statPendingPayments">0</div>
            </div>
          </div>

          <div class="tabs">
            <div class="tab-list">
              <button class="tab-btn active" data-tab="overview">Overview</button>
              <button class="tab-btn" data-tab="apps">Applications</button>
              <button class="tab-btn" data-tab="appointments">Appointments</button>
              <button class="tab-btn" data-tab="pays">Payments</button>
              <button class="tab-btn" data-tab="tests">Testimonials</button>
            </div>
          </div>
        </div>

        <div class="body">
          <!-- Overview -->
          <section id="tab-overview" class="tab-panel active" aria-label="Overview">
            <div class="about-grid">
              <div>
                <h3 class="section-title">Account details</h3>
                <ul id="profileDetailsList" class="list-simple">
                  <li><span>Email</span><span class="muted">Loading...</span></li>
                </ul>
                <p id="accountIntro" class="muted small-text" style="margin-top:.6rem;">
                  Use this dashboard to track your applications, appointments, payments, and notifications in one place.
                </p>
              </div>
              <div>
                <h3 class="section-title">Profile completeness</h3>
                <div id="completenessRow" class="chip-row">
                  <span class="pill-soft"><i class="fa fa-circle-notch"></i> Loading...</span>
                </div>
              </div>
            </div>

            <div style="margin-top:1rem;">
              <h3 class="section-title">Current journey</h3>
              <p id="currentJourneyText" class="muted small-text">No active application selected.</p>
              <div id="currentJourneyTimeline" class="timeline" style="margin-top:.4rem;"></div>
            </div>

            <div style="margin-top:1rem;">
              <h3 class="section-title">Latest activity</h3>
              <div id="overviewActivity" class="timeline"></div>
            </div>
          </section>

          <!-- Applications -->
          <section id="tab-apps" class="tab-panel" aria-label="Applications">
            <h3 class="section-title">Applications</h3>
            <p class="muted small-text">All applications you have made for jobs, visas, or programs.</p>
            <div class="toolbar" style="margin:.4rem 0;gap:.3rem;flex-wrap:wrap;">
              <button id="refreshAppsBtn" class="btn outline btn-sm"><i class="fa fa-rotate"></i> Refresh</button>
              <div class="pill-soft">
                <i class="fa fa-location-arrow"></i>
                <input id="quickTrackInput" class="input" style="border:none;padding:0 .2rem;background:transparent;box-shadow:none;" placeholder="Quick tracking ID"/>
                <button id="quickTrackBtn" class="btn outline btn-sm"><i class="fa fa-arrow-right"></i> Open</button>
              </div>
            </div>
            <div id="appsEl" class="apps-grid">
              <div class="muted small-text">Loading applications...</div>
            </div>
          </section>

          <!-- Appointments -->
          <section id="tab-appointments" class="tab-panel" aria-label="Appointments history">
            <h3 class="section-title">Appointments</h3>
            <p class="muted small-text">
              View all appointments booked with Elite Travel &amp; Tour. Click “View details” to see more information
              or open the full appointment details page.
            </p>

            <div class="toolbar" style="margin:.5rem 0;gap:.35rem;flex-wrap:wrap;">
              <button id="refreshApptsBtn" class="btn outline btn-sm">
                <i class="fa fa-rotate"></i> Refresh
              </button>
              <span id="apptsSummary" class="muted small-text"></span>
            </div>

            <div id="apptsList" class="apps-grid">
              <p class="muted small-text">Loading appointments...</p>
            </div>
          </section>

          <!-- Payments -->
          <section id="tab-pays" class="tab-panel" aria-label="Payments">
            <h3 class="section-title">Payments</h3>
            <p class="muted small-text">Payment history linked to your applications or services.</p>
            <div class="toolbar" style="margin:.5rem 0;gap:.35rem;flex-wrap:wrap;">
              <button id="refreshPaysBtn" class="btn outline btn-sm"><i class="fa fa-rotate"></i> Refresh</button>
            </div>
            <div id="paysEl" class="apps-grid">
              <p class="muted small-text">Loading payments...</p>
            </div>
          </section>

          <!-- Testimonials -->
          <section id="tab-tests" class="tab-panel" aria-label="Testimonials">
            <h3 class="section-title">Testimonials</h3>
            <p class="muted small-text">
              Share your experience with Elite Travel &amp; Tour. Testimonials may appear on our site (with your consent).
            </p>

            <div class="test-card" style="margin:.6rem 0;">
              <h4 class="small-text" style="margin-top:0;">Write a testimonial</h4>
              <div style="display:grid;gap:.5rem;">
                <div>
                  <label class="small-text">Rating</label>
                  <select id="tRating" class="input" style="max-width:200px;">
                    <option value="">Select rating</option>
                    <option value="5">★★★★★ — Excellent</option>
                    <option value="4">★★★★☆ — Very good</option>
                    <option value="3">★★★☆☆ — Good</option>
                    <option value="2">★★☆☆☆ — Fair</option>
                    <option value="1">★☆☆☆☆ — Poor</option>
                  </select>
                </div>
                <div>
                  <label class="small-text">Title</label>
                  <input id="tTitle" class="input" placeholder="e.g. Smooth Work & Pay process">
                </div>
                <div>
                  <label class="small-text">Your testimonial</label>
                  <textarea id="tText" class="textarea" placeholder="Tell us what stood out — clarity, communication, timelines, etc."></textarea>
                </div>
                <div class="toolbar" style="justify-content:space-between;flex-wrap:wrap;">
                  <span id="tStatus" class="muted small-text"></span>
                  <button id="tAdd" class="btn brand btn-sm">
                    <i class="fa fa-paper-plane"></i> Submit
                  </button>
                </div>
              </div>
            </div>

            <div id="testsEl" class="apps-grid" ></div>
          </section>
        </div>
      </section>

      <!-- Right: widgets -->
      <aside class="profile-layout-right">
        <section class="card widget">
          <div class="body">
            <h3>Settings</h3>
            <p id="adminViewNote" class="muted small-text" style="display:none;margin-bottom:.4rem;">
              You are viewing another user’s profile as an admin. Use admin tools for sensitive changes.
            </p>
            <form id="profileForm" class="list-simple" style="border:none;">
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Email</label>
                <div id="settingsEmail" class="small-text muted">—</div>
              </div>
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Full name</label>
                <input id="inputFullname" class="input" placeholder="Your name">
              </div>
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Phone</label>
                <input id="inputPhone" class="input" placeholder="Phone number">
              </div>
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Country</label>
                <input id="inputCountry" class="input" placeholder="Country">
              </div>
              <div style="margin-bottom:.4rem;">
                <label class="small-text">Joined</label>
                <div id="settingsJoined" class="small-text muted">—</div>
              </div>
              <div class="toolbar" style="margin-top:.6rem;justify-content:space-between;flex-wrap:wrap;">
                <span id="profileStatus" class="muted small-text"></span>
                <button id="profileSaveBtn" class="btn brand btn-sm" type="submit">
                  <i class="fa fa-save"></i> Save
                </button>
              </div>
            </form>
          </div>
        </section>

        <section class="card widget">
          <div class="body">
            <h3>Quick actions</h3>
            <div class="chip-row" style="margin-bottom:.4rem;">
              <span class="pill-soft"><i class="fa fa-calendar-check"></i> Appointments</span>
              <span class="pill-soft"><i class="fa fa-credit-card"></i> Payments</span>
              <span class="pill-soft"><i class="fa fa-globe"></i> Travel</span>
            </div>
            <div style="display:grid;gap:.45rem;">
              <button id="followEliteBtn" class="btn outline btn-sm">
                <i class="fa fa-bell"></i> Follow Elite updates
              </button>
              <a href="/views/pages/appointment.html" class="btn outline btn-sm">
                <i class="fa fa-calendar"></i> Book appointment
              </a>
              <a href="/views/pages/contact.html" class="btn outline btn-sm">
                <i class="fa fa-envelope"></i> Contact support
              </a>
            </div>
            <p id="followStatus" class="muted small-text" style="margin-top:.5rem;"></p>
          </div>
        </section>

        <section class="card widget">
          <div class="body">
            <h3>Sidebar notifications</h3>
            <div id="sidebarNotifs" class="list" style="font-size:.82rem;"></div>
          </div>
        </section>
      </aside>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal" id="nameModal">
    <section class="card"><div class="body">
      <h3>Update display name</h3>
      <p class="subtitle">This name appears on your profile and may appear on testimonials.</p>
      <input id="newName" class="input" placeholder="New name">
      <div class="toolbar" style="margin-top:.7rem;justify-content:flex-end;">
        <button id="cancelName" class="btn outline btn-sm"><i class="fa fa-xmark"></i> Cancel</button>
        <button id="saveName" class="btn brand btn-sm"><i class="fa fa-save"></i> Save</button>
      </div>
    </div></section>
  </div>

  <div class="modal" id="passwordModal">
    <section class="card"><div class="body">
      <h3>Change password</h3>
      <p class="subtitle">Choose a strong password you do not use elsewhere.</p>
      <input id="newPassword" type="password" class="input" placeholder="New password (min 8 characters)">
      <div class="toolbar" style="margin-top:.7rem;justify-content:flex-end;">
        <button id="cancelPassword" class="btn outline btn-sm"><i class="fa fa-xmark"></i> Cancel</button>
        <button id="savePassword" class="btn brand btn-sm"><i class="fa fa-save"></i> Save</button>
      </div>
    </div></section>
  </div>

  <div class="modal" id="avatarModal">
    <section class="card"><div class="body">
      <h3>Update avatar</h3>
      <p class="subtitle">Upload a clear headshot. Max size set by storage rules.</p>
      <input id="newAvatar" type="file" accept="image/*">
      <div class="toolbar" style="margin-top:.7rem;justify-content:flex-end;">
        <button id="cancelAvatar" class="btn outline btn-sm"><i class="fa fa-xmark"></i> Cancel</button>
        <button id="saveAvatar" class="btn brand btn-sm"><i class="fa fa-save"></i> Save</button>
      </div>
    </div></section>
  </div>

  <div class="modal" id="coverModal">
    <section class="card"><div class="body">
      <h3>Update cover photo</h3>
      <p class="subtitle">Choose an image that reflects your journey.</p>
      <input id="newCover" type="file" accept="image/*">
      <div class="toolbar" style="margin-top:.7rem;justify-content:flex-end;">
        <button id="cancelCover" class="btn outline btn-sm"><i class="fa fa-xmark"></i> Cancel</button>
        <button id="saveCover" class="btn brand btn-sm"><i class="fa fa-save"></i> Save</button>
      </div>
    </div></section>
  </div>

  <div class="modal" id="aboutModal">
    <section class="card"><div class="body">
      <h3>About this account</h3>
      <p class="subtitle">High‑level details for this account, including status and history.</p>
      <div id="aboutContent"></div>
      <div class="toolbar" style="margin-top:.7rem;justify-content:flex-end;">
        <button id="closeAbout" class="btn outline btn-sm"><i class="fa fa-xmark"></i> Close</button>
      </div>
    </div></section>
  </div>

  <!-- Appointment details modal (profile-side) -->
  <div class="modal" id="apptModal" role="dialog" aria-modal="true" aria-labelledby="apptModalTitle">
    <section class="card">
      <div class="body">
        <h3 id="apptModalTitle">Appointment details</h3>
        <p id="apptModalSubtitle" class="subtitle small-text"></p>

        <div id="apptModalContent" class="small-text" style="margin-top:.5rem;"></div>

        <div class="toolbar" style="margin-top:.7rem;justify-content:flex-end;gap:.4rem;">
          <button id="apptModalClose" class="btn outline btn-sm">
            <i class="fa fa-xmark"></i> Close
          </button>
          <a id="apptDetailsLink" href="#" class="btn brand btn-sm" target="_blank" rel="noopener">
            <i class="fa fa-up-right-from-square"></i> Open full page
          </a>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { sb } from '/src/js/supabase.js';

    /* Utility: toast */
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');
    function showToast(message, ms=2500){
      if (!toast || !toastText) return;
      toastText.textContent = message;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), ms);
    }

    /* Notification feed toggle */
    document.addEventListener('click',(e)=>{
      const feed=document.getElementById('notifFeed');
      if(!feed) return;
      if(e.target.closest('#bellBtn')){ feed.classList.toggle('hidden'); }
      else if(!e.target.closest('#notifFeed')){ feed.classList.add('hidden'); }
    });

    /* Notifications state */
    // const bellCount = document.getElementById('bellCount');
    // const notifList = document.getElementById('notifList');
    // const sidebarNotifs = document.getElementById('sidebarNotifs');
    // const markAllReadBtn = document.getElementById('markAllReadBtn');
    // const clearAllNotifBtn = document.getElementById('clearAllNotifBtn');

    // let notifHistory = [];
    // let notifChannel = null;
    // let unreadCount = 0;

    // function withSeenTrue(meta){
    //   const m = meta || {};
    //   return { ...m, seen:true };
    // }

    // function renderNotificationItem(n) {
    //   const when = n.created_at ? new Date(n.created_at).toLocaleString() : '';
    //   const isUnread = !n.metadata?.seen;
    //   const el = document.createElement('div');
    //   el.className = 'notif-item';
    //   el.innerHTML = `
    //     <div class="title">${n.title || 'Notification'}</div>
    //     <div class="body">${n.message || n.text || ''}</div>
    //     <div class="notif-meta">
    //       <span>${when}</span>
    //       <span class="notif-chip">${isUnread ? '<i class="fa fa-circle-dot"></i> New' : '<i class="fa fa-circle-check"></i> Read'}</span>
    //     </div>
    //   `;
    //   return el;
    // }

    // function recomputeUnread() {
    //   unreadCount = notifHistory.filter(n => !n.metadata?.seen).length;
    // }

    // function updateBellCounter() {
    //   recomputeUnread();
    //   if (bellCount) {
    //     if (unreadCount > 0) {
    //       bellCount.textContent = String(unreadCount);
    //       bellCount.classList.remove('hidden');
    //     } else {
    //       bellCount.textContent = '0';
    //       bellCount.classList.add('hidden');
    //     }
    //   }
    // }

    // function renderNotificationFeed(list) {
    //   if (!notifList) return;
    //   notifList.innerHTML = '';
    //   if (!list.length) {
    //     notifList.innerHTML = '<div class="muted small-text">No recent notifications.</div>';
    //     bellCount?.classList.add('hidden');
    //     return;
    //   }
    //   list.slice().reverse().forEach(n => {
    //     notifList.appendChild(renderNotificationItem(n));
    //   });
    //   updateBellCounter();
    // }

    // function renderSidebarNotifications(list) {
    //   if (!sidebarNotifs) return;
    //   sidebarNotifs.innerHTML = '';
    //   if (!list.length) {
    //     sidebarNotifs.innerHTML = '<div class="muted small-text">New items will appear here.</div>';
    //     return;
    //   }
    //   list.slice(0,5).forEach(n => {
    //     const when = n.created_at ? new Date(n.created_at).toLocaleString() : '';
    //     const div = document.createElement('div');
    //     div.className = 'notif-item';
    //     div.innerHTML = `
    //       <div class="title">${n.title || 'Notification'}</div>
    //       <div class="body">${n.message || n.text || ''}</div>
    //       <div class="small-text">${when}</div>
    //     `;
    //     sidebarNotifs.appendChild(div);
    //   });
    // }

    // function addNotificationToHistory(n) {
    //   notifHistory.unshift({
    //     ...n,
    //     metadata:n.metadata || {}
    //   });
    //   if (notifHistory.length > 50) notifHistory.length = 50;
    //   renderNotificationFeed(notifHistory);
    //   renderSidebarNotifications(notifHistory);
    // }

    // async function subscribeNotifications(userId) {
    //   if (notifChannel) {
    //     await sb.removeChannel(notifChannel);
    //     notifChannel = null;
    //   }
    //   notifChannel = sb
    //     .channel(`profile-notifs-${userId}`)
    //     .on(
    //       'postgres_changes',
    //       {
    //         event: 'INSERT',
    //         schema: 'public',
    //         table: 'notifications',
    //         filter: `user_id=eq.${userId}`
    //       },
    //       (payload) => {
    //         const n = payload.new;
    //         addNotificationToHistory(n);
    //         showToast(n.title || 'New notification', 3000);
    //       }
    //     )
    //     .subscribe();
    // }

    // async function loadInitialNotifications(userId) {
    //   try {
    //     const { data, error } = await sb
    //       .from('notifications')
    //       .select('id,title,message,text,created_at,user_id,metadata')
    //       .eq('user_id', userId)
    //       .order('created_at', { ascending:false })
    //       .limit(30);
    //     if (error) throw error;
    //     notifHistory = (data || []).map(n => ({
    //       ...n,
    //       metadata:n.metadata || {}
    //     }));
    //     renderNotificationFeed(notifHistory);
    //     renderSidebarNotifications(notifHistory);
    //   } catch (e) {
    //     console.error(e);
    //   }
    // }

    // async function markAllNotificationsRead(userId) {
    //   try {
    //     // Update local cache
    //     notifHistory = notifHistory.map(n => ({
    //       ...n,
    //       metadata: withSeenTrue(n.metadata)
    //     }));
    //     renderNotificationFeed(notifHistory);
    //     renderSidebarNotifications(notifHistory);
    //     if (bellCount) {
    //       bellCount.textContent = '0';
    //       bellCount.classList.add('hidden');
    //     }

    //     // Persist to DB
    //     const ids = notifHistory.map(n => n.id).filter(Boolean);
    //     if (!ids.length) return;

    //     const { data: rows, error: fetchErr } = await sb
    //       .from('notifications')
    //       .select('id,metadata')
    //       .in('id', ids);
    //     if (fetchErr) {
    //       console.warn('Failed to fetch notifications for markAllNotificationsRead', fetchErr);
    //       return;
    //     }

    //     for (const row of rows) {
    //       const newMeta = withSeenTrue(row.metadata);
    //       const { error: updErr } = await sb
    //         .from('notifications')
    //         .update({ metadata: newMeta })
    //         .eq('id', row.id);
    //       if (updErr) {
    //         console.warn('Failed to update notification metadata for id', row.id, updErr);
    //       }
    //     }
    //   } catch (e) {
    //     console.warn('markAllNotificationsRead failed', e);
    //   }
    // }

    // async function clearAllNotifications(userId) {
    //   notifHistory = [];
    //   renderNotificationFeed(notifHistory);
    //   renderSidebarNotifications(notifHistory);
    //   try{
    //     const { error } = await sb
    //       .from('notifications')
    //       .delete()
    //       .eq('user_id', userId);
    //     if (error) console.warn('Failed to clear notifications from DB', error);
    //   }catch(e){
    //     console.warn('Failed to clear notifications', e);
    //   }
    // }

    /* Auth + nav UI + admin mode */
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileBtn = document.getElementById('profileBtn');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    const mobileProfileBtn = document.getElementById('mobileProfileBtn');
    const navAuthText = document.getElementById('navAuthText');
    const navAuthPill = document.getElementById('navAuthPill');
    const mobileAuthText = document.getElementById('mobileAuthText');
    const menuToggle = document.getElementById('menuToggle');
    const mobilePanel = document.getElementById('mobilePanel');
    const profileModeTag = document.getElementById('profileModeTag');
    const accountIntro = document.getElementById('accountIntro');
    const adminViewNote = document.getElementById('adminViewNote');
    const profileSaveBtn = document.getElementById('profileSaveBtn');
    const editPasswordBtn = document.getElementById('editPasswordBtn');
    const editAvatarBtn = document.getElementById('editAvatarBtn');
    const editCoverBtn = document.getElementById('editCoverBtn');
    const followBtn = document.getElementById('followBtn');
    const followEliteBtn = document.getElementById('followEliteBtn');

    const urlParams = new URLSearchParams(window.location.search);
    const emailParam = urlParams.get('email');

    let sessionUser = null;
    let viewedUser = null;
    let viewedUserId = null;
    let viewedUserEmail = null;
    let isAdmin = false;
    let isAdminViewingOther = false;

    const profileNameEl = document.getElementById('profileName');
    const profileEmailEl = document.getElementById('profileEmail');
    const profileAvatarImg = document.getElementById('profileAvatarImg');
    const profileCoverImg = document.getElementById('profileCoverImg');
    const countryTag = document.getElementById('profileCountryTag');
    const countryText = document.getElementById('profileCountryText');
    const statAge = document.getElementById('statAge');
    const statApps = document.getElementById('statApps');
    const statActiveApps = document.getElementById('statActiveApps');
    const statCompletedApps = document.getElementById('statCompletedApps');
    const statPendingPayments = document.getElementById('statPendingPayments');
    const completenessRow = document.getElementById('completenessRow');
    const profileDetailsList = document.getElementById('profileDetailsList');
    const currentJourneyText = document.getElementById('currentJourneyText');
    const currentJourneyTimeline = document.getElementById('currentJourneyTimeline');
    const overviewActivity = document.getElementById('overviewActivity');
    const appsEl = document.getElementById('appsEl');
    const paysEl = document.getElementById('paysEl');
    const testsEl = document.getElementById('testsEl');
    const settingsEmail = document.getElementById('settingsEmail');
    const settingsFullname = document.getElementById('settingsFullname');
    const settingsJoined = document.getElementById('settingsJoined');
    const profileStatus = document.getElementById('profileStatus');
    const inputFullname = document.getElementById('inputFullname');
    const inputPhone = document.getElementById('inputPhone');
    const inputCountry = document.getElementById('inputCountry');
    const quickTrackInput = document.getElementById('quickTrackInput');
    const quickTrackBtn = document.getElementById('quickTrackBtn');
    const followStatus = document.getElementById('followStatus');

    const aboutBtn = document.getElementById('aboutBtn');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const nameModal = document.getElementById('nameModal');
    const passwordModal = document.getElementById('passwordModal');
    const avatarModal = document.getElementById('avatarModal');
    const coverModal = document.getElementById('coverModal');
    const aboutModal = document.getElementById('aboutModal');
    const profileForm = document.getElementById('profileForm');

    const apptsList = document.getElementById('apptsList');
    const apptsSummary = document.getElementById('apptsSummary');
    const refreshApptsBtn = document.getElementById('refreshApptsBtn');
    const apptModal = document.getElementById('apptModal');
    const apptModalTitle = document.getElementById('apptModalTitle');
    const apptModalSubtitle = document.getElementById('apptModalSubtitle');
    const apptModalContent = document.getElementById('apptModalContent');
    const apptModalClose = document.getElementById('apptModalClose');
    const apptDetailsLink = document.getElementById('apptDetailsLink');

    let userProfile = null;
    let userApps = [];
    let userPayments = [];
    let userTests = [];
    let userAppts = [];

    function setStatus(msg, type='muted'){
      if(!profileStatus) return;
      profileStatus.textContent = msg || '';
      profileStatus.className = `small-text ${type}`;
    }

    function setAuthPills(session) {
      const user = session?.user || null;
      sessionUser = user;
      if (user) {
        navAuthPill.style.display = 'none';
        navAuthText.textContent = user.email || 'User';
        mobileAuthText.textContent = user.email || 'User';
        loginBtn.style.display = 'inline-flex';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        profileBtn.style.display = 'inline-flex';
        mobileLoginBtn.style.display = 'none';
        mobileLogoutBtn.style.display = 'inline-flex';
        mobileProfileBtn.style.display = 'inline-flex';
      } else {
        navAuthPill.style.display = 'none';
        navAuthText.textContent = 'Guest';
        mobileAuthText.textContent = 'Guest';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        profileBtn.style.display = 'none';
        mobileLoginBtn.style.display = 'inline-flex';
        mobileLogoutBtn.style.display = 'none';
        mobileProfileBtn.style.display = 'none';
      }
    }

    async function fetchSessionAndRole() {
      const { data, error } = await sb.auth.getSession();
      if (error) {
        console.error(error);
        showToast('Failed to get session information.');
        return false;
      }
      const session = data.session;
      setAuthPills(session);
      if (!session?.user) {
        showToast('Please log in to view your profile.');
        window.location.href = '/views/pages/login.html';
        return false;
      }

      sessionUser = session.user;

      // Optional: isAdmin from users table
      try{
        const { data: rows, error: uErr } = await sb
          .from('users')
          .select('id,email,role')
          .eq('id', sessionUser.id)
          .maybeSingle();
        if (!uErr && rows) {
          isAdmin = rows.role === 'admin' || rows.role === 'superadmin';
        }
      }catch(e){
        console.error(e);
      }
      return true;
    }

    async function resolveViewedUser() {
      if (!sessionUser) return false;

      if (emailParam && isAdmin) {
        // Admin viewing another user by email
        try{
          const { data, error } = await sb
            .from('users')
            .select('*')
            .eq('email', emailParam)
            .maybeSingle();
          if (error) throw error;
          if (!data) {
            showToast('User not found for provided email.');
            return false;
          }
          viewedUser = data;
          viewedUserId = data.id;
          viewedUserEmail = data.email;
          isAdminViewingOther = viewedUserId !== sessionUser.id;
        }catch(e){
          console.error(e);
          showToast('Failed to load user.');
          return false;
        }
      } else {
        // Normal: current user
        try{
          const { data, error } = await sb
            .from('users')
            .select('*')
            .eq('id', sessionUser.id)
            .maybeSingle();
          if (error) throw error;
          if (!data) {
            showToast('User profile not found.');
            return false;
          }
          viewedUser = data;
          viewedUserId = data.id;
          viewedUserEmail = data.email;
          isAdminViewingOther = false;
        }catch(e){
          console.error(e);
          showToast('Failed to load your profile.');
          return false;
        }
      }

      if (isAdminViewingOther) {
        profileModeTag.style.display = 'inline-flex';
        adminViewNote.style.display = 'block';
        accountIntro.textContent = 'You are viewing this profile as an admin. Use admin tools for privileged changes.';
      } else {
        profileModeTag.style.display = 'none';
        adminViewNote.style.display = 'none';
      }

      return true;
    }

    async function loadProfile() {
      if (!viewedUserId) return;
      const u = viewedUser;
      userProfile = u;

      const displayName = u.fullname || u.name || viewedUserEmail;
      profileNameEl.textContent = displayName;
      profileEmailEl.textContent = viewedUserEmail;
      settingsEmail.textContent = viewedUserEmail;

      if (profileAvatarImg && u.avatar_url) profileAvatarImg.src = u.avatar_url;
      if (profileCoverImg && u.cover) profileCoverImg.src = u.cover;

      if (u.country) {
        countryTag.style.display = 'inline-flex';
        countryText.textContent = u.country;
      } else {
        countryTag.style.display = 'none';
      }

      const created = u.created_at ? new Date(u.created_at) : null;
      if (created) {
        const diffDays = Math.floor((Date.now() - created.getTime()) / (1000 * 60 * 60 * 24));
        statAge.textContent = diffDays <= 0 ? 'New' : `${diffDays}d`;
        settingsJoined.textContent = created.toLocaleDateString();
      } else {
        statAge.textContent = '–';
        settingsJoined.textContent = '–';
      }

      const chips = [
        { label: 'Name', ok: !!displayName },
        { label: 'Avatar', ok: !!u.avatar_url },
        { label: 'Cover', ok: !!u.cover },
        { label: 'Country', ok: !!u.country },
        { label: 'Phone', ok: !!u.phone }
      ];

      completenessRow.innerHTML = '';
      chips.forEach((c) => {
        const span = document.createElement('span');
        span.className = 'pill-soft';
        span.innerHTML = `<i class="fa ${c.ok ? 'fa-check-circle' : 'fa-circle-exclamation'}"></i> ${c.label}`;
        completenessRow.appendChild(span);
      });

      profileDetailsList.innerHTML = `
        <li><span>Email</span><span class="muted">${viewedUserEmail}</span></li>
        <li><span>Display name</span><span class="muted">${displayName}</span></li>
        <li><span>Status</span><span class="badge">${u.status || 'active'}</span></li>
        ${u.country ? `<li><span>Country</span><span class="muted">${u.country}</span></li>` : ''}
        ${u.created_at ? `<li><span>Joined</span><span class="muted">${new Date(u.created_at).toLocaleDateString()}</span></li>` : ''}
      `;

      document.getElementById('aboutContent').innerHTML = `
        <ul class="list-simple">
          <li><span>Email</span><span class="muted">${viewedUserEmail}</span></li>
          <li><span>Display name</span><span class="muted">${displayName}</span></li>
          <li><span>Status</span><span class="badge">${u.status || 'active'}</span></li>
          ${u.country ? `<li><span>Country</span><span class="muted">${u.country}</span></li>` : ''}
          ${u.created_at ? `<li><span>Joined</span><span class="muted">${new Date(u.created_at).toLocaleString()}</span></li>` : ''}
          <li><span>User ID</span><span class="muted" style="max-width:220px;overflow:hidden;text-overflow:ellipsis;">${viewedUserId}</span></li>
        </ul>
        <p class="muted small-text" style="margin-top:.6rem;">Admins can see additional details needed for verification and compliance, but they are not exposed publicly.</p>
      `;

      inputFullname.value = u.fullname || u.name || '';
      inputPhone.value = u.phone || '';
      inputCountry.value = u.country || '';
    }

    function mapAppStage(app) {
      const status = (app.status || '').toLowerCase();
      if (status === 'completed' || status === 'approved') return 'completed';
      if (status === 'accepted') return 'accepted';
      if (status === 'rejected') return 'rejected';
      if (status === 'pending' || status === 'submitted') return 'application';
      return 'application';
    }

    function stageLabel(stage) {
      switch(stage){
        case 'completed': return 'Completed';
        case 'accepted': return 'Accepted';
        case 'rejected': return 'Rejected';
        case 'application':
        default: return 'In review';
      }
    }

    function renderCurrentJourney(apps) {
      if (!apps.length) {
        currentJourneyText.textContent = 'No active application selected.';
        currentJourneyTimeline.innerHTML = '';
        return;
      }
      const active = apps.filter(a => {
        const s = mapAppStage(a);
        return s !== 'completed';
      });
      const target = active[0] || apps[0];
      const stage = mapAppStage(target);
      const title = target.jobs?.title || 'Application';
      currentJourneyText.textContent = `${title} — ${stageLabel(stage)}`;

      const steps = Array.isArray(target.progress) ? target.progress : [];
      const created = target.created_at ? new Date(target.created_at).toLocaleString() : null;

      const timelineEvents = [];
      if (created) timelineEvents.push({ label:'Application submitted', at:created });

      const map = {
        accepted:'Application accepted',
        payment_received:'Payment received',
        documents_submitted:'Documents submitted',
        visa_submitted:'Visa submitted',
        visa_approved:'Visa approved',
        completed:'Completed / departure'
      };
      steps.forEach(s=>{
        const key = (s.step || s.status || '').toLowerCase();
        const label = map[key] || s.step || s.status || 'Update';
        const at = s.at || s.time || null;
        timelineEvents.push({ label, at: at ? new Date(at).toLocaleString() : '' });
      });

      currentJourneyTimeline.innerHTML = timelineEvents.map(ev=>`
        <div class="timeline-item">
          <strong>${ev.label}</strong>
          <span>${ev.at || ''}</span>
        </div>
      `).join('');
    }

    function renderApplications(apps) {
      userApps = apps;
      statApps.textContent = apps.length;
      const active = apps.filter(a=>{
        const st = mapAppStage(a);
        return st !== 'completed';
      }).length;
      const completed = apps.filter(a=> mapAppStage(a) === 'completed').length;
      statActiveApps.textContent = active;
      statCompletedApps.textContent = completed;

      if (!apps.length) {
        appsEl.innerHTML =
          '<div class="muted small-text">No applications yet for this user.</div>';
        overviewActivity.innerHTML = '<div class="muted small-text">No application activity yet.</div>';
        renderCurrentJourney([]);
        return;
      }

      appsEl.innerHTML = apps.map(app=>{
        const job = app.jobs || {};
        const jobTitle = job.title || 'Application';
        const jobLocation =
          job.city && job.country ? `${job.city}, ${job.country}` : job.country || job.city || '—';
        const stage = mapAppStage(app);
        const status = app.status || 'submitted';
        const tracking = app.tracking_id || null;
        const created = app.created_at ? new Date(app.created_at).toLocaleString() : '—';
        const badgeClass =
          stage === 'completed' ? 'success' :
          (status === 'failed' || status === 'rejected') ? 'danger' :
          'warning';

        const hasSuccessForThisApp = userPayments.some(p=>{
          const meta = p.metadata || {};
          return p.status === 'success' && meta.application_id === app.id;
        });

        const canPayNow = !isAdminViewingOther && (stage === 'accepted' || stage === 'application') && !hasSuccessForThisApp;

        const payLink = canPayNow
          ? `/views/pages/payments.html?type=job&job_id=${encodeURIComponent(app.job_id || '')}&application_id=${encodeURIComponent(app.id)}&tracking=${encodeURIComponent(tracking || '')}&from=profile`
          : null;

        return `
          <article class="app-card">
            <div class="top">
              <div>
                <strong>${jobTitle}</strong>
                <div class="meta">
                  <span>${app.plan || 'Plan'}</span>
                  <span>${app.application_type || 'Application'}</span>
                  <span>${jobLocation}</span>
                  <span>${stageLabel(stage)}</span>
                </div>
              </div>
              <div>
                <span class="badge ${badgeClass}">${status}</span>
              </div>
            </div>
            <div class="meta">
              <span><i class="fa fa-calendar"></i> ${created}</span>
              ${tracking ? `<span><i class="fa fa-location-dot"></i> Tracking: ${tracking}</span>` : ''}
            </div>
            <div class="toolbar" style="margin-top:.3rem;gap:.35rem;flex-wrap:wrap;">
              ${tracking ? `<a class="btn outline btn-sm" href="/views/pages/tracking.html?tracking=${encodeURIComponent(tracking)}"><i class="fa fa-location-arrow"></i> Open tracking</a>`:''}
              ${payLink ? `<a class="btn outline btn-sm" href="${payLink}"><i class="fa fa-credit-card"></i> Pay now</a>`:''}
            </div>
          </article>
        `;
      }).join('');

      const latest = apps[0];
      const latestStage = mapAppStage(latest);
      const latestCreated = latest.created_at ? new Date(latest.created_at).toLocaleString() : '—';
      overviewActivity.innerHTML = `
        <div class="timeline">
          <div class="timeline-item">
            <strong>Latest application — ${latest.jobs?.title || 'Application'}</strong>
            <span>${latestCreated} · ${stageLabel(latestStage)}</span>
          </div>
        </div>
      `;

      renderCurrentJourney(apps);
    }

    async function loadApps() {
      if (!viewedUserId || !appsEl) return;
      try{
        const { data, error } = await sb
          .from('applications')
          .select(`
            id,
            user_id,
            job_id,
            status,
            plan,
            application_type,
            tracking_id,
            progress,
            details,
            created_at,
            jobs:job_id ( id, title, country, city )
          `)
          .eq('user_id', viewedUserId)
          .order('created_at', { ascending: false });
        if (error) throw error;
        const rows = data || [];
        renderApplications(rows);
      }catch(e){
        console.error(e);
        appsEl.innerHTML = '<div class="muted small-text">Failed to load applications.</div>';
      }
    }

    function formatAmount(amount,currency){
      const curr = (currency || 'GHS').toUpperCase();
      const val = (Number(amount)) || 0;
      return new Intl.NumberFormat(undefined,{ style:'currency', currency: curr }).format(val);
    }

    function renderPayments(list) {
      userPayments = list;
      const pending = list.filter(p=>p.status==='pending').length;
      statPendingPayments.textContent = pending;

      if (!list.length) {
        paysEl.innerHTML = '<p class="muted small-text">No payments on record yet for this user.</p>';
        return;
      }

      const html = list.map(p=>{
        const meta = p.metadata || {};
        const amountStr = formatAmount(p.amount,p.currency);
        const created = p.created_at ? new Date(p.created_at).toLocaleString() : '—';
        const statusClass = p.status==='success' ? 'success' : p.status==='failed' ? 'danger' : 'warning';
        const channelLabel =
          p.channel==='paystack' ? 'Paystack' :
          p.channel==='momo_auto' ? 'MoMo automatic' :
          p.channel==='momo_manual' ? 'MoMo manual' :
          p.channel || 'Payment';
        const title = meta.title || meta.description || 'Payment';

        const appLink = meta.tracking_id
          ? `<a href="/views/pages/tracking.html?tracking=${encodeURIComponent(meta.tracking_id)}" class="btn outline btn-sm"><i class="fa fa-location-arrow"></i> View tracking</a>`
          : '';

        return `
          <article class="pay-card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
              <div>
                <strong>${title}</strong>
                <div class="small-text">${channelLabel} · Ref: ${p.ref}</div>
              </div>
              <div style="text-align:right;">
                <div>${amountStr}</div>
                <span class="badge ${statusClass}">${p.status}</span>
              </div>
            </div>
            <div class="small-text">
              <span><i class="fa fa-calendar"></i> ${created}</span>
            </div>
            <div class="toolbar" style="margin-top:.25rem;">
              ${appLink}
            </div>
          </article>
        `;
      }).join('');

      paysEl.innerHTML = html;
    }

    async function loadPays() {
      if (!viewedUserId || !paysEl) return;
      try{
        const { data, error } = await sb
          .from('payments')
          .select('id,ref,status,amount,currency,channel,metadata,created_at,user_id')
          .eq('user_id', viewedUserId)
          .order('created_at', { ascending:false });
        if (error) throw error;
        const rows = data || [];
        renderPayments(rows);
      }catch(e){
        console.error(e);
        paysEl.innerHTML='<p class="muted small-text">Failed to load payments.</p>';
      }
    }

    function renderStars(rating) {
      const r = Number(rating) || 0;
      if (!r) return '';
      const full = '★'.repeat(r);
      const empty = '☆'.repeat(5 - r);
      return `<span style="color:#fbbf24;font-size:.85rem;">${full}${empty}</span>`;
    }

    function renderTestimonials(list) {
      userTests = list;
      if (!testsEl) return;

      if (!list.length) {
        testsEl.innerHTML='<p class="muted small-text">No testimonials yet for this user.</p>';
        return;
      }

      testsEl.innerHTML = list.map(t=>{
        const when = t.created_at ? new Date(t.created_at).toLocaleString() : '';
        const name = t.name || '';
        const rating = t.rating || null;

        return `
          <article class="test-card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:.5rem;">
              <div style='color:var(--brand);display:block;'>
                ${name ? `<strong>${name}</strong><br>` : ''}
                <div>${t.quote || ''}</div>
              </div>
              <div style="text-align:right;">
                ${rating ? renderStars(rating) : ''}
              </div>
            </div>
            <div class="small-text" style="margin-top:.25rem;">${when}</div>
          </article>
        `;
      }).join('');
    }

    async function loadTests() {
      if (!viewedUserId || !testsEl) return;
      try{
        const { data, error } = await sb
          .from('testimonials')
          .select('id,quote,name,rating,created_at,user_id')
          .eq('user_id', viewedUserId)
          .order('created_at', { ascending:false });
        if (error) throw error;
        renderTestimonials(data || []);
      }catch(e){
        console.error(e);
        testsEl.innerHTML='<p class="muted small-text">Failed to load testimonials.</p>';
      }
    }

    // Testimonials submit
    const tRatingSel = document.getElementById('tRating');
    const tTitleInput = document.getElementById('tTitle');
    const tTextArea = document.getElementById('tText');
    const tStatus = document.getElementById('tStatus');

    document.getElementById('tAdd')?.addEventListener('click', async () => {
  const txt = tTextArea.value.trim();
  const ratingVal = tRatingSel.value;
  const titleVal = tTitleInput.value.trim();

  if (!txt) {
    tStatus.textContent = 'Please enter testimonial text.';
    tStatus.className = 'muted small-text danger';
    return;
  }
  if (!ratingVal) {
    tStatus.textContent = 'Please select a rating.';
    tStatus.className = 'muted small-text danger';
    return;
  }
  if (isAdminViewingOther) {
    tStatus.textContent = 'You cannot post testimonials on behalf of another user here.';
    tStatus.className = 'muted small-text danger';
    return;
  }

  const rating = Number(ratingVal);

  try {
    // ✅ Get session user ID
    const { data: sessionData } = await sb.auth.getSession();
    const sessionUser = sessionData.session.user;

    // ✅ Fetch full profile from users table
    const { data: profile, error: profileErr } = await sb
      .from('users')
      .select('fullname, country, avatar_url')
      .eq('id', sessionUser.id)
      .maybeSingle();

    if (profileErr) throw profileErr;

    // ✅ Insert testimonial with synced profile fields
    const { error } = await sb.from('testimonials').insert({
      user_id: viewedUserId,
      name: profile.fullname || sessionUser.email,
      location: profile.country || null,
      avatar: profile.avatar_url || null,
      quote: txt,
      title: titleVal || null,
      rating: rating || null
    });

    if (error) throw error;

    tStatus.textContent = 'Testimonial submitted.';
    tStatus.className = 'muted small-text success';

    tTextArea.value = '';
    tTitleInput.value = '';
    tRatingSel.value = '';

    await loadTests();

  } catch (e) {
    console.error(e);
    tStatus.textContent = e.message || 'Failed to save testimonial.';
    tStatus.className = 'muted small-text danger';
  }
});

    // document.getElementById('tAdd')?.addEventListener('click', async () => {
    //   const txt = tTextArea.value.trim();
    //   const ratingVal = tRatingSel.value;
    //   const titleVal = tTitleInput.value.trim();

    //   if (!txt) {
    //     tStatus.textContent='Please enter testimonial text.';
    //     tStatus.className='muted small-text danger';
    //     return;
    //   }
    //   if (!ratingVal) {
    //     tStatus.textContent='Please select a rating.';
    //     tStatus.className='muted small-text danger';
    //     return;
    //   }
    //   if (isAdminViewingOther) {
    //     tStatus.textContent='You cannot post testimonials on behalf of another user here.';
    //     tStatus.className='muted small-text danger';
    //     return;
    //   }

    //   const rating = Number(ratingVal);
    //  const { data, error } = await sb.auth.getSession();
    //  const user = data.session.user
    //   try{
    //     const { error } = await sb.from('testimonials').insert({
    //       user_id: viewedUserId,
    //       name: user.fullname,
    //       location: user.country,
    //       avatar: user.avatar_url,
    //       quote: txt,
    //       title: titleVal || null,
    //       rating: rating || null
    //     });
    //     if (error) throw error;

    //     tStatus.textContent='Testimonial submitted.';
    //     tStatus.className='muted small-text success';
    //     tTextArea.value='';
    //     tTitleInput.value='';
    //     tRatingSel.value='';
    //     await loadTests();
    //   }catch(e){
    //     console.error(e);
    //     tStatus.textContent=e.message || 'Failed to save testimonial.';
    //     tStatus.className='muted small-text danger';
    //   }
    // });

    /* Tabs */
    document.querySelectorAll('.tab-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach((p) => p.classList.remove('active'));
        document.getElementById(`tab-${tab}`)?.classList.add('active');
      });
    });

    /* Modals & profile actions */
    function trapFocus(container) {
      const focusable = container.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      function handler(e) {
        if (e.key !== 'Tab') return;
        if (e.shiftKey) {
          if (document.activeElement === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
      container.addEventListener('keydown', handler);
      first && first.focus();
    }

    const btnEditProfile = editProfileBtn;
    const btnAbout = aboutBtn;

    btnEditProfile?.addEventListener('click', () => {
      if (isAdminViewingOther) {
        showToast('This editor only updates your own account. Use admin panel for other users.');
        return;
      }
      nameModal.style.display = 'flex';
      document.getElementById('newName').value = userProfile?.fullname || userProfile?.name || viewedUserEmail || '';
      trapFocus(nameModal);
    });
    btnAbout?.addEventListener('click', () => {
      aboutModal.style.display = 'flex';
      trapFocus(aboutModal);
    });
    editPasswordBtn?.addEventListener('click', () => {
      if (isAdminViewingOther) {
        showToast('You cannot change another user’s password here.');
        return;
      }
      passwordModal.style.display = 'flex';
      trapFocus(passwordModal);
    });
    editAvatarBtn?.addEventListener('click', () => {
      if (isAdminViewingOther) {
        showToast('You cannot change another user’s avatar here.');
        return;
      }
      avatarModal.style.display = 'flex';
      trapFocus(avatarModal);
    });
    editCoverBtn?.addEventListener('click', () => {
      if (isAdminViewingOther) {
        showToast('You cannot change another user’s cover here.');
        return;
      }
      coverModal.style.display = 'flex';
      trapFocus(coverModal);
    });

    document.getElementById('cancelName')?.addEventListener('click', () => {
      nameModal.style.display = 'none';
    });
    document.getElementById('cancelPassword')?.addEventListener('click', () => {
      passwordModal.style.display = 'none';
    });
    document.getElementById('cancelAvatar')?.addEventListener('click', () => {
      avatarModal.style.display = 'none';
    });
    document.getElementById('cancelCover')?.addEventListener('click', () => {
      coverModal.style.display = 'none';
    });
    document.getElementById('closeAbout')?.addEventListener('click', () => {
      aboutModal.style.display = 'none';
    });

    [nameModal, passwordModal, avatarModal, coverModal, aboutModal].forEach((mod) => {
      mod?.addEventListener('click', (e) => {
        if (e.target === mod) mod.style.display = 'none';
      });
    });

    document.getElementById('saveName')?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        setStatus('Name changes here affect only your own account.', 'danger');
        return;
      }
      const newName = document.getElementById('newName').value.trim();
      if (!newName) {
        setStatus('Enter a name', 'danger');
        return;
      }
      try{
        const { error } = await sb.from('users').update({ fullname: newName }).eq('id', sessionUser.id);
        if (error) throw error;
        setStatus('Name updated', 'success');
        nameModal.style.display = 'none';
        if (!isAdminViewingOther) {
          const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
          if (!uErr && data) {
            viewedUser = data;
          }
          await loadProfile();
        }
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update name', 'danger');
      }
    });

    document.getElementById('savePassword')?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        setStatus('You cannot change another user’s password here.', 'danger');
        return;
      }
      const newPass = document.getElementById('newPassword').value.trim();
      if (!newPass || newPass.length < 8) {
        setStatus('Enter a password of at least 8 characters', 'danger');
        return;
      }
      try{
        const { error } = await sb.auth.updateUser({ password: newPass });
        if (error) throw error;
        setStatus('Password updated', 'success');
        passwordModal.style.display = 'none';
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update password', 'danger');
      }
    });

    document.getElementById('saveAvatar')?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        setStatus('You cannot change another user’s avatar here.', 'danger');
        return;
      }
      const file = document.getElementById('newAvatar').files[0];
      if (!file) {
        setStatus('Please select an image', 'danger');
        return;
      }
      const fileName = `${sessionUser.id}-avatar-${Date.now()}.png`;
      try{
        const { error: uploadError } = await sb.storage.from('avatars').upload(fileName, file, {
          upsert: true
        });
        if (uploadError) throw uploadError;
        const { data: pub } = sb.storage.from('avatars').getPublicUrl(fileName);
        const url = pub.publicUrl;
        const { error } = await sb.from('users').update({ avatar_url: url }).eq('id', sessionUser.id);
        if (error) throw error;
        setStatus('Avatar updated', 'success');
        avatarModal.style.display = 'none';
        if (!isAdminViewingOther) {
          const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
          if (!uErr && data) {
            viewedUser = data;
          }
          await loadProfile();
        }
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update avatar', 'danger');
      }
    });

    document.getElementById('saveCover')?.addEventListener('click', async () => {
      if (isAdminViewingOther) {
        setStatus('You cannot change another user’s cover here.', 'danger');
        return;
      }
      const file = document.getElementById('newCover').files[0];
      if (!file) {
        setStatus('Please select an image', 'danger');
        return;
      }
      const fileName = `${sessionUser.id}-cover-${Date.now()}.png`;
      try{
        const { error: uploadError } = await sb.storage.from('covers').upload(fileName, file, {
          upsert: true
        });
        if (uploadError) throw uploadError;
        const { data: pub } = sb.storage.from('covers').getPublicUrl(fileName);
        const url = pub.publicUrl;
        const { error } = await sb.from('users').update({ cover: url }).eq('id', sessionUser.id);
        if (error) throw error;
        setStatus('Cover photo updated', 'success');
        coverModal.style.display = 'none';
        if (!isAdminViewingOther) {
          const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
          if (!uErr && data) {
            viewedUser = data;
          }
          await loadProfile();
        }
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update cover', 'danger');
      }
    });

    profileForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isAdminViewingOther) {
        setStatus('Profile edits here apply only to your own account.', 'danger');
        return;
      }
      if (!sessionUser?.id) {
        setStatus('Please log in first', 'danger');
        return;
      }
      const fullname = inputFullname.value.trim() || null;
      const phone = inputPhone.value.trim() || null;
      const country = inputCountry.value.trim() || null;

      try{
        setStatus('Saving profile...', 'muted');
        const { error } = await sb
          .from('users')
          .update({ fullname, phone, country })
          .eq('id', sessionUser.id);
        if (error) throw error;
        setStatus('Profile updated', 'success');
        if (!isAdminViewingOther) {
          const { data, error: uErr } = await sb.from('users').select('*').eq('id', sessionUser.id).maybeSingle();
          if (!uErr && data) {
            viewedUser = data;
          }
          await loadProfile();
        }
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Failed to update profile', 'danger');
      }
    });

    quickTrackBtn?.addEventListener('click', () => {
      const t = quickTrackInput.value.trim();
      if (!t) {
        showToast('Enter a tracking ID first.');
        return;
      }
      window.location.href = `/views/pages/tracking.html?tracking=${encodeURIComponent(t)}`;
    });

    quickTrackInput?.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        quickTrackBtn?.click();
      }
    });

    function mapApptStatus(s) {
      const status = (s || '').toLowerCase();
      if (!status) return { label:'Pending', cls:'warning' };
      if (status === 'confirmed') return { label:'Confirmed', cls:'success' };
      if (status === 'cancelled') return { label:'Cancelled', cls:'danger' };
      if (status === 'completed') return { label:'Completed', cls:'success' };
      return { label: status.charAt(0).toUpperCase() + status.slice(1), cls:'warning' };
    }

    function renderAppointments(list) {
      userAppts = list;

      if (!apptsList) return;
      if (!list.length) {
        apptsList.innerHTML =
          '<p class="muted small-text">No appointments on record yet for this user.</p>';
        if (apptsSummary) apptsSummary.textContent = '';
        return;
      }

      const upcoming = list.filter(a => a.status !== 'completed' && a.status !== 'cancelled').length;
      const completed = list.filter(a => a.status === 'completed').length;
      if (apptsSummary) {
        apptsSummary.textContent = `${list.length} total · ${upcoming} active · ${completed} completed`;
      }

      apptsList.innerHTML = list.map(a => {
        const whenDate = a.date ? new Date(a.date).toLocaleDateString() : '—';
        const whenTime = a.time ? new Date(a.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
        const labelWhen = whenTime ? `${whenDate} · ${whenTime}` : whenDate;

        const st = mapApptStatus(a.status);
        const service = a.service || a.type || 'Appointment';
        const location = a.location || a.city || a.country || '';

        const detailsHref = `/views/pages/appointment-details.html?appointment_id=${encodeURIComponent(a.id)}`;

        return `
          <article class="app-card" data-appt-id="${a.id}">
            <div class="top">
              <div>
                <strong>${service}</strong>
                <div class="meta">
                  <span><i class="fa fa-calendar"></i> ${labelWhen}</span>
                  ${location ? `<span><i class="fa fa-location-dot"></i> ${location}</span>` : ''}
                </div>
              </div>
              <div>
                <span class="badge ${st.cls}">${st.label}</span>
              </div>
            </div>
            <div class="meta">
              ${a.service ? `<span><i class="fa fa-hashtag"></i> Ref: ${a.service}</span>` : ''}
              ${a.channel ? `<span><i class="fa fa-credit-card"></i> ${a.channel}</span>` : ''}
            </div>
            <div class="toolbar" style="margin-top:.3rem;gap:.35rem;flex-wrap:wrap;">
              <button class="btn outline btn-sm" data-action="view-appt">
                <i class="fa fa-eye"></i> View details
              </button>
              <a href="${detailsHref}" class="btn outline btn-sm">
                <i class="fa fa-up-right-from-square"></i> Open full page
              </a>
            </div>
          </article>
        `;
      }).join('');
    }

    async function loadAppointments() {
      if (!viewedUserId || !apptsList) return;
      apptsList.innerHTML = '<p class="muted small-text">Loading appointments...</p>';
      try {
        const { data, error } = await sb
          .from('appointments')
          .select(`
            id,
            user_id,
            status,
            type,
            service,
            date,
            time,
            location,
            channel,
            notes,
            created_at
          `)
          .eq('user_id', viewedUserId)
          .order('date', { ascending:false })
          .order('created_at', { ascending:false });
        if (error) throw error;
        renderAppointments(data || []);
      } catch (e) {
        console.error(e);
        apptsList.innerHTML = '<p class="muted small-text">Failed to load appointments.</p>';
      }
    }

    function openApptModal(appt) {
      if (!apptModal) return;
      const service = appt.service || appt.type || 'Appointment';
      const whenDate = appt.date ? new Date(appt.date).toLocaleDateString() : '—';
      const whenTime = appt.time ? new Date(appt.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
      const st = mapApptStatus(appt.status);

      apptModalTitle.textContent = service;
      apptModalSubtitle.textContent = `${whenDate}${whenTime ? ' · ' + whenTime : ''} · ${st.label}`;
      apptModalContent.innerHTML = `
        <ul class="list-simple">
          <li><span>Status</span><span class="badge ${st.cls}">${st.label}</span></li>
          ${appt.service ? `<li><span>Service</span><span class="muted">${appt.service}</span></li>` : ''}
          ${appt.channel ? `<li><span>Channel</span><span class="muted">${appt.channel}</span></li>` : ''}
          ${appt.location ? `<li><span>Location</span><span class="muted">${appt.location}</span></li>` : ''}
          ${appt.created_at ? `<li><span>Created</span><span class="muted">${new Date(appt.created_at).toLocaleString()}</span></li>` : ''}
        </ul>
        ${appt.notes ? `<p class="muted small-text" style="margin-top:.5rem;">${appt.notes}</p>` : ''}
      `;

      if (apptDetailsLink) {
        apptDetailsLink.href = `/views/pages/appointment-details.html?appointment_id=${encodeURIComponent(appt.id)}`;
      }

      apptModal.style.display = 'flex';
      trapFocus(apptModal);
    }

    function closeApptModal() {
      if (apptModal) apptModal.style.display = 'none';
    }

    apptModalClose?.addEventListener('click', closeApptModal);
    apptModal?.addEventListener('click',(e)=>{
      if (e.target === apptModal) closeApptModal();
    });

    apptsList?.addEventListener('click',(e)=>{
      const btn = e.target.closest('[data-action="view-appt"]');
      if (!btn) return;
      const card = btn.closest('[data-appt-id]');
      if (!card) return;
      const id = card.getAttribute('data-appt-id');
      const appt = userAppts.find(a => String(a.id) === String(id));
      if (!appt) return;
      openApptModal(appt);
    });

    refreshApptsBtn?.addEventListener('click', loadAppointments);

    async function toggleFollowElite() {
      if (!sessionUser?.id) {
        showToast('Log in to follow Elite updates.');
        return;
      }

      try{
        const { error } = await sb.from('followers').insert({
          follower_id: sessionUser.id,
          target_type: 'brand',
          target_id: 'd9dfb9cd-2f74-4541-9cc8-8fc5fbc62257',
          meta: { source: 'profile_follow_button' }
        });
        if (error && !/duplicate|unique/i.test(error.message)) {
          followStatus.textContent = error.message;
          followStatus.className = 'muted small-text danger';
          return;
        }

        followStatus.textContent = 'You are following Elite updates. We will send you new jobs and important changes.';
        followStatus.className = 'muted small-text success';
        showToast('You are now following Elite updates.');
      }catch(e){
        console.error(e);
        followStatus.textContent = e.message || 'Failed to follow Elite updates.';
        followStatus.className = 'muted small-text danger';
      }
    }

    followEliteBtn?.addEventListener('click', toggleFollowElite);
    followBtn?.addEventListener('click', toggleFollowElite);

    // markAllReadBtn?.addEventListener('click', async ()=>{
    //   if (!viewedUserId) return;
    //   await markAllNotificationsRead(viewedUserId);
    // });

    // clearAllNotifBtn?.addEventListener('click', async ()=>{
    //   if (!viewedUserId) return;
    //   if (!confirm('Clear all notifications for this account?')) return;
    //   await clearAllNotifications(viewedUserId);
    // });

    document.getElementById('refreshAppsBtn')?.addEventListener('click', loadApps);
    document.getElementById('refreshPaysBtn')?.addEventListener('click', loadPays);
    document.getElementById('refreshTestsBtn')?.addEventListener('click', loadTests);

    // Nav auth actions
    loginBtn?.addEventListener('click', ()=> window.location.href='/views/pages/login.html');
    mobileLoginBtn?.addEventListener('click', ()=> window.location.href='/views/pages/login.html');

    logoutBtn?.addEventListener('click', async ()=>{
      await sb.auth.signOut();
      setAuthPills(null);
      window.location.href='/views/pages/login.html';
    });
    mobileLogoutBtn?.addEventListener('click', async ()=>{
      await sb.auth.signOut();
      setAuthPills(null);
      window.location.href='/views/pages/login.html';
    });

    profileBtn?.addEventListener('click', ()=> window.location.href='/views/pages/profile.html');
    mobileProfileBtn?.addEventListener('click', ()=> window.location.href='/views/pages/profile.html');

    // Mobile menu
    menuToggle?.addEventListener('click', ()=>{
      const isOpen = mobilePanel.classList.toggle('open');
      menuToggle.setAttribute('aria-expanded', String(isOpen));
    });
    mobilePanel?.addEventListener('click',(e)=>{
      if(e.target.matches('a')){
        mobilePanel.classList.remove('open');
        menuToggle.setAttribute('aria-expanded','false');
      }
    });

    (async ()=>{
      const ok = await fetchSessionAndRole();
      if (!ok) return;

      const viewedOk = await resolveViewedUser();
      if (!viewedOk) return;

      // await loadInitialNotifications(viewedUserId);
      // await subscribeNotifications(viewedUserId);

      await loadProfile();
      await loadPays();
      await loadApps();
      await loadTests();
      await loadAppointments();
    })();
  </script>
</body>
</html>
